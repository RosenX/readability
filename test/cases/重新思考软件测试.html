<html lang="zh" data-ios="true" class="itcauecng" data-theme="light" data-rh="data-theme"><head><meta charset="utf-8"><title>重新思考软件测试 - 知乎</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0,viewport-fit=cover"><meta name="renderer" content="webkit"><meta name="force-rendering" content="webkit"><meta http-equiv="X-UA-Compatible" content="IE=10,chrome=1"><meta name="google-site-verification" content="FTeR0c8arOPKh8c5DYh_9uu98_zJbaWw53J-Sch9MTg"><meta data-rh="true" name="keywords" content="软件工程,软件测试"><meta data-rh="true" name="description" content="虽然之前也写了快二十年代码了，对于很多现代软件工程的 buzz word 如敏捷，持续集成，DevOps 等都耳熟能详。但这两年在项目上碰到的各种挑战，以及跟一些开发者同僚交流下来发现，其实软件工程的很多最佳实践并没…"><meta data-rh="true" property="og:title" content="重新思考软件测试"><meta data-rh="true" property="og:url" content="https://zhuanlan.zhihu.com/p/591751476"><meta data-rh="true" property="og:description" content="虽然之前也写了快二十年代码了，对于很多现代软件工程的 buzz word 如敏捷，持续集成，DevOps 等都耳熟能详。但这两年在项目上碰到的各种挑战，以及跟一些开发者同僚交流下来发现，其实软件工程的很多最佳实践并没…"><meta data-rh="true" property="og:image" content="https://pic1.zhimg.com/v2-8bb94a3857a9a2891b9707b92f7ad76a_720w.jpg?source=172ae18b"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="og:site_name" content="知乎专栏"><link data-rh="true" rel="apple-touch-icon" href="https://static.zhihu.com/heifetz/assets/apple-touch-icon-152.81060cab.png"><link data-rh="true" rel="apple-touch-icon" href="https://static.zhihu.com/heifetz/assets/apple-touch-icon-152.81060cab.png" sizes="152x152"><link data-rh="true" rel="apple-touch-icon" href="https://static.zhihu.com/heifetz/assets/apple-touch-icon-120.d5793cac.png" sizes="120x120"><link data-rh="true" rel="apple-touch-icon" href="https://static.zhihu.com/heifetz/assets/apple-touch-icon-76.7abf3393.png" sizes="76x76"><link data-rh="true" rel="apple-touch-icon" href="https://static.zhihu.com/heifetz/assets/apple-touch-icon-60.362a8eac.png" sizes="60x60"><link crossorigin="" rel="shortcut icon" type="image/x-icon" href="https://static.zhihu.com/heifetz/favicon.ico"><link crossorigin="" rel="search" type="application/opensearchdescription+xml" href="https://static.zhihu.com/heifetz/search.xml" title="知乎"><link rel="dns-prefetch" href="//static.zhimg.com"><link rel="dns-prefetch" href="//pica.zhimg.com"><link rel="dns-prefetch" href="//picx.zhimg.com"><link rel="dns-prefetch" href="//pic1.zhimg.com"><link rel="dns-prefetch" href="//pic2.zhimg.com"><link rel="dns-prefetch" href="//pic3.zhimg.com"><link rel="dns-prefetch" href="//pic4.zhimg.com"><link rel="dns-prefetch" href="//static.zhihu.com"><script nonce="cab3f1a0-d8a4-4fe5-a542-dcac1e6d86ea" data-web-reporter-config="{&quot;platform&quot;:&quot;web&quot;,&quot;project&quot;:&quot;heifetz&quot;}">!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e=e||self).webReporter={})}(this,function(e){"use strict";var t={},n=!1,o=function(){var e,o,r,a,i;return n||(e=document.querySelector("script[data-web-reporter-config]"),o=e&&e.dataset.webReporterConfig||"{}",r=JSON.parse(o),a=r.platform,i=r.project,t={platform:a,project:i},n=!0),t};function r(e){return a(function(){return localStorage.getItem(e)})()}function a(e){return function(){try{return e.apply(void 0,arguments)}catch(e){}}}var i=a(function(e,t){var n={platform:"web",project:o().project,clientTimestamp:+new Date};!function(e,t,n){"1"===r("weber:logenabled")&&console.log("[web-reporter]%o",{type:e,base:t,data:n})}(e,n,t),function(e,t){var n=btoa(JSON.stringify(t));if("undefined"!=typeof Blob&&window.navigator&&window.navigator.sendBeacon){var o=new Blob([n],{type:"text/plain"});navigator.sendBeacon(e,o)}else{var r=new XMLHttpRequest;r.open("POST",e),r.withCredentials=!1,r.setRequestHeader("Content-Type","text/plain;charset=UTF-8"),r.send(n)}}(r("weber:api")||"https://apm.zhihu.com/collector/web_json",{type:e,base:n,data:t})});e.report=i,Object.defineProperty(e,"__esModule",{value:!0})});
</script><link href="https://static.zhihu.com/heifetz/680.216a26f4.bc3dd4670546193a4781.css" crossorigin="" rel="stylesheet"><link href="https://static.zhihu.com/heifetz/column.216a26f4.3326da597f7431c1ea67.css" crossorigin="" rel="stylesheet"><link rel="stylesheet" type="text/css" href="https://static.zhihu.com/heifetz/GoodsRecommendGoodsCardList.216a26f4.d95ce79191cdf8d7ac28.css" crossorigin="anonymous"><link rel="stylesheet" type="text/css" href="https://static.zhihu.com/heifetz/3280.216a26f4.8bfc371d6d7cfdc6aeec.css" crossorigin="anonymous"><script nonce="cab3f1a0-d8a4-4fe5-a542-dcac1e6d86ea">!function(){"use strict";!function(e,n){var r=[];function t(e){return function(){r.push([e,arguments])}}n.Raven={captureException:t("captureException"),captureMessage:t("captureMessage"),captureBreadcrumb:t("captureBreadcrumb")};var a,o,c,i,s,u="undefined"!=typeof DOMError;function d(e){var n=e instanceof Error||e instanceof ErrorEvent||u&&e instanceof DOMError||e instanceof DOMException;Raven.captureException(n?e:new Error(e.message||e.reason))}n.addEventListener("unhandledrejection",d),n.addEventListener("error",d,!0),a=e.src,o=e,c=function(){r.forEach(function(e){var n;(n=Raven)[e[0]].apply(n,e[1])}),n.removeEventListener("unhandledrejection",d),n.removeEventListener("error",d,!0)},i=document.head||document.getElementsByTagName("head")[0],(s=document.createElement("script")).crossOrigin=o.crossOrigin,s.dataset.sentryConfig=o["data-sentry-config"],s.onload=c,s.src=a,i.appendChild(s)}({"defer":true,"crossOrigin":"anonymous","src":"https://unpkg.zhimg.com/@cfe/sentry-script@1.3.1/dist/init.js","data-sentry-config":"{\"dsn\":\"https://2d8d764432cc4f6fb3bc78ab9528299d@crash2.zhihu.com/1224\",\"sampleRate\":0.1,\"release\":\"824-bcf32e16\",\"ignoreErrorNames\":[\"NetworkError\",\"SecurityError\"],\"ignoreErrorsPreset\":\"ReactApp\",\"tags\":{\"app_name\":\"heifetz\"}}"},window)}();
</script><script crossorigin="anonymous" data-sentry-config="{&quot;dsn&quot;:&quot;https://2d8d764432cc4f6fb3bc78ab9528299d@crash2.zhihu.com/1224&quot;,&quot;sampleRate&quot;:0.1,&quot;release&quot;:&quot;824-bcf32e16&quot;,&quot;ignoreErrorNames&quot;:[&quot;NetworkError&quot;,&quot;SecurityError&quot;],&quot;ignoreErrorsPreset&quot;:&quot;ReactApp&quot;,&quot;tags&quot;:{&quot;app_name&quot;:&quot;heifetz&quot;}}" src="https://unpkg.zhimg.com/@cfe/sentry-script@1.3.1/dist/init.js"></script><style data-emotion-css="uzm3ri">.css-uzm3ri{position:fixed;top:0;right:0;left:0;z-index:101;display:none;height:2px;pointer-events:none;background:#056DE8;-webkit-transform:translateX(-100%);-ms-transform:translateX(-100%);transform:translateX(-100%);}</style><style data-emotion-css="15ro776">.css-15ro776{margin-right:4px;}</style><style data-emotion-css="183aq3r">.css-183aq3r{border-radius:24px;padding:0 15px;font-size:13px;line-height:28px;-webkit-flex:none;-ms-flex:none;flex:none;}</style><style data-emotion-css="1ie3c6f">.css-1ie3c6f{fill:#999999;margin:0 10px;}</style><style data-emotion-css="78p1r9">.css-78p1r9{box-sizing:border-box;margin:0;min-width:0;margin-left:auto;margin-right:auto;max-width:690px;margin-top:0;}@media screen and (min-width:40em){.css-78p1r9{margin-top:1em;}}</style><style data-emotion-css="1rlkvo9">.css-1rlkvo9{position:relative;padding-bottom:47.5%;height:0;border-radius:inherit;}</style><style data-emotion-css="1ghsn9">.css-1ghsn9{box-sizing:border-box;margin:0;min-width:0;position:relative;padding-bottom:47.5%;height:0;border-radius:inherit;}</style><style data-emotion-css="1ld0bim">.css-1ld0bim{position:absolute;top:0;left:0;width:100%;height:100%;border-radius:inherit;}</style><style data-emotion-css="1ujtx97">.css-1ujtx97{object-fit:cover;background-color:#F6F6F6;}</style><style data-emotion-css="uodor8">.css-uodor8{border-radius:50%;}</style><style data-emotion-css="kl6aur">.css-kl6aur{box-sizing:border-box;margin:0;min-width:0;max-width:100%;height:auto;background-color:#FFFFFF;width:34px;height:34px;border-radius:50%;}</style><style data-emotion-css="1cd9gw4">.css-1cd9gw4{margin-left:.3em;}</style><style data-emotion-css="1yuhvjn">.css-1yuhvjn{margin-top:16px;}</style><style data-emotion-css="376mun">.css-376mun{position:relative;display:inline;}</style><style data-emotion-css="1hhle02">.css-1hhle02 .FileLinkCard{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;background-color:rgba(246,246,246,0.88);border-radius:12px;box-sizing:border-box;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;margin:1em auto;max-width:100%;overflow:hidden;padding:12px;position:relative;width:390px;}.css-1hhle02 .FileLinkCard-icon{-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;height:30px;width:30px;}.css-1hhle02 .FileLinkCard-info{margin-left:12px;}.css-1hhle02 .FileLinkCard-name{color:#121212;font-size:15px;font-weight:500;line-height:21px;display:-webkit-box;text-overflow:ellipsis;overflow:hidden;-webkit-box-orient:vertical;-webkit-line-clamp:2;}.css-1hhle02 .FileLinkCard-meta{color:#999999;font-size:12px;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;line-height:14px;margin-top:5px;}.css-1hhle02 .FileLinkCard-source{white-space:pre;}.css-1hhle02 img[data-uncomfortable]{content:url(data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20344.88888888888886%20194%22%3E%3CforeignObject%20width%3D%22344.88888888888886%22%20height%3D%22194%22%3E%0A%20%20%20%20%20%20%3Cdiv%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F1999%2Fxhtml%22%20style%3D%22font-size%3A%2013px%3B%20font-family%3A%20-apple-system%2C%20BlinkMacSystemFont%2C%20Microsoft%20YaHei%2C%20sans-serif%3B%20color%3A%20%23fff%3B%20width%3A100%25%3B%20height%3A194px%3B%22%3E%0A%20%20%20%20%20%20%20%20%3Cdiv%20style%3D%22display%3A%20flex%3B%20flex-direction%3A%20column%3B%20align-items%3A%20center%3B%20justify-content%3A%20center%3B%20height%3A%20100%25%3B%22%3E%0A%20%20%20%20%20%20%20%20%20%20%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2218%22%20height%3D%2218%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22currentColor%22%3E%3Cpath%20d%3D%22M8%203.65a7%207%200%2000-1.353.128.65.65%200%2011-.25-1.275A8.3%208.3%200%20018%202.35c2.387%200%204.172.954%205.357%202.125C14.511%205.615%2015.15%207.022%2015.15%208c0%20.621-.257%201.391-.699%202.134a7.076%207.076%200%2001-1.403%201.68l.495.46a.65.65%200%2011-.886.951l-.998-.929a.645.645%200%2001-.104-.097L9.73%2010.501a.647.647%200%2001-.29.301%203.15%203.15%200%2001-4.313-4.094.647.647%200%2001.234-.275L3.908%205.08a5.774%205.774%200%2000-1.283%201.522C2.282%207.198%202.15%207.707%202.15%208c0%20.522.41%201.616%201.407%202.6.965.954%202.43%201.75%204.443%201.75.468%200%20.905-.043%201.311-.12a.65.65%200%2001.243%201.277A8.322%208.322%200%20018%2013.65c-2.387%200-4.172-.954-5.357-2.125C1.49%2010.385.85%208.978.85%208c0-.598.238-1.333.648-2.046A7.054%207.054%200%20012.95%204.188l-.547-.509a.65.65%200%2011.886-.951l8.8%208.194a5.793%205.793%200%20001.244-1.453c.372-.624.516-1.163.516-1.469%200-.522-.41-1.616-1.407-2.6-.965-.954-2.43-1.75-4.443-1.75zM6.29%207.296a1.85%201.85%200%20002.534%202.36l-2.535-2.36zM8%204.85a.65.65%200%20100%201.3%201.85%201.85%200%20011.843%201.694.65.65%200%20101.296-.11A3.15%203.15%200%20008%204.85z%22%20fill-rule%3D%22evenodd%22%20clip-rule%3D%22evenodd%22%3E%3C%2Fpath%3E%3C%2Fsvg%3E%0A%20%20%20%20%20%20%20%20%20%20%3Cdiv%20style%3D%22margin%3A%20.6em%200%201.2em%22%3E%E8%AF%A5%E5%9B%BE%E7%89%87%E6%9C%89%E5%8F%AF%E8%83%BD%E4%BC%9A%E5%BC%95%E8%B5%B7%E4%B8%8D%E9%80%82%3C%2Fdiv%3E%0A%20%20%20%20%20%20%20%20%20%20%3Cbutton%20style%3D%22padding%3A%204px%201em%3B%20font-size%3A%201.1em%3B%20color%3A%20inherit%3B%20background%3A%20none%3B%20border%3A%201px%20solid%20rgba%28255%2C255%2C255%2C.5%29%3B%20border-radius%3A%209999px%3B%22%3E%E7%BB%A7%E7%BB%AD%E6%9F%A5%E7%9C%8B%3C%2Fbutton%3E%0A%20%20%20%20%20%20%20%20%3C%2Fdiv%3E%0A%20%20%20%20%20%20%3C%2Fdiv%3E%0A%20%20%20%20%3C%2FforeignObject%3E%3C%2Fsvg%3E);width:100%;height:194px;background:url(https://pic1.zhimg.com/v2-cf70d0759d787c70091857151c1cad4a.jpeg) no-repeat rgba(191,191,191,0.7);background-size:cover;cursor:pointer!important;}</style><style data-emotion-css="1r0wf39">.css-1r0wf39 .LinkCard.new{position:relative;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;box-sizing:border-box;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;width:390px;min-height:84px;border-radius:8px;max-width:100%;overflow:hidden;margin:16px auto;padding:12px 12px 9px 12px;background-color:#F6F6F6;}.css-1r0wf39 .LinkCard.new,.css-1r0wf39 .LinkCard.new:hover{-webkit-text-decoration:none;text-decoration:none;border:none !important;color:inherit !important;}.css-1r0wf39 .LinkCard.new .LinkCard-contents{display:block;-webkit-flex:1 1 auto;-ms-flex:1 1 auto;flex:1 1 auto;position:relative;}.css-1r0wf39 .LinkCard.new .LinkCard-contents .loading{height:14px;background:#EBEBEB;border-radius:7px;}.css-1r0wf39 .LinkCard.new .LinkCard-contents.withTitle{margin-bottom:3px;}.css-1r0wf39 .LinkCard.new .LinkCard-title{display:-webkit-box;font-size:15px;font-weight:500;line-height:1.4;margin-bottom:2px;color:#121212;text-overflow:ellipsis;overflow:hidden;-webkit-box-orient:vertical;-webkit-line-clamp:1;}.css-1r0wf39 .LinkCard.new .LinkCard-title.two-line{line-height:20px;display:-webkit-box;text-overflow:ellipsis;overflow:hidden;-webkit-box-orient:vertical;-webkit-line-clamp:2;}.css-1r0wf39 .LinkCard.new .LinkCard-title.loading{margin-bottom:8px;width:80%;}.css-1r0wf39 .LinkCard.new .LinkCard-title.loading.withTitle{margin-bottom:6px;}.css-1r0wf39 .LinkCard.new .LinkCard-title.loadingTitle{margin-bottom:5px;}.css-1r0wf39 .LinkCard.new .LinkCard-excerpt{display:-webkit-box;text-overflow:ellipsis;font-size:13px;line-height:18px;color:#999999;margin-bottom:4px;overflow:hidden;-webkit-box-orient:vertical;-webkit-line-clamp:1;}.css-1r0wf39 .LinkCard.new .LinkCard-excerpt .LinkCard-author{color:#444444;}.css-1r0wf39 .LinkCard.new .LinkCard-desc{display:-webkit-box;font-size:13px;height:18px;line-height:18px;color:#999999;word-break:break-all;text-overflow:ellipsis;overflow:hidden;-webkit-box-orient:vertical;-webkit-line-clamp:1;}.css-1r0wf39 .LinkCard.new .LinkCard-desc .LinkCard-tag,.css-1r0wf39 .LinkCard.new .LinkCard-desc .tag{display:inline-block;font-size:11px;margin-left:8px;padding:0 4px;border-radius:3px;background:rgba(211,211,211,0.3);}.css-1r0wf39 .LinkCard.new .LinkCard-desc.loading{width:40%;}.css-1r0wf39 .LinkCard.new .LinkCard-desc svg{margin-right:2px;}.css-1r0wf39 .LinkCard.new .LinkCard-image{-webkit-flex:0 0 auto;-ms-flex:0 0 auto;flex:0 0 auto;background-color:#EBEBEB;background-size:cover;background-position:center;position:relative;display:block;width:60px;height:60px;margin-left:20px;object-fit:cover;border-radius:inherit;overflow:hidden;}.css-1r0wf39 .LinkCard.new .LinkCard-image.LinkCard-image--default{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;background-color:#EBEBEB;color:#D3D3D3;}.css-1r0wf39 .LinkCard.new .LinkCard-image.LinkCard-image--default svg{color:#999999;}.css-1r0wf39 .LinkCard.new .LinkCard-image img{width:100%;height:100%;object-fit:cover;}.css-1r0wf39 .LinkCard.new .LinkCard-image .LinkCard-image--video{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;position:absolute;top:50%;left:50%;-webkit-transform:translateX(-50%) translateY(-50%);-ms-transform:translateX(-50%) translateY(-50%);transform:translateX(-50%) translateY(-50%);width:24px;height:24px;border-radius:12px;background:rgba(255,255,255,0.9);pointer-events:none;}.css-1r0wf39 .LinkCard.new .LinkCard-image .LinkCard-image--video svg{color:#444444;}.css-1r0wf39 .LinkCard.new .LinkCard-richText .text{color:#444444;}.css-1r0wf39 .LinkCard.new .LinkCard-richText .bold{font-weight:500;}.css-1r0wf39 .LinkCard.new .LinkCard-richText .tag{margin-left:4px;}.css-1r0wf39 .LinkCard.old{position:relative;display:block;margin:1em auto;width:390px;box-sizing:border-box;border-radius:12px;max-width:100%;overflow:hidden;}.css-1r0wf39 .LinkCard.old,.css-1r0wf39 .LinkCard.old:hover{-webkit-text-decoration:none;text-decoration:none;border:none !important;color:inherit !important;}.css-1r0wf39 .LinkCard-ecommerceLoadingCard{position:relative;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;padding:12px;border-radius:inherit;height:80px;box-sizing:border-box;background:rgba(246,246,246,0.88);color:#D3D3D3;}.css-1r0wf39 .LinkCard-ecommerceLoadingCardAvatarWrapper{width:60px;height:60px;background:#EBEBEB;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;border-radius:6px;margin-right:10px;}.css-1r0wf39 .LinkCard-ecommerceLoadingCardNetwork{width:20px;height:20px;}.css-1r0wf39 .LinkCard-ecommerceLoadingCardLoadingbar{height:60px;-webkit-flex:1;-ms-flex:1;flex:1;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;}.css-1r0wf39 .LinkCard-ecommerceLoadingCardLoadingbar span{height:16px;display:inline-block;background:#EBEBEB;}.css-1r0wf39 .LinkCard-ecommerceLoadingCardLoadingbar span:nth-of-type(1){width:60px;margin-bottom:4px;}.css-1r0wf39 .LinkCard-ecommerceLoadingCardLoadingbar span:nth-of-type(2){width:127px;}</style><style data-emotion-css="3np2dk">.css-3np2dk .LinkCard.old{position:relative;display:block;margin:1em auto;width:390px;box-sizing:border-box;border-radius:12px;max-width:100%;overflow:hidden;}.css-3np2dk .LinkCard.old,.css-3np2dk .LinkCard.old:hover{-webkit-text-decoration:none;text-decoration:none;border:none !important;color:inherit !important;}.css-3np2dk .LinkCard-ecommerceLoadingCard{position:relative;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;padding:12px;border-radius:inherit;height:80px;box-sizing:border-box;background:rgba(246,246,246,0.88);color:#D3D3D3;}.css-3np2dk .LinkCard-ecommerceLoadingCardAvatarWrapper{width:60px;height:60px;background:#EBEBEB;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;border-radius:6px;margin-right:10px;}.css-3np2dk .LinkCard-ecommerceLoadingCardNetwork{width:20px;height:20px;}.css-3np2dk .LinkCard-ecommerceLoadingCardLoadingbar{height:60px;-webkit-flex:1;-ms-flex:1;flex:1;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;}.css-3np2dk .LinkCard-ecommerceLoadingCardLoadingbar span{height:16px;display:inline-block;background:#EBEBEB;}.css-3np2dk .LinkCard-ecommerceLoadingCardLoadingbar span:nth-of-type(1){width:60px;margin-bottom:4px;}.css-3np2dk .LinkCard-ecommerceLoadingCardLoadingbar span:nth-of-type(2){width:127px;}.css-3np2dk .LinkCard.new{position:relative;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;box-sizing:border-box;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;width:390px;min-height:84px;border-radius:8px;max-width:100%;overflow:hidden;margin:16px auto;padding:12px 12px 9px 12px;background-color:#F6F6F6;}.css-3np2dk .LinkCard.new,.css-3np2dk .LinkCard.new:hover{-webkit-text-decoration:none;text-decoration:none;border:none !important;color:inherit !important;}.css-3np2dk .LinkCard.new .LinkCard-contents{display:block;-webkit-flex:1 1 auto;-ms-flex:1 1 auto;flex:1 1 auto;position:relative;}.css-3np2dk .LinkCard.new .LinkCard-contents .loading{height:14px;background:#EBEBEB;border-radius:7px;}.css-3np2dk .LinkCard.new .LinkCard-contents.withTitle{margin-bottom:3px;}.css-3np2dk .LinkCard.new .LinkCard-title{display:-webkit-box;font-size:15px;font-weight:500;line-height:1.4;margin-bottom:2px;color:#121212;text-overflow:ellipsis;overflow:hidden;-webkit-box-orient:vertical;-webkit-line-clamp:1;}.css-3np2dk .LinkCard.new .LinkCard-title.two-line{line-height:20px;display:-webkit-box;text-overflow:ellipsis;overflow:hidden;-webkit-box-orient:vertical;-webkit-line-clamp:2;}.css-3np2dk .LinkCard.new .LinkCard-title.loading{margin-bottom:8px;width:80%;}.css-3np2dk .LinkCard.new .LinkCard-title.loading.withTitle{margin-bottom:6px;}.css-3np2dk .LinkCard.new .LinkCard-title.loadingTitle{margin-bottom:5px;}.css-3np2dk .LinkCard.new .LinkCard-excerpt{display:-webkit-box;text-overflow:ellipsis;font-size:13px;line-height:18px;color:#999999;margin-bottom:4px;overflow:hidden;-webkit-box-orient:vertical;-webkit-line-clamp:1;}.css-3np2dk .LinkCard.new .LinkCard-excerpt .LinkCard-author{color:#444444;}.css-3np2dk .LinkCard.new .LinkCard-desc{display:-webkit-box;font-size:13px;height:18px;line-height:18px;color:#999999;word-break:break-all;text-overflow:ellipsis;overflow:hidden;-webkit-box-orient:vertical;-webkit-line-clamp:1;}.css-3np2dk .LinkCard.new .LinkCard-desc .LinkCard-tag,.css-3np2dk .LinkCard.new .LinkCard-desc .tag{display:inline-block;font-size:11px;margin-left:8px;padding:0 4px;border-radius:3px;background:rgba(211,211,211,0.3);}.css-3np2dk .LinkCard.new .LinkCard-desc.loading{width:40%;}.css-3np2dk .LinkCard.new .LinkCard-desc svg{margin-right:2px;}.css-3np2dk .LinkCard.new .LinkCard-image{-webkit-flex:0 0 auto;-ms-flex:0 0 auto;flex:0 0 auto;background-color:#EBEBEB;background-size:cover;background-position:center;position:relative;display:block;width:60px;height:60px;margin-left:20px;object-fit:cover;border-radius:inherit;overflow:hidden;}.css-3np2dk .LinkCard.new .LinkCard-image.LinkCard-image--default{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;background-color:#EBEBEB;color:#D3D3D3;}.css-3np2dk .LinkCard.new .LinkCard-image.LinkCard-image--default svg{color:#999999;}.css-3np2dk .LinkCard.new .LinkCard-image img{width:100%;height:100%;object-fit:cover;}.css-3np2dk .LinkCard.new .LinkCard-image .LinkCard-image--video{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;position:absolute;top:50%;left:50%;-webkit-transform:translateX(-50%) translateY(-50%);-ms-transform:translateX(-50%) translateY(-50%);transform:translateX(-50%) translateY(-50%);width:24px;height:24px;border-radius:12px;background:rgba(255,255,255,0.9);pointer-events:none;}.css-3np2dk .LinkCard.new .LinkCard-image .LinkCard-image--video svg{color:#444444;}.css-3np2dk .LinkCard.new .LinkCard-richText .text{color:#444444;}.css-3np2dk .LinkCard.new .LinkCard-richText .bold{font-weight:500;}.css-3np2dk .LinkCard.new .LinkCard-richText .tag{margin-left:4px;}.css-3np2dk .FileLinkCard{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;background-color:rgba(246,246,246,0.88);border-radius:12px;box-sizing:border-box;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;margin:1em auto;max-width:100%;overflow:hidden;padding:12px;position:relative;width:390px;}.css-3np2dk .FileLinkCard-icon{-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;height:30px;width:30px;}.css-3np2dk .FileLinkCard-info{margin-left:12px;}.css-3np2dk .FileLinkCard-name{color:#121212;font-size:15px;font-weight:500;line-height:21px;display:-webkit-box;text-overflow:ellipsis;overflow:hidden;-webkit-box-orient:vertical;-webkit-line-clamp:2;}.css-3np2dk .FileLinkCard-meta{color:#999999;font-size:12px;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;line-height:14px;margin-top:5px;}.css-3np2dk .FileLinkCard-source{white-space:pre;}.css-3np2dk img[data-uncomfortable]{content:url(data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20344.88888888888886%20194%22%3E%3CforeignObject%20width%3D%22344.88888888888886%22%20height%3D%22194%22%3E%0A%20%20%20%20%20%20%3Cdiv%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F1999%2Fxhtml%22%20style%3D%22font-size%3A%2013px%3B%20font-family%3A%20-apple-system%2C%20BlinkMacSystemFont%2C%20Microsoft%20YaHei%2C%20sans-serif%3B%20color%3A%20%23fff%3B%20width%3A100%25%3B%20height%3A194px%3B%22%3E%0A%20%20%20%20%20%20%20%20%3Cdiv%20style%3D%22display%3A%20flex%3B%20flex-direction%3A%20column%3B%20align-items%3A%20center%3B%20justify-content%3A%20center%3B%20height%3A%20100%25%3B%22%3E%0A%20%20%20%20%20%20%20%20%20%20%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2218%22%20height%3D%2218%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22currentColor%22%3E%3Cpath%20d%3D%22M8%203.65a7%207%200%2000-1.353.128.65.65%200%2011-.25-1.275A8.3%208.3%200%20018%202.35c2.387%200%204.172.954%205.357%202.125C14.511%205.615%2015.15%207.022%2015.15%208c0%20.621-.257%201.391-.699%202.134a7.076%207.076%200%2001-1.403%201.68l.495.46a.65.65%200%2011-.886.951l-.998-.929a.645.645%200%2001-.104-.097L9.73%2010.501a.647.647%200%2001-.29.301%203.15%203.15%200%2001-4.313-4.094.647.647%200%2001.234-.275L3.908%205.08a5.774%205.774%200%2000-1.283%201.522C2.282%207.198%202.15%207.707%202.15%208c0%20.522.41%201.616%201.407%202.6.965.954%202.43%201.75%204.443%201.75.468%200%20.905-.043%201.311-.12a.65.65%200%2001.243%201.277A8.322%208.322%200%20018%2013.65c-2.387%200-4.172-.954-5.357-2.125C1.49%2010.385.85%208.978.85%208c0-.598.238-1.333.648-2.046A7.054%207.054%200%20012.95%204.188l-.547-.509a.65.65%200%2011.886-.951l8.8%208.194a5.793%205.793%200%20001.244-1.453c.372-.624.516-1.163.516-1.469%200-.522-.41-1.616-1.407-2.6-.965-.954-2.43-1.75-4.443-1.75zM6.29%207.296a1.85%201.85%200%20002.534%202.36l-2.535-2.36zM8%204.85a.65.65%200%20100%201.3%201.85%201.85%200%20011.843%201.694.65.65%200%20101.296-.11A3.15%203.15%200%20008%204.85z%22%20fill-rule%3D%22evenodd%22%20clip-rule%3D%22evenodd%22%3E%3C%2Fpath%3E%3C%2Fsvg%3E%0A%20%20%20%20%20%20%20%20%20%20%3Cdiv%20style%3D%22margin%3A%20.6em%200%201.2em%22%3E%E8%AF%A5%E5%9B%BE%E7%89%87%E6%9C%89%E5%8F%AF%E8%83%BD%E4%BC%9A%E5%BC%95%E8%B5%B7%E4%B8%8D%E9%80%82%3C%2Fdiv%3E%0A%20%20%20%20%20%20%20%20%20%20%3Cbutton%20style%3D%22padding%3A%204px%201em%3B%20font-size%3A%201.1em%3B%20color%3A%20inherit%3B%20background%3A%20none%3B%20border%3A%201px%20solid%20rgba%28255%2C255%2C255%2C.5%29%3B%20border-radius%3A%209999px%3B%22%3E%E7%BB%A7%E7%BB%AD%E6%9F%A5%E7%9C%8B%3C%2Fbutton%3E%0A%20%20%20%20%20%20%20%20%3C%2Fdiv%3E%0A%20%20%20%20%20%20%3C%2Fdiv%3E%0A%20%20%20%20%3C%2FforeignObject%3E%3C%2Fsvg%3E);width:100%;height:194px;background:url(https://pic1.zhimg.com/v2-cf70d0759d787c70091857151c1cad4a.jpeg) no-repeat rgba(191,191,191,0.7);background-size:cover;cursor:pointer!important;}</style><style data-emotion-css="1t538q animation-1yvu044">.css-1t538q{word-break:break-word;line-height:1.6;}.css-1t538q > [data-first-child]{margin-top:0;}.css-1t538q > :last-child{margin-bottom:0;}.css-1t538q h1,.css-1t538q h2{clear:left;margin-top:calc((1.4em * 2) / 1.2);margin-bottom:calc(1.4em / 1.2);font-size:1.2em;line-height:1.5;font-weight:500;}.css-1t538q h3,.css-1t538q h4,.css-1t538q h5,.css-1t538q h6{clear:left;margin-top:calc((1.4em * 1.5) / 1.1);margin-bottom:calc(1.4em / 1.1);font-size:1.1em;line-height:1.5;font-weight:500;}.css-1t538q u{-webkit-text-decoration:none;text-decoration:none;border-bottom:1px solid #444444;}.css-1t538q b{font-weight:500;}.css-1t538q sup{font-size:0.8em;}.css-1t538q sup[data-draft-type='reference']{color:#175199;}.css-1t538q a:focus{outline:none;-webkit-transition:box-shadow 0.3s;transition:box-shadow 0.3s;}html[data-focus-visible] .css-1t538q a:focus{box-shadow:0 0 0 2px #FFFFFF,0 0 0 4px rgba(5,109,232,0.3);}.css-1t538q a.ztext-link,.css-1t538q a.internal,.css-1t538q a.external{-webkit-text-decoration:none;text-decoration:none;cursor:pointer;border-bottom:1px solid #808080;}.css-1t538q a.ztext-link:hover,.css-1t538q a.internal:hover,.css-1t538q a.external:hover{color:#175199;border-bottom:1px solid #175199;}.css-1t538q a.ztext-link > .ellipsis::after,.css-1t538q a.internal > .ellipsis::after,.css-1t538q a.external > .ellipsis::after{content:'...';}.css-1t538q a.ztext-link > .invisible,.css-1t538q a.internal > .invisible,.css-1t538q a.external > .invisible{font:0/0 a;color:transparent;text-shadow:none;background-color:transparent;}.css-1t538q a.ztext-link u,.css-1t538q a.internal u,.css-1t538q a.external u{border:none;}.css-1t538q a.member_mention{color:#175199;}.css-1t538q a.member_mention:hover{border-bottom:1px solid #175199;}.css-1t538q a.UserLink-link{color:#175199;}.css-1t538q a.UserLink-link:hover{border-bottom:1px solid #175199;}.css-1t538q p{margin:1.4em 0;}.css-1t538q p.ztext-empty-paragraph{margin:calc((2.8em- (1.4em * 2 + 1.6em)) / 2) 0;}.css-1t538q p.ztext-empty-paragraph + .ztext-empty-paragraph{margin:1.4em 0;}.css-1t538q hr{margin:4em auto;width:240px;max-width:100%;border:none;border-top:1px solid #D3D3D3;}.css-1t538q img[eeimg]{max-width:100%;vertical-align:middle;}.css-1t538q img[eeimg="1"]{margin:0 3px;max-width:calc(100% - 6px);display:inline-block;}.css-1t538q img[eeimg="2"]{margin:1.4em auto;display:block;}.css-1t538q blockquote{margin:1.4em 0;padding-left:1em;color:#646464;border-left:3px solid #D3D3D3;}.css-1t538q ol,.css-1t538q ul{margin:1.4em 0;padding:0;width:100%;}.css-1t538q ol ol,.css-1t538q ul ol,.css-1t538q ol ul,.css-1t538q ul ul{margin:0;}.css-1t538q ol li::before,.css-1t538q ul li::before{width:1em;}.css-1t538q ol > ol,.css-1t538q ul > ol,.css-1t538q ol > ul,.css-1t538q ul > ul{display:table-row;}.css-1t538q ol > ol::before,.css-1t538q ul > ol::before,.css-1t538q ol > ul::before,.css-1t538q ul > ul::before{display:table-cell;content:'';}.css-1t538q ul{display:table;}.css-1t538q ul>li{display:table-row;list-style:none;}.css-1t538q ul>li::before{display:table-cell;content:'•  ';white-space:pre;}.css-1t538q ol{display:table;counter-reset:ol;}.css-1t538q ol > li{display:table-row;list-style:none;}.css-1t538q ol > li::before{display:table-cell;text-align:right;counter-increment:ol;content:counter(ol) '. ';white-space:pre;}.css-1t538q ol ol{counter-reset:ol2;}.css-1t538q ol ol li::before{counter-increment:ol2;content:counter(ol2) '. ';}.css-1t538q ol ol ol{counter-reset:ol3;}.css-1t538q ol ol ol li::before{counter-increment:ol3;content:counter(ol3) '. ';}.css-1t538q ol ol ol ol{counter-reset:ol4;}.css-1t538q ol ol ol ol li::before{counter-increment:ol4;content:counter(ol4) '. ';}.css-1t538q figure{margin:1.4em 0;}.css-1t538q figure .content_image,.css-1t538q figure .origin_image{margin:0 auto;}.css-1t538q figure figcaption{margin-top:calc(0.6em / 0.9);padding:0 1em;font-size:0.9em;line-height:1.5;text-align:center;color:#999999;}.css-1t538q figure + figure{margin-top:calc(1.4em * 1.6);}.css-1t538q figure[data-size='small'],.css-1t538q figure:not([data-size]) > [data-size='small']{clear:both;}.css-1t538q figure[data-size='left'],.css-1t538q figure:not([data-size]) > [data-size='left']{float:left;margin:0 20px 20px 0;max-width:33%;}.css-1t538q figure[data-size='right'],.css-1t538q figure:not([data-size]) > [data-size='right']{float:right;margin:0 0 20px 20px;max-width:33%;}.css-1t538q figure[data-size='collapse']{margin-bottom:0;}.css-1t538q figure[data-size='collapse'] + figure{margin-top:0;}.css-1t538q .content_image,.css-1t538q .origin_image{display:block;max-width:100%;height:auto;margin:1.4em auto;}.css-1t538q .content_image[data-size='small'],.css-1t538q .origin_image[data-size='small']{max-width:40%;}.css-1t538q .content_image.zh-lightbox-thumb,.css-1t538q .origin_image.zh-lightbox-thumb{cursor:-webkit-zoom-in;cursor:-moz-zoom-in;cursor:zoom-in;}.css-1t538q code{margin:0 2px;padding:3px 4px;border-radius:3px;font-family:Menlo,Monaco,Consolas,'Andale Mono','lucida console','Courier New',monospace;font-size:0.9em;background-color:#F6F6F6;}.css-1t538q pre{margin:1.4em 0;padding:calc(0.8em / 0.9);font-size:0.9em;word-break:initial;word-wrap:initial;white-space:pre;overflow:auto;-webkit-overflow-scrolling:touch;background:#F6F6F6;border-radius:4px;}.css-1t538q pre code{margin:0;padding:0;font-size:inherit;border-radius:0;background-color:inherit;}.css-1t538q li pre{white-space:pre-wrap;}.css-1t538q table[data-draft-type='table']{border-collapse:collapse;font-size:15px;margin:1.4em auto;max-width:100%;table-layout:fixed;text-align:left;width:100%;}.css-1t538q table[data-draft-type='table'][data-size='small']{min-width:260px;width:40%;}.css-1t538q table[data-draft-type='table'][data-row-style='striped'] tr:nth-of-type(2n + 1){background:#F6F6F6;}.css-1t538q table[data-draft-type='table'] td,.css-1t538q table[data-draft-type='table'] th{border:1px solid #D3D3D3;line-height:24px;height:24px;padding:3px 12px;}.css-1t538q table[data-draft-type='table'] th{background:#EBEBEB;color:#121212;font-weight:500;}.css-1t538q .video-box,.css-1t538q .link-box{position:relative;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;margin:1.4em 0;overflow:auto;white-space:normal;cursor:pointer;border:solid 1px #EBEBEB;border-radius:4px;}.css-1t538q .lazy[data-lazy-status]{background-color:#F6F6F6;}.css-1t538q .lazy[data-lazy-status="ok"]{background-color:transparent;-webkit-animation:animation-1yvu044 0.5s ease-in;animation:animation-1yvu044 0.5s ease-in;}.css-1t538q .highlight{margin:1em 0;}.css-1t538q .highlight pre{margin:0;}.css-1t538q .highlight .hll{background-color:#FDFDFD;}.css-1t538q .highlight .c{font-style:italic;color:#999999;}.css-1t538q .highlight .err{color:#F1403C;}.css-1t538q .highlight .k{font-weight:500;}.css-1t538q .highlight .o{font-weight:500;}.css-1t538q .highlight .cm{font-style:italic;color:#999999;}.css-1t538q .highlight .cp{font-weight:500;color:#999999;}.css-1t538q .highlight .c1{font-style:italic;color:#999999;}.css-1t538q .highlight .cs{font-style:italic;font-weight:500;color:#999999;}.css-1t538q .highlight .gd{color:#FF3366;}.css-1t538q .highlight .ge{font-style:italic;}.css-1t538q .highlight .gr{color:#F1403C;}.css-1t538q .highlight .gh{color:#999999;}.css-1t538q .highlight .gi{color:#12b370;}.css-1t538q .highlight .go{color:#808080;}.css-1t538q .highlight .gp{color:#646464;}.css-1t538q .highlight .gs{font-weight:500;}.css-1t538q .highlight .gu{color:#999999;}.css-1t538q .highlight .gt{color:#F1403C;}.css-1t538q .highlight .kc{font-weight:500;}.css-1t538q .highlight .kd{font-weight:500;}.css-1t538q .highlight .kn{font-weight:500;}.css-1t538q .highlight .kp{font-weight:500;}.css-1t538q .highlight .kr{font-weight:500;}.css-1t538q .highlight .kt{font-weight:500;color:#175199;}.css-1t538q .highlight .m{color:#056DE8;}.css-1t538q .highlight .s{color:#F1403C;}.css-1t538q .highlight .na{color:#056DE8;}.css-1t538q .highlight .nb{color:#056DE8;}.css-1t538q .highlight .nc{font-weight:500;color:#175199;}.css-1t538q .highlight .no{color:#056DE8;}.css-1t538q .highlight .ni{color:#5555DD;}.css-1t538q .highlight .ne{font-weight:500;color:#F1403C;}.css-1t538q .highlight .nf{font-weight:500;color:#F1403C;}.css-1t538q .highlight .nn{color:#646464;}.css-1t538q .highlight .nt{color:#175199;}.css-1t538q .highlight .nv{color:#056DE8;}.css-1t538q .highlight .ow{font-weight:500;}.css-1t538q .highlight .w{color:#BFBFBF;}.css-1t538q .highlight .mf{color:#056DE8;}.css-1t538q .highlight .mh{color:#056DE8;}.css-1t538q .highlight .mi{color:#056DE8;}.css-1t538q .highlight .mo{color:#056DE8;}.css-1t538q .highlight .sb{color:#F1403C;}.css-1t538q .highlight .sc{color:#F1403C;}.css-1t538q .highlight .sd{color:#F1403C;}.css-1t538q .highlight .s2{color:#F1403C;}.css-1t538q .highlight .se{color:#F1403C;}.css-1t538q .highlight .sh{color:#F1403C;}.css-1t538q .highlight .si{color:#F1403C;}.css-1t538q .highlight .sx{color:#F1403C;}.css-1t538q .highlight .sr{color:#A5542F;}.css-1t538q .highlight .s1{color:#F1403C;}.css-1t538q .highlight .ss{color:#F1403C;}.css-1t538q .highlight .bp{color:#999999;}.css-1t538q .highlight .vc{color:#056DE8;}.css-1t538q .highlight .vg{color:#056DE8;}.css-1t538q .highlight .vi{color:#056DE8;}.css-1t538q .highlight .il{color:#056DE8;}.css-1t538q .highlight::-webkit-scrollbar{width:6px;height:6px;}.css-1t538q .highlight::-webkit-scrollbar-thumb:horizontal{background-color:rgba(18,18,18,0.5);border-radius:6px;}.css-1t538q .highlight::-webkit-scrollbar-thumb:horizontal:hover{background-color:rgba(18,18,18,0.6);}.css-1t538q .LinkCard.old{position:relative;display:block;margin:1em auto;width:390px;box-sizing:border-box;border-radius:12px;max-width:100%;overflow:hidden;}.css-1t538q .LinkCard.old,.css-1t538q .LinkCard.old:hover{-webkit-text-decoration:none;text-decoration:none;border:none !important;color:inherit !important;}.css-1t538q .LinkCard-ecommerceLoadingCard{position:relative;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;padding:12px;border-radius:inherit;height:80px;box-sizing:border-box;background:rgba(246,246,246,0.88);color:#D3D3D3;}.css-1t538q .LinkCard-ecommerceLoadingCardAvatarWrapper{width:60px;height:60px;background:#EBEBEB;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;border-radius:6px;margin-right:10px;}.css-1t538q .LinkCard-ecommerceLoadingCardNetwork{width:20px;height:20px;}.css-1t538q .LinkCard-ecommerceLoadingCardLoadingbar{height:60px;-webkit-flex:1;-ms-flex:1;flex:1;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;}.css-1t538q .LinkCard-ecommerceLoadingCardLoadingbar span{height:16px;display:inline-block;background:#EBEBEB;}.css-1t538q .LinkCard-ecommerceLoadingCardLoadingbar span:nth-of-type(1){width:60px;margin-bottom:4px;}.css-1t538q .LinkCard-ecommerceLoadingCardLoadingbar span:nth-of-type(2){width:127px;}.css-1t538q .LinkCard.new{position:relative;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;box-sizing:border-box;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;width:390px;min-height:84px;border-radius:8px;max-width:100%;overflow:hidden;margin:16px auto;padding:12px 12px 9px 12px;background-color:#F6F6F6;}.css-1t538q .LinkCard.new,.css-1t538q .LinkCard.new:hover{-webkit-text-decoration:none;text-decoration:none;border:none !important;color:inherit !important;}.css-1t538q .LinkCard.new .LinkCard-contents{display:block;-webkit-flex:1 1 auto;-ms-flex:1 1 auto;flex:1 1 auto;position:relative;}.css-1t538q .LinkCard.new .LinkCard-contents .loading{height:14px;background:#EBEBEB;border-radius:7px;}.css-1t538q .LinkCard.new .LinkCard-contents.withTitle{margin-bottom:3px;}.css-1t538q .LinkCard.new .LinkCard-title{display:-webkit-box;font-size:15px;font-weight:500;line-height:1.4;margin-bottom:2px;color:#121212;text-overflow:ellipsis;overflow:hidden;-webkit-box-orient:vertical;-webkit-line-clamp:1;}.css-1t538q .LinkCard.new .LinkCard-title.two-line{line-height:20px;display:-webkit-box;text-overflow:ellipsis;overflow:hidden;-webkit-box-orient:vertical;-webkit-line-clamp:2;}.css-1t538q .LinkCard.new .LinkCard-title.loading{margin-bottom:8px;width:80%;}.css-1t538q .LinkCard.new .LinkCard-title.loading.withTitle{margin-bottom:6px;}.css-1t538q .LinkCard.new .LinkCard-title.loadingTitle{margin-bottom:5px;}.css-1t538q .LinkCard.new .LinkCard-excerpt{display:-webkit-box;text-overflow:ellipsis;font-size:13px;line-height:18px;color:#999999;margin-bottom:4px;overflow:hidden;-webkit-box-orient:vertical;-webkit-line-clamp:1;}.css-1t538q .LinkCard.new .LinkCard-excerpt .LinkCard-author{color:#444444;}.css-1t538q .LinkCard.new .LinkCard-desc{display:-webkit-box;font-size:13px;height:18px;line-height:18px;color:#999999;word-break:break-all;text-overflow:ellipsis;overflow:hidden;-webkit-box-orient:vertical;-webkit-line-clamp:1;}.css-1t538q .LinkCard.new .LinkCard-desc .LinkCard-tag,.css-1t538q .LinkCard.new .LinkCard-desc .tag{display:inline-block;font-size:11px;margin-left:8px;padding:0 4px;border-radius:3px;background:rgba(211,211,211,0.3);}.css-1t538q .LinkCard.new .LinkCard-desc.loading{width:40%;}.css-1t538q .LinkCard.new .LinkCard-desc svg{margin-right:2px;}.css-1t538q .LinkCard.new .LinkCard-image{-webkit-flex:0 0 auto;-ms-flex:0 0 auto;flex:0 0 auto;background-color:#EBEBEB;background-size:cover;background-position:center;position:relative;display:block;width:60px;height:60px;margin-left:20px;object-fit:cover;border-radius:inherit;overflow:hidden;}.css-1t538q .LinkCard.new .LinkCard-image.LinkCard-image--default{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;background-color:#EBEBEB;color:#D3D3D3;}.css-1t538q .LinkCard.new .LinkCard-image.LinkCard-image--default svg{color:#999999;}.css-1t538q .LinkCard.new .LinkCard-image img{width:100%;height:100%;object-fit:cover;}.css-1t538q .LinkCard.new .LinkCard-image .LinkCard-image--video{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;position:absolute;top:50%;left:50%;-webkit-transform:translateX(-50%) translateY(-50%);-ms-transform:translateX(-50%) translateY(-50%);transform:translateX(-50%) translateY(-50%);width:24px;height:24px;border-radius:12px;background:rgba(255,255,255,0.9);pointer-events:none;}.css-1t538q .LinkCard.new .LinkCard-image .LinkCard-image--video svg{color:#444444;}.css-1t538q .LinkCard.new .LinkCard-richText .text{color:#444444;}.css-1t538q .LinkCard.new .LinkCard-richText .bold{font-weight:500;}.css-1t538q .LinkCard.new .LinkCard-richText .tag{margin-left:4px;}.css-1t538q .FileLinkCard{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;background-color:rgba(246,246,246,0.88);border-radius:12px;box-sizing:border-box;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;margin:1em auto;max-width:100%;overflow:hidden;padding:12px;position:relative;width:390px;}.css-1t538q .FileLinkCard-icon{-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;height:30px;width:30px;}.css-1t538q .FileLinkCard-info{margin-left:12px;}.css-1t538q .FileLinkCard-name{color:#121212;font-size:15px;font-weight:500;line-height:21px;display:-webkit-box;text-overflow:ellipsis;overflow:hidden;-webkit-box-orient:vertical;-webkit-line-clamp:2;}.css-1t538q .FileLinkCard-meta{color:#999999;font-size:12px;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;line-height:14px;margin-top:5px;}.css-1t538q .FileLinkCard-source{white-space:pre;}.css-1t538q img[data-uncomfortable]{content:url(data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20344.88888888888886%20194%22%3E%3CforeignObject%20width%3D%22344.88888888888886%22%20height%3D%22194%22%3E%0A%20%20%20%20%20%20%3Cdiv%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F1999%2Fxhtml%22%20style%3D%22font-size%3A%2013px%3B%20font-family%3A%20-apple-system%2C%20BlinkMacSystemFont%2C%20Microsoft%20YaHei%2C%20sans-serif%3B%20color%3A%20%23fff%3B%20width%3A100%25%3B%20height%3A194px%3B%22%3E%0A%20%20%20%20%20%20%20%20%3Cdiv%20style%3D%22display%3A%20flex%3B%20flex-direction%3A%20column%3B%20align-items%3A%20center%3B%20justify-content%3A%20center%3B%20height%3A%20100%25%3B%22%3E%0A%20%20%20%20%20%20%20%20%20%20%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2218%22%20height%3D%2218%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22currentColor%22%3E%3Cpath%20d%3D%22M8%203.65a7%207%200%2000-1.353.128.65.65%200%2011-.25-1.275A8.3%208.3%200%20018%202.35c2.387%200%204.172.954%205.357%202.125C14.511%205.615%2015.15%207.022%2015.15%208c0%20.621-.257%201.391-.699%202.134a7.076%207.076%200%2001-1.403%201.68l.495.46a.65.65%200%2011-.886.951l-.998-.929a.645.645%200%2001-.104-.097L9.73%2010.501a.647.647%200%2001-.29.301%203.15%203.15%200%2001-4.313-4.094.647.647%200%2001.234-.275L3.908%205.08a5.774%205.774%200%2000-1.283%201.522C2.282%207.198%202.15%207.707%202.15%208c0%20.522.41%201.616%201.407%202.6.965.954%202.43%201.75%204.443%201.75.468%200%20.905-.043%201.311-.12a.65.65%200%2001.243%201.277A8.322%208.322%200%20018%2013.65c-2.387%200-4.172-.954-5.357-2.125C1.49%2010.385.85%208.978.85%208c0-.598.238-1.333.648-2.046A7.054%207.054%200%20012.95%204.188l-.547-.509a.65.65%200%2011.886-.951l8.8%208.194a5.793%205.793%200%20001.244-1.453c.372-.624.516-1.163.516-1.469%200-.522-.41-1.616-1.407-2.6-.965-.954-2.43-1.75-4.443-1.75zM6.29%207.296a1.85%201.85%200%20002.534%202.36l-2.535-2.36zM8%204.85a.65.65%200%20100%201.3%201.85%201.85%200%20011.843%201.694.65.65%200%20101.296-.11A3.15%203.15%200%20008%204.85z%22%20fill-rule%3D%22evenodd%22%20clip-rule%3D%22evenodd%22%3E%3C%2Fpath%3E%3C%2Fsvg%3E%0A%20%20%20%20%20%20%20%20%20%20%3Cdiv%20style%3D%22margin%3A%20.6em%200%201.2em%22%3E%E8%AF%A5%E5%9B%BE%E7%89%87%E6%9C%89%E5%8F%AF%E8%83%BD%E4%BC%9A%E5%BC%95%E8%B5%B7%E4%B8%8D%E9%80%82%3C%2Fdiv%3E%0A%20%20%20%20%20%20%20%20%20%20%3Cbutton%20style%3D%22padding%3A%204px%201em%3B%20font-size%3A%201.1em%3B%20color%3A%20inherit%3B%20background%3A%20none%3B%20border%3A%201px%20solid%20rgba%28255%2C255%2C255%2C.5%29%3B%20border-radius%3A%209999px%3B%22%3E%E7%BB%A7%E7%BB%AD%E6%9F%A5%E7%9C%8B%3C%2Fbutton%3E%0A%20%20%20%20%20%20%20%20%3C%2Fdiv%3E%0A%20%20%20%20%20%20%3C%2Fdiv%3E%0A%20%20%20%20%3C%2FforeignObject%3E%3C%2Fsvg%3E);width:100%;height:194px;background:url(https://pic1.zhimg.com/v2-cf70d0759d787c70091857151c1cad4a.jpeg) no-repeat rgba(191,191,191,0.7);background-size:cover;cursor:pointer!important;}@-webkit-keyframes animation-1yvu044{from{opacity:0;}to{opacity:1;}}@keyframes animation-1yvu044{from{opacity:0;}to{opacity:1;}}</style><style data-emotion-css="1k6fd7f">.css-1k6fd7f{margin:0;padding-top:15px;}</style><style data-emotion-css="1any501">.css-1any501{box-sizing:border-box;margin:0;min-width:0;max-width:100%;height:auto;background-color:#FFFFFF;width:40px;height:40px;border-radius:50%;}</style><style data-emotion="css"></style></head><body class="WhiteBg-body PostIndex-body Body--Mobile Body--iOS Body--isAppleDevice" aria-basefontsize="16" data-rh="class"><a id="ariaTipText" role="pagedescription" aria-label="链接，无障碍模式读屏软件服务通道。" aria-atomic="true" href="javascript:void(0)" class="skipAutoFix" onclick="aria.wzaStart();" style="width: 1px; height: 1px;"><img src="" style="width:1px !important;height:1px !important;position:absolute;top:0;"></a><div id="root"><div class="App"><div class="LoadingBar  css-nvw5ip"></div><div><span style="position:absolute;top:-10000px;left:-10000px" role="log" aria-live="assertive"></span></div><main role="main" class="App-main"><div class="Post-content Post-content-mobile" data-zop-usertoken="{&quot;userToken&quot;:&quot;&quot;}" data-zop="{&quot;authorName&quot;:&quot;字节&quot;,&quot;itemId&quot;:591751476,&quot;title&quot;:&quot;重新思考软件测试&quot;,&quot;type&quot;:&quot;article&quot;}" data-za-detail-view-path-module="PostItem" data-za-extra-module="{&quot;card&quot;:{&quot;content&quot;:{&quot;type&quot;:&quot;Post&quot;,&quot;token&quot;:&quot;591751476&quot;}}}"><div><header class="Sticky MobileAppHeader" style="line-height:50px"><div class="MobileAppHeader-inner"><a class="MobileAppHeader-logo" href="//www.zhihu.com?utm_source=zhihu&amp;utm_campaign=guest_feed&amp;utm_content=guide&amp;utm_medium=zhuanlan&amp;utm_id=0" aria-label="知乎"><svg viewBox="0 0 64 30" fill="#056DE8" width="52" height="24.375"><path d="M29.05 4.582H16.733V25.94h3.018l.403 2.572 4.081-2.572h4.815V4.582zm-5.207 18.69l-2.396 1.509-.235-1.508h-1.724V7.233h6.78v16.04h-2.425zM14.46 14.191H9.982c0-.471.033-.954.039-1.458v-5.5h5.106V5.935a1.352 1.352 0 0 0-.404-.957 1.378 1.378 0 0 0-.968-.396H5.783c.028-.088.056-.177.084-.255.274-.82 1.153-3.326 1.153-3.326a4.262 4.262 0 0 0-2.413.698c-.57.4-.912.682-1.371 1.946-.532 1.453-.997 2.856-1.31 3.693C1.444 8.674.28 11.025.28 11.025a5.85 5.85 0 0 0 2.52-.61c1.119-.593 1.679-1.502 2.054-2.883l.09-.3h2.334v5.5c0 .5-.045.982-.073 1.46h-4.12c-.71 0-1.39.278-1.893.775a2.638 2.638 0 0 0-.783 1.874h6.527a17.717 17.717 0 0 1-.778 3.649 16.796 16.796 0 0 1-3.012 5.273A33.104 33.104 0 0 1 0 28.74s3.13 1.175 5.425-.954c1.388-1.292 2.631-3.814 3.23-5.727a28.09 28.09 0 0 0 1.12-5.229h5.967v-1.37a1.254 1.254 0 0 0-.373-.899 1.279 1.279 0 0 0-.909-.37z"></path><path d="M11.27 19.675l-2.312 1.491 5.038 7.458a6.905 6.905 0 0 0 .672-2.218 3.15 3.15 0 0 0-.28-2.168l-3.118-4.563zM51.449 15.195V5.842c4.181-.205 7.988-.405 9.438-.483l.851-.05c.387-.399.885-2.395.689-3.021-.073-.25-.213-.666-.638-.555a33.279 33.279 0 0 1-4.277.727c-2.766.321-3.97.404-7.804.682-6.718.487-12.709.72-12.709.72a2.518 2.518 0 0 0 .788 1.834 2.567 2.567 0 0 0 1.883.706c2.278-.095 5.598-.25 8.996-.41v9.203h-12.78c0 .703.281 1.377.783 1.874a2.69 2.69 0 0 0 1.892.777h10.105v7.075c0 .887-.464 1.192-1.231 1.214h-3.92a4.15 4.15 0 0 0 .837 1.544 4.2 4.2 0 0 0 1.403 1.067 6.215 6.215 0 0 0 2.71.277c1.36-.066 2.967-.826 2.967-3.57v-7.607h11.28c.342 0 .67-.135.91-.374.242-.239.378-.563.378-.902v-1.375H51.449z"></path><path d="M42.614 8.873a2.304 2.304 0 0 0-1.508-.926 2.334 2.334 0 0 0-1.727.405l-.376.272 4.255 5.85 2.24-1.62-2.884-3.98zM57.35 8.68l-3.125 4.097 2.24 1.663 4.517-5.927-.375-.277a2.32 2.32 0 0 0-1.722-.452 2.327 2.327 0 0 0-1.536.896z"></path></svg></a><div class="MobileAppHeader-actions"><label class="MobileAppHeader-searchBox MobileAppHeader-searchBoxWithUnlogin Input-wrapper"><svg width="16" height="16" viewBox="0 0 24 24" fill="#999" class="ZDI ZDI--Search24 css-15ro776"><g fill-rule="evenodd" clip-rule="evenodd"><path d="M11.5 18.389c3.875 0 7-3.118 7-6.945 0-3.826-3.125-6.944-7-6.944s-7 3.118-7 6.944 3.125 6.945 7 6.945Zm0 1.5c4.694 0 8.5-3.78 8.5-8.445C20 6.781 16.194 3 11.5 3S3 6.78 3 11.444c0 4.664 3.806 8.445 8.5 8.445Z"></path><path d="M16.47 16.97a.75.75 0 0 1 1.06 0l3.5 3.5a.75.75 0 1 1-1.06 1.06l-3.5-3.5a.75.75 0 0 1 0-1.06Z"></path></g></svg><input type="search" value="" class="Input" placeholder="搜索"></label><a class="MobileAppHeader-authLink" href="https://www.zhihu.com/signin?next=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F591751476" data-za-detail-view-name="注册或登录"><svg width="24" height="24" viewBox="0 0 24 24" style="vertical-align:middle;margin-bottom:1px" class="ZDI ZDI--User24" fill="currentColor"><path fill-rule="evenodd" d="M7.25 8A4.75 4.75 0 0 1 12 3.25 4.75 4.75 0 0 1 16.75 8 4.75 4.75 0 0 1 12 12.75 4.75 4.75 0 0 1 7.25 8ZM12 1.75A6.25 6.25 0 0 0 5.75 8a6.248 6.248 0 0 0 3.275 5.498c-2.993 1.03-5.222 3.572-5.521 6.681a.75.75 0 1 0 1.493.144c.31-3.209 3.277-5.819 7.006-5.819.025 0 .05-.001.075-.004 3.692.036 6.622 2.634 6.93 5.823a.75.75 0 1 0 1.492-.144c-.3-3.11-2.527-5.652-5.52-6.684A6.248 6.248 0 0 0 18.25 8 6.25 6.25 0 0 0 12 1.75Z" clip-rule="evenodd"></path></svg></a><button type="button" class="Button css-183aq3r Button--blue">打开App</button><svg width="22" height="22" viewBox="0 0 24 24" class="ZDI ZDI--Dots24 css-1ie3c6f" fill="currentColor"><path fill-rule="evenodd" d="M5.83 12a1.665 1.665 0 1 1-3.33 0 1.665 1.665 0 0 1 3.33 0Zm7.835 0a1.665 1.665 0 1 1-3.33 0 1.665 1.665 0 0 1 3.33 0Zm6.17 1.665a1.665 1.665 0 1 0 0-3.33 1.665 1.665 0 0 0 0 3.33Z" clip-rule="evenodd"></path></svg></div></div><div></div></header></div><div class="css-78p1r9"><div class="css-1ghsn9"><div class="css-1ld0bim"><img src="https://pic1.zhimg.com/v2-8bb94a3857a9a2891b9707b92f7ad76a_720w.jpg?source=172ae18b" alt="重新思考软件测试" width="100%" height="100%" class="css-1phd9a0" srcset="https://pic1.zhimg.com/v2-8bb94a3857a9a2891b9707b92f7ad76a_200x0.jpg?source=172ae18b 200w,https://pic1.zhimg.com/v2-8bb94a3857a9a2891b9707b92f7ad76a_qhd.jpg?source=172ae18b 480w,https://pic1.zhimg.com/v2-8bb94a3857a9a2891b9707b92f7ad76a_720w.jpg?source=172ae18b 720w,https://pic1.zhimg.com/v2-8bb94a3857a9a2891b9707b92f7ad76a_1440w.jpg?source=172ae18b 1440w" loading="lazy"></div></div></div><article class="Post-Main Post-Main-Mobile" tabindex="-1"><header class="Post-Header"><h1 class="Post-Title">重新思考软件测试</h1></header><div class="Post-TimeExtra">6 个月前<!-- --> · 来自专栏 <!-- -->RandomGenerator</div><div class="Post-Author Post-Author-Mobile"><div class="AuthorInfo" itemprop="author" itemscope="" itemtype="http://schema.org/Person"><div class="AuthorInfo"><meta itemprop="name" content="字节"><meta itemprop="image" content="https://pic1.zhimg.com/v2-95ba0bb27d5abbdac132d83c17310b22_l.jpg?source=172ae18b"><meta itemprop="url" content="https://www.zhihu.com/people/zijie0"><meta itemprop="zhihu:followerCount"><span class="UserLink AuthorInfo-avatarWrapper"><a href="//www.zhihu.com/people/zijie0" target="_blank" class="UserLink-link" data-za-detail-view-element_name="User"><img class="Avatar AuthorInfo-avatar css-kl6aur" src="https://pic1.zhimg.com/v2-95ba0bb27d5abbdac132d83c17310b22_l.jpg?source=172ae18b" srcset="https://pic1.zhimg.com/v2-95ba0bb27d5abbdac132d83c17310b22_l.jpg?source=172ae18b 2x" alt="字节"></a></span><div class="AuthorInfo-content"><div class="AuthorInfo-head"><span class="UserLink AuthorInfo-name"><a href="//www.zhihu.com/people/zijie0" target="_blank" class="UserLink-link" data-za-detail-view-element_name="User">字节</a></span></div><div class="AuthorInfo-detail"><div class="AuthorInfo-badge"><div class="ztext AuthorInfo-badgeText css-0">天地大观，志存高远</div></div></div></div></div></div><button type="button" class="Button FollowButton Button--primary Button--blue"><span style="display:inline-flex;align-items:center">​<svg width="1.2em" height="1.2em" viewBox="0 0 24 24" class="Zi Zi--Plus FollowButton-icon" fill="currentColor"><path fill-rule="evenodd" d="M13.25 3.25a1.25 1.25 0 1 0-2.5 0v7.5h-7.5a1.25 1.25 0 1 0 0 2.5h7.5v7.5a1.25 1.25 0 1 0 2.5 0v-7.5h7.5a1.25 1.25 0 0 0 0-2.5h-7.5v-7.5Z" clip-rule="evenodd"></path></svg></span>关注</button></div><div class="Post-RichTextContainer"><div class="css-1yuhvjn"><div class="css-376mun"><div class="RichText ztext Post-RichText css-1t538q" options="[object Object]"><p data-first-child="" data-pid="JpKltOQh">虽然之前也写了快二十年代码了，对于很多现代软件工程的 buzz word 如敏捷，持续集成，DevOps 等都耳熟能详。但这两年在项目上碰到的各种挑战，以及跟一些开发者同僚交流下来发现，其实软件工程的很多最佳实践并没有被广泛接受和应用，在软件质量领域，我们持续受到了很大的挑战。</p><p data-pid="hi_MuUoc">过去十多年，中国的互联网软件得到了蓬勃的发展，其中有两个看起来比较突出的挑战：一是如何能快速推出一个产品原型，迅速尝试一些新想法，抢占市场知名度；另一个是当产品赢得大量用户之后，随之而来对于底层基础设施的大规模计算执行，大数据量存储与处理方面的挑战。在这两个挑战下，形成了很多具有“互联网特色”的软件工程实践，例如早年很有名的 Facebook 的口号“Move fast and break things”，以及各种技术分享中最火热的一般都是基础系统架构的演进之类的话题。</p><p data-pid="tGBwOcWV">这两年国内的 SaaS to B 领域逐渐开始升温，很多“传统”软件开发的挑战也随之而来，跟互联网类软件的问题还不太一样。例如很多 SaaS 软件的数据量没有那么大，对底层基础设施没有很高的要求，如果照搬“internet scale”的设计就很容易自己给自己添麻烦。商业软件的演进路线也相对比较明确，后续持续维护的时间一般也更长，所以碰到所谓 legacy system 的情况也会更常见。另外就是很多公司内部的业务需求与流程非常的复杂，由此而来对于软件“领域模型”的复杂度要求也上升了很多。</p><p data-pid="e2EBLqL7">这些挑战即使是比较有经验的互联网软件开发者也不一定有积累的技能可以直接解决，也经常让我们感叹国内的软件人才为何如此稀缺。所以我们还是需要回到软件工程角度，去看看适合此类企业级软件开发的最佳实践到底是怎么样的。</p><h2>现代软件工程</h2><p data-pid="MHn055Id">当年在计算机硬件飞速发展时，人们就发现与之配套的软件开发的增长速度却极其有限，经常碰到无法按时交付，超出预算，品质低下，不符合需求，难以维护等等问题。著名的《人月神话》也是在那个时代撰写出版的，描述了大型软件开发项目中所遇到的困境。</p><p data-pid="t-Y_8gwE">为了解决这个问题，人们非常自然的一个思路就是借鉴我们其它大型工程中已经应用过的实践，最典型的就是“瀑布式开发”模式。</p><p class="ztext-empty-paragraph"><br></p><figure data-size="normal"><noscript>&lt;img src="https://pic3.zhimg.com/v2-379dfcb55c9ea7eb0a0b0382c96c263a_b.jpg" data-size="normal" data-rawwidth="1297" data-rawheight="936" class="origin_image zh-lightbox-thumb" width="1297" data-original="https://pic3.zhimg.com/v2-379dfcb55c9ea7eb0a0b0382c96c263a_r.jpg"/&gt;</noscript><div><img src="data:image/svg+xml;utf8,&lt;svg xmlns='http://www.w3.org/2000/svg' width='1297' height='936'&gt;&lt;/svg&gt;" data-size="normal" data-rawwidth="1297" data-rawheight="936" class="origin_image zh-lightbox-thumb lazy" width="1297" data-original="https://pic3.zhimg.com/v2-379dfcb55c9ea7eb0a0b0382c96c263a_r.jpg" data-actualsrc="https://pic3.zhimg.com/v2-379dfcb55c9ea7eb0a0b0382c96c263a_b.jpg" data-original-token="v2-79f3cb0cf479f1456da98e5713917411"></div><figcaption>瀑布式开发模型</figcaption></figure><p class="ztext-empty-paragraph"><br></p><p data-pid="Qews57We">在这个模型中，每一个步骤有着严格的先后顺序之分，希望能严格把需求和设计确定好后再开始开发，然后测试验收后部署上线。这套方法在很多其它类型的工程里都得到了大量的应用，比如如果家里做过装修的话就会切身体验一遍这个流程。</p><p data-pid="D-Qj29S2">瀑布式模型之所以有效，一个很重要的原因是它很好地解决了“实体化生产”带来的挑战。比如我们要做装修，把所有实体部件构建出来，像水管，电线，开关，地板，橱柜，家居，电器等等，需要花费非常大的代价。同理如果我们要做硬件的生产，如芯片，汽车等，批量化制造的成本也是非常高的。这些最终实体生产出来后，如果发现有问题，需要返工修改，几乎就代表了项目的失败。</p><p data-pid="iAP1vLcY">但对于软件来说，其本身并不存在“实体化生产”的问题。我们知道任何一份代码写出来，做批量化的复制运行可以说是成本很低的。所以瀑布式模型后来受到很多诟病的原因也不难理解了，因为它想要解决的问题，在软件工程领域并不存在（至少不那么严重）。</p><p data-pid="R9HgBW96">所以我们在思考软件工程时，需要抵制住套用人类千年来的传统工程思维的影响，从软件本身的特性出发去寻找更加匹配的方法论。没有“实体化生产”的包袱，可以快速做修改迭代，需要服务于现实需求，但又会随着环境，技术的演变发生丰富而又难以预料的变化，是不是可以联想到一个有些类似的活动：科学研究。</p><p data-pid="DSpZHjLv">跟软件一样，科学研究很多时候会在理论和设计层面进行推演，即使涉及到实验，一般也是相对来说较低成本的形式。科研的探索方向是明确的，但具体的路径和实现方式有着很大的不确定性，因此需要不断地提出假设，设计实验，进行实验，获取反馈，迭代认知，再提出新的假设这样循环往复。这与后续出现的“敏捷”开发模式有着很高的相似度。</p><p class="ztext-empty-paragraph"><br></p><figure data-size="normal"><noscript>&lt;img src="https://pic4.zhimg.com/v2-270cc75c660df284b623598370c877b7_b.jpg" data-size="normal" data-rawwidth="2000" data-rawheight="1340" class="origin_image zh-lightbox-thumb" width="2000" data-original="https://pic4.zhimg.com/v2-270cc75c660df284b623598370c877b7_r.jpg"/&gt;</noscript><div><img src="data:image/svg+xml;utf8,&lt;svg xmlns='http://www.w3.org/2000/svg' width='2000' height='1340'&gt;&lt;/svg&gt;" data-size="normal" data-rawwidth="2000" data-rawheight="1340" class="origin_image zh-lightbox-thumb lazy" width="2000" data-original="https://pic4.zhimg.com/v2-270cc75c660df284b623598370c877b7_r.jpg" data-actualsrc="https://pic4.zhimg.com/v2-270cc75c660df284b623598370c877b7_b.jpg" data-original-token="v2-e04ef33802c8a6726db70e8e55261c4d"></div><figcaption>Agile 模型</figcaption></figure><p class="ztext-empty-paragraph"><br></p><p data-pid="0wmqV3cA">所以当前主流的现代软件工程思想，就是把软件开发行为的本质理解为假设，行动，反馈，学习这几个步骤。大家应该也经常听到类似的说法，比如“架构是演进出来的，而不是设计出来的”。与科学研究不同的是，软件工程一般有更长的持续性，因此在设计与行动这块，会更加注重“控制软件熵（复杂度）”。这篇文章会更多从软件质量角度出发，来讨论软件工程中的反馈与学习。如果我们能做到高质量的反馈与学习，就能打造出更符合用户需求，功能完备性和质量都更好的软件产品。同时我们也会看到，反馈学习本身对于复杂度的控制也有很大的协同促进作用。</p><h2>软件质量的综合指标</h2><p data-pid="rSKT-At5">如何评价软件的质量呢？如果我们以传统眼光来看，一件物品的质量的衡量方式可能是其广大使用者在一定时间内遇到的故障问题数量和严重程度。但对于软件来说，质量其实是一个动态的过程，因为客户的诉求和使用场景会发生变化，而软件本身也会不断升级版本来满足相应的诉求。</p><p data-pid="PLDuCLDF">在查阅了一些资料后发现，业界对于软件质量的定义主要集中在四个指标上：</p><ul><li data-pid="qBL_XoiD">每次软件变更带来的问题数的平均值。</li><li data-pid="pFIhWhCN">每个软件问题从发现到修复所耗费时间的平均值。</li><li data-pid="R5aESTvH">从提出需求，到软件交付所花费时间的平均值。</li><li data-pid="cfuQSjik">发布/部署到生产环境的频率。</li></ul><p data-pid="ApMDri1P">前两个指标主要是从稳定性的角度来看，我们发布软件的问题多不多。而后两个指标是从吞吐量角度来看，我们发布软件的速度快不快。</p><p data-pid="kRbDuea8">绝大多数软件工程师都会觉得，速度和稳定性这两点是个 trade-off。如果我希望发布更稳定，那么一般来说就需要花更长的时间做质量保障相关工作，例如各种测试验证。而如果用户急着要某个功能，那么必然会影响发布版本的质量，可能引入不少 bug。</p><p data-pid="-aE58EHj">但有意思的是，从《<a href="https://link.zhihu.com/?target=https%3A//book.douban.com/subject/30192146/" class=" wrap external" target="_blank" rel="nofollow noreferrer">Accelerate</a>》这本书中我们可以看到来自 Puppet 与学术机构合作的“State of DevOps”报告中指出，具有更高发布稳定性的团队组织，往往其发布的吞吐量也会更高。而发布稳定性低的组织，可能因此引入了更多的流程，人工审核，或者引起了客户对其新版本的不信任，进一步拖慢了其发布的吞吐量。也就是说，这两者非但不是非此即彼，而是相互促进的，真正的 trade-off 是在“更好更快”与“更差更慢”这两者之间。</p><p class="ztext-empty-paragraph"><br></p><figure data-size="normal"><noscript>&lt;img src="https://pic3.zhimg.com/v2-e01f2180e3f43c4546b0a92a5feb7e06_b.jpg" data-size="normal" data-rawwidth="2084" data-rawheight="1388" class="origin_image zh-lightbox-thumb" width="2084" data-original="https://pic3.zhimg.com/v2-e01f2180e3f43c4546b0a92a5feb7e06_r.jpg"/&gt;</noscript><div><img src="data:image/svg+xml;utf8,&lt;svg xmlns='http://www.w3.org/2000/svg' width='2084' height='1388'&gt;&lt;/svg&gt;" data-size="normal" data-rawwidth="2084" data-rawheight="1388" class="origin_image zh-lightbox-thumb lazy" width="2084" data-original="https://pic3.zhimg.com/v2-e01f2180e3f43c4546b0a92a5feb7e06_r.jpg" data-actualsrc="https://pic3.zhimg.com/v2-e01f2180e3f43c4546b0a92a5feb7e06_b.jpg" data-original-token="v2-11fdb1bee9233985b3d578e1f654220c"></div><figcaption>这个分类是通过聚类算法跑出来的</figcaption></figure><p class="ztext-empty-paragraph"><br></p><p data-pid="5kkHEUna">从逻辑上来说也好理解，如果我们想有更多的学习与认知迭代，打造出更符合用户需求的软件，更快的发现问题并修复，那么就需要有更快的发布速度获取反馈。如果我们想要有更快的发布速度，那么本身的质量也需要过硬避免复杂的流程（书中也提到，流程通常对质量没什么帮助），发现问题要尽可能提早减少返工等。而且代码设计上需要更加合理，才便于做修改与演进，后面我们也会看到代码设计与可测试性之间也有着协同促进的关系。</p><p data-pid="imMw7hzl">所以还是回到前面所说的，为了提升软件质量，还是回到反馈学习这个核心上。而这其中最有意思的，莫过于测试了。传统的看法会把测试等价于做其它实体产品的“质量检测”环节。但在软件工程中，测试不仅仅只是保障软件没有问题的一个步骤，而是我们获取反馈，学习知识最重要的一项基础手段。如果没有高质量，即时的反馈，那我们就不得不在过程中带入更多的猜测，这在复杂的软件项目上往往是很不靠谱的。</p><p data-pid="iFFF4-zv">就像在科学研究中，我们会通过实验来获取理论在真实世界中的反馈一样，测试就是软件开发中获取反馈的方式。如果以玩游戏来类比，做实验有点像回合制游戏，玩家会通过缜密的思考推演，来下一步棋，然后再等待对手的反馈。而软件中的测试，则是实时化的，我们指挥兵力前进过程中，能即时地感知到周围环境的变化，对手的动作反应等。如果网络卡了，你很可能就无法发挥出很好的水平，因为反馈速度变慢了。</p><p data-pid="H1w9gOOz">同理我们在 IDE 里写代码时，都是有实时的静态代码分析与提示，告诉你这里可能写的有问题。进一步，我们也需要添加相关的测试来丰富我们的“感知”，实时地了解这里的改动可能会破坏某些已有功能。顺便一提很多人推崇<code>vim</code>，<code>emacs</code>这样的工具，但从实时反馈，以及反馈信息的丰富程度上来说，IDE 应该是更好的选择，而且现在很多这类传统编辑器也在尝试通过各种插件在终端里去实现类似 IDE 的效果。</p><p data-pid="2Xd04YxA">讲到这里大家应该可以理解为何测试与软件开发应该是一个整体了。在自动化测试这个重要的基础手段之上，后续才演化出更多的如持续集成，持续部署，更全面的 DevOps 等实践。</p><h2>为何需要研发来写测试</h2><p data-pid="PmfS_7rC">前面我们已经提到测试与开发应该是一体的，而不应该独立开来。这个想法可能会受到很多传统工程思维或者旧行为模式习惯的挑战，例如：</p><ul><li data-pid="-bMW_Itm">很多人潜意识中会觉得，工程师的任务就是写“功能代码”，写完就算任务完成了。但实际上，工程师的任务应该是解决客户问题，创造业务价值。任何对这个目标有帮助的事情，都应该放在我们的职责范围内，例如写测试，写文档，完善持续集成与交付等。</li><li data-pid="RSFG5oTE">为什么写自动化测试没有成为大家的习惯？一个常见的“陷阱”是，写完功能代码能跑通，会给人带来满足感；把功能上线后出了问题，我加班解决问题拯救公司，加倍带来满足感。这种短期满足感的叠加，反而让我们陷入一个恶性循环。</li><li data-pid="h6K-_hE8">还有一个常见的想法叫“速度与质量不可兼得”，因为排期紧，所以研发只能只写功能代码。但实际情况我们前面也提到了，这两者恰恰是高度正相关的。达到高质量软件的重要途径，是更快速的发布，以获得更及时的内外部反馈信息（测试是否通过，客户是否对功能满意）；达到更快发布速度的路径，是高质量的软件，否则引入一堆的问题肯定会拖慢发布速度，或者用户根本不愿意升级。几乎没有公司是反过来的，质量很高，但迭代发布很慢，或者质量很差，但迭代发布很快。我们作为专业研发人员，在估算开发周期时就不应该有意把写代码和写测试分开来。</li><li data-pid="Aj8mD7LH">还有一个常见的抱怨是，需求总是变，那我写测试有什么意义？这个问题也印证了我们前面所说的，软件开发与科学探索是具有一些相似性的。“唯一不变的就是变化”，对于绝大多数的真实世界问题来说，其复杂度和变化速度，都是很难以人类大脑来进行预先设计的，因此现代软件工程的核心其实也就集中在这两方面，“控制复杂度”和“反馈学习”。得益于软件易于改变的优势，我们得以应用敏捷模式，而不是其它现实世界工程中常用的瀑布模式。但这个思维的转变，其实需要很长时间才能逐渐成为大家的共识。</li><li data-pid="k3sxFw_G">为什么测试和功能开发应该同步进行，而不是先写功能，等全部完成后再写测试呢？作为开发者，我们产出功能代码的速度总体来说是稳定的，修改完成后，你获得测试反馈的延迟越长，则这段时间内你作出的修改就越多。是 1 秒钟就知道自己代码写得对不对，还是 1 周后才知道，这个差别是巨大的。如果 1 周后才发现有问题，那么是不是这一周里做的很多东西都有可能要返工了？这也是 TDD 之类的思想产生的原因之一。</li><li data-pid="qQiA_cUB">大家也经常提术业有专攻，如果自己测试自己写的代码，容易进入思维盲区。后面我们会详细讲到测试的分类，但是如果仅依赖传统质检步骤的端到端（e2e）测试，是有很多问题的。例如 e2e 测试的开发，执行与维护成本很高，需要覆盖的 case 数量更多，检查的粒度太粗，难以做变量控制等等。从获取反馈的质量角度来思考，e2e 测试也有不少缺陷，因为它把整个系统的复杂度都包含进去了。当出现 case 失败时，我们是不是还需要花更多的时间去定位问题，是数据问题吗，是环境配置的问题吗，是别的组件的问题吗，是网络抖动的问题吗，等等。而好的测试应该能非常精确的告诉我们出问题的地方在哪里，做好“变量控制”，使得测试本身也更加稳定和可信。</li><li data-pid="FYUiWmGK">软件工程还有一个核心诉求是“控制复杂度”，而通过写测试，我们会成为自己设计的类和 API 的第一使用者，能更早的发现设计上的问题，尽量规避“偶然复杂度”。如果发现不好写测试，那么很可能就是我们的设计有问题，可能是 API 不够清晰，可能是不够模块化，可能是没有遵循高内聚低耦合的原则等等，可以及时进行优化。如果是写完代码再写测试，那么很可能就会偏向 end to end 的粗粒度测试，而到了几个月后要修改功能或添加新功能时，你仍然会遇到修改困难，需要重构的问题。所以至少写单元测试，应该跟开发功能的是同一个人才更能发挥出这些好处。</li><li data-pid="GcVp9dbG">最后在团队协作层面，模块的开发者负责模块的测试也对于沟通成本的控制会有很大的好处。试想如果我们要造一辆汽车，所有的测试都要在整车拼装完成后在马路上进行，那样的话团队间的沟通成本，可能造成的返工风险，各个模块的可复用程度等都会大打折扣。仅仅依赖 e2e 测试，那么系统集成的开销和风险就会大幅上升。</li></ul><p data-pid="8wbYvYOy">综合这些点来看，要成为一名合格的现代软件工程师，自己的功能自己写测试是非常有必要的。且在绝大多数的先进公司，开源项目中，都已经成为了一种主流实践方式。</p><h2>软件测试基本概念</h2><p data-pid="3lRNkA0s">前面聊了这么多，终于要来上点干货了。以下内容很多来自于《<a href="https://link.zhihu.com/?target=https%3A//book.douban.com/subject/34875994/" class=" wrap external" target="_blank" rel="nofollow noreferrer">Software Engineering at Google</a>》，《<a href="https://link.zhihu.com/?target=https%3A//book.douban.com/subject/35817720/" class=" wrap external" target="_blank" rel="nofollow noreferrer">Effective Software Testing</a>》，《<a href="https://link.zhihu.com/?target=https%3A//book.douban.com/subject/34429421/" class=" wrap external" target="_blank" rel="nofollow noreferrer">Unit Testing</a>》这三本书。尤其是最后一本，是我从业以来看过最好的一本关于测试的技术书籍，值得强烈推荐。</p><h3>什么是好的测试</h3><p data-pid="JvA5svhq">写测试也是需要有很多深入思考的，并不是大家印象中的“周边工作”。相信很多人就没有深入想过，到底什么才是一个好的测试？为什么有些项目也写了很多测试，但好像经常挂掉也没人去看，维护又要花很多时间，线上的 bug 也没有多少被抓到，好像完全成了摆设？</p><p data-pid="P6XAOsL3">为了找到好测试的标准，我们先来看一下测试的目标是什么。如果没有测试或者测试的质量很差，会导致随着项目的推进，开发迭代速度出现剧烈下降。这样的现象被称为软件熵，也即代表了软件的腐化。好的测试的目标是保证软件的可持续发展，在长期开发之后，依然可以持续演进。</p><p class="ztext-empty-paragraph"><br></p><figure data-size="normal"><noscript>&lt;img src="https://pic3.zhimg.com/v2-ef61b93990ca12b05a6566b53f41433a_b.jpg" data-size="normal" data-rawwidth="2162" data-rawheight="1170" class="origin_image zh-lightbox-thumb" width="2162" data-original="https://pic3.zhimg.com/v2-ef61b93990ca12b05a6566b53f41433a_r.jpg"/&gt;</noscript><div><img src="data:image/svg+xml;utf8,&lt;svg xmlns='http://www.w3.org/2000/svg' width='2162' height='1170'&gt;&lt;/svg&gt;" data-size="normal" data-rawwidth="2162" data-rawheight="1170" class="origin_image zh-lightbox-thumb lazy" width="2162" data-original="https://pic3.zhimg.com/v2-ef61b93990ca12b05a6566b53f41433a_r.jpg" data-actualsrc="https://pic3.zhimg.com/v2-ef61b93990ca12b05a6566b53f41433a_b.jpg" data-original-token="v2-ed109cf0254896c23f5f834ed97a2f9f"></div><figcaption>好的测试才能让项目持续可控</figcaption></figure><p class="ztext-empty-paragraph"><br></p><p data-pid="YjAUzRR8">具体来说，测试的目标包括：</p><ul><li data-pid="WKpFLXLQ">与研发流程紧密集成，达到前面所说的“实时反馈”的效果。</li><li data-pid="Hr8zXq9g">针对代码库中最重要的部分进行测试，一般就是领域模型。</li><li data-pid="GXSZXPQs">以最小的维护成本产出最大的价值。测试的维护成本包括：</li><ul><li data-pid="CWkgNAOF">重构功能代码时，有时候也需要重构测试。</li><li data-pid="pMfE_jM-">每次代码变更时都需要执行测试，因此执行成本也需要考虑。</li><li data-pid="PhmlBF65">测试报错时，需要进行排查和处理，尤其要注意误报。</li><li data-pid="Pdk2vkxr">阅读和理解测试也需要投入时间。</li></ul></ul><p data-pid="bATy--i7">如果仅仅只是增加测试用例的数量，并不能很好地实现控制软件熵的目标，同时也需要结合测试成本考虑总体的 ROI。一个好的自动化测试应该符合四条标准：</p><ul><li data-pid="mbqI0AxE">防止代码功能失效（regression）。为了起到更好的保护作用，测试执行时应该考虑去尽可能覆盖更多的代码，项目中复杂度高或者对于业务逻辑重要的部分。</li><li data-pid="p8hTovAu">对重构友好。测试应该对可观测的领域行为进行测试与验证，而不是对于实现细节。因为实现细节是很容易被重构影响的，在软件行为没有发生改变时，不应该需要对测试代码做修改，减少测试失败的误报。</li><li data-pid="9nyQmqQ8">快速反馈。测试跑得越快，我们就越可以频繁执行，实时发现问题，降低修复成本。</li><li data-pid="gd39jT6q">可维护性。包括是否容易理解测试代码，是否容易执行测试。</li></ul><p class="ztext-empty-paragraph"><br></p><figure data-size="normal"><noscript>&lt;img src="https://pic1.zhimg.com/v2-4ae767775457e93eace4956ba6b8eac0_b.jpg" data-size="normal" data-rawwidth="2010" data-rawheight="990" class="origin_image zh-lightbox-thumb" width="2010" data-original="https://pic1.zhimg.com/v2-4ae767775457e93eace4956ba6b8eac0_r.jpg"/&gt;</noscript><div><img src="data:image/svg+xml;utf8,&lt;svg xmlns='http://www.w3.org/2000/svg' width='2010' height='990'&gt;&lt;/svg&gt;" data-size="normal" data-rawwidth="2010" data-rawheight="990" class="origin_image zh-lightbox-thumb lazy" width="2010" data-original="https://pic1.zhimg.com/v2-4ae767775457e93eace4956ba6b8eac0_r.jpg" data-actualsrc="https://pic1.zhimg.com/v2-4ae767775457e93eace4956ba6b8eac0_b.jpg" data-original-token="v2-8261f57525f5f3b168dfb02bb9a68d6c"></div><figcaption>提升测试的“准确率”</figcaption></figure><p class="ztext-empty-paragraph"><br></p><p data-pid="QPN67mEb">其中前两点分别对应了测试中的 false negative（测试没有报错，但其实有 bug）和 false positive（测试报错了，但其实没有 bug）这两类情况。对于成熟项目来说，因为测试的数量会非常大，重构的频率也会更高，所以控制 false positive 一般会更加重要。反复出现 false alarm，会很快让开发者丧失对测试的信任，从而失去其存在价值。</p><p data-pid="a3GvyNkF">我们可以对上述四条标准打个分，而总体的测试价值是这四个得分的乘积。这意味着如果有任意一个维度得分为零，那么整体测试的价值就会迅速降到零。</p><p data-pid="WKzFvyUk">是否存在完美的测试呢？其实上面提到的前三点之间，是有一些互斥性的，需要做一些权衡。举例来说：</p><ul><li data-pid="MWpqZ1cS">端到端测试有非常好的预防 regression 能力，并且对重构友好，但执行速度很慢。同时端到端测试也不好维护。</li><li data-pid="4b3kio0G">无关紧要的测试满足重构友好和快速反馈，但对预防 regression 作用不大，例如用户名密码验证这类非常简单的逻辑。</li><li data-pid="gIr7IoSp">脆弱（过于敏感）的测试可以预防 regression 并快速执行，但对重构不友好。例如检查非常具体的实现逻辑没有发生变化。</li></ul><p class="ztext-empty-paragraph"><br></p><figure data-size="normal"><noscript>&lt;img src="https://pic1.zhimg.com/v2-c2af648ca7dc4844622c6962f660d8f0_b.jpg" data-size="normal" data-rawwidth="1770" data-rawheight="1342" class="origin_image zh-lightbox-thumb" width="1770" data-original="https://pic1.zhimg.com/v2-c2af648ca7dc4844622c6962f660d8f0_r.jpg"/&gt;</noscript><div><img src="data:image/svg+xml;utf8,&lt;svg xmlns='http://www.w3.org/2000/svg' width='1770' height='1342'&gt;&lt;/svg&gt;" data-size="normal" data-rawwidth="1770" data-rawheight="1342" class="origin_image zh-lightbox-thumb lazy" width="1770" data-original="https://pic1.zhimg.com/v2-c2af648ca7dc4844622c6962f660d8f0_r.jpg" data-actualsrc="https://pic1.zhimg.com/v2-c2af648ca7dc4844622c6962f660d8f0_b.jpg" data-original-token="v2-1978bcd69f9620d141141ce7bc2d7c5d"></div><figcaption>测试价值的取舍</figcaption></figure><p class="ztext-empty-paragraph"><br></p><p data-pid="euW8Cep2">考虑到实际中，是否重构友好往往是个非零即一的选项，所以一般无法在这一点上做妥协，我们只能在剩下的两点里做选择。例如 e2e 测试会更偏向防止代码功能失效，而典型的单元测试则更偏向于快速反馈。</p><h3>测试的种类</h3><p data-pid="vzeM851n">既然聊到了不同测试在测试价值上的取舍，那自然就引出了不同测试的类型的问题。很多同学都会问，到底什么才算是单元测试？是测试一个具体的函数/方法，还是测试一个具体的类？这个粒度要有多细才能算单元测试呢？</p><p data-pid="YpuG7UKV">个人认为有两种定义比较好理解和执行：</p><ul><li data-pid="4_rZdxwL">单元指的应该是“业务功能单元”而不是类或者方法。为了实现一个业务功能，具体的实现，类和方法的拆分粒度都是在过程中可以重构的，测试本身不应该受到实现细节的影响，否则会变得支离破碎，难以理解和维护。</li><li data-pid="PcaCgaTf">Google 软件工程的书中提到，他们把测试分成单个进程，单台机器，多台机器这三种类型。其中单元测试基本对应的是单进程中执行的小型测试。如果我们依赖了真实的数据库实例，那么显然就是跨进程了。</li></ul><p data-pid="jO-3wH_6">这两种定义下的单元测试都有比较明确的特点，如：</p><ul><li data-pid="uHno2C0q">每个测试验证一个业务单元的执行。</li><li data-pid="nuyYIxXd">能够快速运行。</li><li data-pid="tyosY5Ai">测试之间相互独立，可以同时运行多个测试而不会互相影响。</li></ul><p data-pid="PBWiWaTB">在这个基础上，集成测试会引入外部的依赖进行验证。而端到端测试可以算是集成测试的最极端的情况，完全使用真实组件来完成测试，例如直接在网页端进行点击操作，验证结果。Google 提到的中型和大型测试也基本可以对应上这两类测试。</p><p class="ztext-empty-paragraph"><br></p><figure data-size="normal"><noscript>&lt;img src="https://pic3.zhimg.com/v2-4209e3b2bfc0d86fd8ae4a0a9316a066_b.jpg" data-size="normal" data-rawwidth="1960" data-rawheight="1524" class="origin_image zh-lightbox-thumb" width="1960" data-original="https://pic3.zhimg.com/v2-4209e3b2bfc0d86fd8ae4a0a9316a066_r.jpg"/&gt;</noscript><div><img src="data:image/svg+xml;utf8,&lt;svg xmlns='http://www.w3.org/2000/svg' width='1960' height='1524'&gt;&lt;/svg&gt;" data-size="normal" data-rawwidth="1960" data-rawheight="1524" class="origin_image zh-lightbox-thumb lazy" width="1960" data-original="https://pic3.zhimg.com/v2-4209e3b2bfc0d86fd8ae4a0a9316a066_r.jpg" data-actualsrc="https://pic3.zhimg.com/v2-4209e3b2bfc0d86fd8ae4a0a9316a066_b.jpg" data-original-token="v2-de86b2187ebb7182bb8c1b7f976761d4"></div><figcaption>测试的不同种类</figcaption></figure><p class="ztext-empty-paragraph"><br></p><p data-pid="xikaYFug">有了这三种测试的分类，就可以引出很多人都听说过的经典测试金字塔了：</p><p class="ztext-empty-paragraph"><br></p><figure data-size="normal"><noscript>&lt;img src="https://pic1.zhimg.com/v2-bc8cba1fa7639cb5f2eb824e74e16654_b.jpg" data-size="normal" data-rawwidth="1492" data-rawheight="1266" class="origin_image zh-lightbox-thumb" width="1492" data-original="https://pic1.zhimg.com/v2-bc8cba1fa7639cb5f2eb824e74e16654_r.jpg"/&gt;</noscript><div><img src="data:image/svg+xml;utf8,&lt;svg xmlns='http://www.w3.org/2000/svg' width='1492' height='1266'&gt;&lt;/svg&gt;" data-size="normal" data-rawwidth="1492" data-rawheight="1266" class="origin_image zh-lightbox-thumb lazy" width="1492" data-original="https://pic1.zhimg.com/v2-bc8cba1fa7639cb5f2eb824e74e16654_r.jpg" data-actualsrc="https://pic1.zhimg.com/v2-bc8cba1fa7639cb5f2eb824e74e16654_b.jpg" data-original-token="v2-c03380d6e10f43700dfa6f777c2a2361"></div><figcaption>测试金字塔</figcaption></figure><p class="ztext-empty-paragraph"><br></p><p data-pid="FbNE6sDO">由于单元测试本身专注于足够小的业务单元，执行又快，而且没有外部依赖更加稳定，因此很自然的一个想法就是在可能的情况下，都应该使用单元测试来覆盖功能验证。</p><p data-pid="IdT0HZxi">例如一个系统有 3 个模块，每个模块又有 10 种不同的场景，如果我们只能通过端到端集成测试来做，需要的测试用例可能就需要 10 * 10 * 10 这个量级。而且不同的场景可能需要复杂的准备，例如有些需要保持数据库里没有数据，有些又需要预先有些数据，有些还需要特定组件抛出错误等。这些准备工作进一步加大了测试准备所需要的耗时，同时也会让这些测试之间很难共享依赖并发执行。集成测试还可能碰到环境不稳定的问题，也容易提升测试误报的可能。种种问题叠加起来，也不难理解即使集成测试会使用更多的“真实组件”，但在实践过程中仍然不是一个好的选择。</p><p data-pid="m9uxsU8W">当然测试金字塔也有例外情况，例如业务逻辑越简单，则单元测试能发挥的作用就越小。或者外部依赖较少，使用真实依赖的成本较低时，也可以增加集成测试的数量。所以不同项目的测试金字塔构成比例也会因项目特性而有所不同。</p><h3>什么是测试替代</h3><p data-pid="2UyVGuM1">为了在更多的场景下能够使用单元测试来覆盖场景，我们就需要引入一些测试替代（test doubles）来帮助我们模拟外部依赖。很多书里会区分 dummy，stub，fake，mock，spy 等概念，再加上很多框架自己就叫 mockxxx，经常让人看的有些云里雾里不明所以。</p><p data-pid="ajWLPIrX">Unit Testing 这本书里给出了很系统化的分类方法，主要就分成两类：</p><ul><li data-pid="9It9JSrh">自内向外调用的模拟和检查，称为 mock。例如系统在用户注册成功后会发送一封邮件，那么我们需要检查是否调用了邮件服务来确认这个行为。</li><li data-pid="5d8QFtk1">自外向内获取的模拟，称为 stub。例如从数据库中查询某个用户的信息，我们只需要模拟返回信息即可，不需要去检查是否真的做了数据库调用。</li></ul><p class="ztext-empty-paragraph"><br></p><figure data-size="normal"><noscript>&lt;img src="https://pic3.zhimg.com/v2-3a789efb78acd3e92974c7a7515e8ff6_b.jpg" data-size="normal" data-rawwidth="2234" data-rawheight="1020" class="origin_image zh-lightbox-thumb" width="2234" data-original="https://pic3.zhimg.com/v2-3a789efb78acd3e92974c7a7515e8ff6_r.jpg"/&gt;</noscript><div><img src="data:image/svg+xml;utf8,&lt;svg xmlns='http://www.w3.org/2000/svg' width='2234' height='1020'&gt;&lt;/svg&gt;" data-size="normal" data-rawwidth="2234" data-rawheight="1020" class="origin_image zh-lightbox-thumb lazy" width="2234" data-original="https://pic3.zhimg.com/v2-3a789efb78acd3e92974c7a7515e8ff6_r.jpg" data-actualsrc="https://pic3.zhimg.com/v2-3a789efb78acd3e92974c7a7515e8ff6_b.jpg" data-original-token="v2-22ddf2d07f8782fdfd86549676c1f2ab"></div><figcaption>测试替代的不同类型</figcaption></figure><p class="ztext-empty-paragraph"><br></p><p data-pid="ugm_Jcu8">为什么 mock 需要做调用的检查，而 stub 却不需要呢？这又回到了我们之前提到过的对重构友好的重要原则：应该测试可观测的行为状态，而不是实现细节。对外发送一封邮件，这件事情最终是会被用户感受到的，所以属于“可观测的行为状态”，需要进行检查。而从数据库中获取用户信息，则不属于用户可以观测到的行为，而是实现细节。我们完全可以改成从不同的数据库中获取，或者从缓存中获取等等其他实现方式。</p><p data-pid="3aNvfaXk">所以在这里，选择 mock 还是 stub 就有了个比较明确的标准：当被测组件向外调用的行为属于可观测行为状态时，才使用 mock，其它情况下使用 stub 即可。</p><p data-pid="OpNy9Pls">不过问题到这里也还没结束，两本书中都提到了对于测试替代，业界还有两种不同的流派，分别是伦敦派与经典派。前面提到单元测试应该是相互隔离可以独立运行的，而这两个流派之间的主要分歧就在于对测试隔离范围的区别。</p><p data-pid="8TZMiN_Y">对于测试的外部依赖，我们可以分为两大类，分别是共享和私有。对于共享的依赖，如数据库，消息队列，第三方 API 需要被独立开来（测试替代），使得测试可以独立执行。这点对于两个流派来说都是一致的。</p><p data-pid="OYRqUsbZ">而私有依赖这部分，又可以区分为可变依赖和只读依赖。例如我当前正在测试用户购买行为，其中涉及到两个外部依赖，一个是商品，一个是库存。当进行购买时，商品只提供名称信息，是个只读对象；而库存则需要在购买成功后进行库存扣减操作，是个可变对象。这里就出现了两种流派的区别：伦敦派会替代掉私有依赖中的可变对象，而经典派则倾向于在私有依赖中都使用真实对象而不是测试替代。</p><p class="ztext-empty-paragraph"><br></p><figure data-size="normal"><noscript>&lt;img src="https://pic1.zhimg.com/v2-9714b6c5d61c8b64f3a92f926422c168_b.jpg" data-size="normal" data-rawwidth="1912" data-rawheight="1264" class="origin_image zh-lightbox-thumb" width="1912" data-original="https://pic1.zhimg.com/v2-9714b6c5d61c8b64f3a92f926422c168_r.jpg"/&gt;</noscript><div><img src="data:image/svg+xml;utf8,&lt;svg xmlns='http://www.w3.org/2000/svg' width='1912' height='1264'&gt;&lt;/svg&gt;" data-size="normal" data-rawwidth="1912" data-rawheight="1264" class="origin_image zh-lightbox-thumb lazy" width="1912" data-original="https://pic1.zhimg.com/v2-9714b6c5d61c8b64f3a92f926422c168_r.jpg" data-actualsrc="https://pic1.zhimg.com/v2-9714b6c5d61c8b64f3a92f926422c168_b.jpg" data-original-token="v2-ccea31e469d70a473156628d2c631ebf"></div><figcaption>伦敦派与经典派的区别</figcaption></figure><p class="ztext-empty-paragraph"><br></p><p data-pid="tjN6Y9E3">在 Google 的那本书中，也提到他们对于测试替代的态度在两者之间游走。当前他们更倾向于完全不使用 mock，偶尔考虑使用 stub/fake，主要原因也是怕过多依赖 mock 会有 over specification 的问题（例如检查具体发出的邮件是什么），使得测试变得更加脆弱。可以说他们的实践是一种更加严格的经典派做法。</p><h3>如何看待覆盖率</h3><p data-pid="qogQHSsn">前面提到测试的价值标准，很多人可能会想到代码覆盖率这个经常被提起的概念。这里的覆盖率又分成好几种，包括：</p><ul><li data-pid="YxhFZpF2">代码行覆盖</li><li data-pid="rOPapQQP">分支/条件覆盖</li><li data-pid="f78SWLcn">执行路径覆盖</li></ul><p data-pid="1jSQzC5K">不过目前绝大多数工具提供的还是代码行覆盖，辅助会带一些条件覆盖的指示（部分条件覆盖会显示黄色）。所以我们一般讨论的也是以行覆盖率指标为主。</p><p data-pid="oXUBXB59">覆盖率本身与测试价值是一个相关性指标，我们总体的评判标准是：低的代码覆盖率，一般来说是不好的，但高的代码覆盖率并不一定表示测试是优秀的。例如极端的例子如果测试中只有逻辑执行，没有 assertion 检查，那么 100% 覆盖率也是没有意义的。同理回到前面测试价值的评判标准，如果某些逻辑简单，或者非核心业务逻辑的代码，我们可能也没有必要去追求高覆盖率。</p><h2>软件测试最佳实践</h2><p data-pid="_DMAHNLr">前面梳理了一下软件测试的基本概念，接下来我们来看下一些最佳实践，具体怎么来写高价值的自动化测试，以及测试本身对于优良架构设计的促进作用。</p><h3>单元测试的构成</h3><p data-pid="C65q1t90">一般来说，单元测试的构成分三个部分：</p><ul><li data-pid="hRVpKYtN">Arrange：把被测对象和环境依赖设置到目标状态。</li><li data-pid="_t1cSvJz">Act：调用被测对象的方法，执行操作。</li><li data-pid="y4tFKp79">Assert：验证结果的正确性，包括返回值，被测对象的状态，与外界的预期交互行为等所有属于可观测行为状态的内容。</li></ul><p data-pid="S-rclgyb">Given-When-Then 模式与上述的 AAA 模式是等价的。</p><p data-pid="NTXv2QLj">一般来说，一个单测里应该只有一组 AAA 的流程，保证验证场景的聚焦与清晰。在集成测试中，可能一些环境的 arrange 开销会比较大，所以有时候会考虑将之前的 arrange/act 给后续操作复用，例如先创建用户，验证用户创建成功，然后继续验证该用户的其它操作场景。</p><p data-pid="8FTqxzaX">写测试中经常碰到的一个问题是 arrange 部分比较复杂，可以考虑引入一些设计模式，例如 object mother 和 test data builder 等，抽取一些共用方法来提效。这也属于对 test infra 的投入，会提升开发者写测试的效率。单元测试一般不太需要公共的 setup 和 teardown，共享的 arrange 可能会导致测试间的高度耦合，破坏测试之间的独立性。但在集成测试中很多 setup 是可能共用的，而且集成测试一般没法并行执行，可以在集成测试的基类中定义这些可复用的 fixture。</p><p data-pid="B2jid6g9">Act 部分一般一行代码调用就足够了，如果发现这部分的代码行数比较多，需要注意是否是 public API 的设计有问题。还是以测试购买行为为例，如果在操作时需要分别调用购买操作和库存扣减操作，那么显然就破坏了封装性。如果客户端只调用了购买，而忘了调用库存扣减，就会导致状态的不一致（invariant violation）。</p><p data-pid="dJ1rv4D2">Assertion 部分倒没有严格要求只用一行调用来验证，因为可观测的行为状态可能是多方面的，例如返回值，对象状态，外部调用行为等。要注意我们应该对可观测行为和状态进行检查，而不是实现细节。例如我们对返回 json 结构做原封不动的检查，可能就是不太好的实践，其中可能有些信息属于实现细节，这部分做重构优化时就很容易 break 测试。</p><p class="ztext-empty-paragraph"><br></p><figure data-size="normal"><noscript>&lt;img src="https://pic4.zhimg.com/v2-d43cb5f72371734c0f51eab15ff79ae3_b.jpg" data-size="normal" data-rawwidth="2252" data-rawheight="992" class="origin_image zh-lightbox-thumb" width="2252" data-original="https://pic4.zhimg.com/v2-d43cb5f72371734c0f51eab15ff79ae3_r.jpg"/&gt;</noscript><div><img src="data:image/svg+xml;utf8,&lt;svg xmlns='http://www.w3.org/2000/svg' width='2252' height='992'&gt;&lt;/svg&gt;" data-size="normal" data-rawwidth="2252" data-rawheight="992" class="origin_image zh-lightbox-thumb lazy" width="2252" data-original="https://pic4.zhimg.com/v2-d43cb5f72371734c0f51eab15ff79ae3_r.jpg" data-actualsrc="https://pic4.zhimg.com/v2-d43cb5f72371734c0f51eab15ff79ae3_b.jpg" data-original-token="v2-62f038c020f61352c697cba19b9ffda7"></div><figcaption>不要验证实现细节</figcaption></figure><p class="ztext-empty-paragraph"><br></p><p data-pid="Bwbl7Gtd">另外要注意的是当 assertion 失败时的报错信息是否友好，很多时候只看到一个 expected False actual True 这样的信息显然是很难理解和定位问题的。有一些类似 AssertJ 的库可以帮助我们提升代码本身的可读性以及报错/callstack 的友好性。</p><p data-pid="sqLoq0BJ">除了结构外，也需要格外注意测试代码的可读性，包括测试函数的命名应该更贴近场景描述的自然语言，而不是跟具体的类名、方法名挂钩。同时也需要考虑减少重复代码，其它变量名，方法名的可读性等，这个跟功能代码是一致的。Google 的书中提到测试代码应该逻辑简单，不要有 if，for 循环这类，甚至可以允许一定的代码重复，一切以可理解性为前提。个人同意尽量减少测试代码的圈复杂度，但还是觉得也需要考虑一下可维护性，抽取一些共用方法，使用 property based 测试等。除了验证功能是否正常，可读性良好的测试也可以作为一种可以执行的文档帮助新人快速上手项目。</p><h3>如何系统性地写测试</h3><p data-pid="Ie3HOz2T">Effective Software Testing 中，给出了系统化的进行测试的步骤：</p><p class="ztext-empty-paragraph"><br></p><figure data-size="normal"><noscript>&lt;img src="https://pic4.zhimg.com/v2-e993a03bb248efbd947491c84fa90303_b.jpg" data-size="normal" data-rawwidth="2370" data-rawheight="1630" class="origin_image zh-lightbox-thumb" width="2370" data-original="https://pic4.zhimg.com/v2-e993a03bb248efbd947491c84fa90303_r.jpg"/&gt;</noscript><div><img src="data:image/svg+xml;utf8,&lt;svg xmlns='http://www.w3.org/2000/svg' width='2370' height='1630'&gt;&lt;/svg&gt;" data-size="normal" data-rawwidth="2370" data-rawheight="1630" class="origin_image zh-lightbox-thumb lazy" width="2370" data-original="https://pic4.zhimg.com/v2-e993a03bb248efbd947491c84fa90303_r.jpg" data-actualsrc="https://pic4.zhimg.com/v2-e993a03bb248efbd947491c84fa90303_b.jpg" data-original-token="v2-98ddfe619df58f83b4a9b346820a0462"></div><figcaption>系统化测试</figcaption></figure><p class="ztext-empty-paragraph"><br></p><p data-pid="45OqiIZi">主要关注右边方框里的内容。首先是基于软件的功能 spec 来开发测试：</p><p class="ztext-empty-paragraph"><br></p><figure data-size="normal"><noscript>&lt;img src="https://pic2.zhimg.com/v2-d3a0876dabb8272684d85265a6a06221_b.jpg" data-size="normal" data-rawwidth="2180" data-rawheight="594" class="origin_image zh-lightbox-thumb" width="2180" data-original="https://pic2.zhimg.com/v2-d3a0876dabb8272684d85265a6a06221_r.jpg"/&gt;</noscript><div><img src="data:image/svg+xml;utf8,&lt;svg xmlns='http://www.w3.org/2000/svg' width='2180' height='594'&gt;&lt;/svg&gt;" data-size="normal" data-rawwidth="2180" data-rawheight="594" class="origin_image zh-lightbox-thumb lazy" width="2180" data-original="https://pic2.zhimg.com/v2-d3a0876dabb8272684d85265a6a06221_r.jpg" data-actualsrc="https://pic2.zhimg.com/v2-d3a0876dabb8272684d85265a6a06221_b.jpg" data-original-token="v2-93f15c2af32c194e7174e9b2339407a2"></div><figcaption>Spec Testing</figcaption></figure><p class="ztext-empty-paragraph"><br></p><p data-pid="3UZEhmzx">个人理解具体展开包括：</p><ul><li data-pid="t_bSgx-k">识别程序的每一个输入参数，它的类型是什么，可能的范围，特殊取值等。</li><li data-pid="NMIbAmbA">识别参数之间的相互关系，思考其可能的组合情况有哪些。</li><li data-pid="2-PEnd21">识别程序的输出，其类型，可能的范围，特殊值等，反推需要覆盖的情况。</li><li data-pid="sB3J-ITh">识别代码中的各种边界条件，及相关的组合情况。</li><li data-pid="ZI92mnic">基于业务定义 spec，针对上述的 case 进行发散性思考，查漏补缺。</li></ul><p data-pid="JGN3Mw70">这里尤其重要的是特殊值与边界条件的分析，也是最容易出现 bug 的地方。例如判断条件是<code>x &gt;= 10</code>，那么就需要在<code>x = 10</code>和<code>x = 11</code>这两个边界点上分别构造测试用例。</p><p data-pid="KcXbsrvI">完成 spec testing 步骤后，我们可以进一步引入 structual testing，即前面提到的代码行覆盖的分析，辅助我们去完善测试用例。</p><p class="ztext-empty-paragraph"><br></p><figure data-size="normal"><noscript>&lt;img src="https://pic1.zhimg.com/v2-8d55cebadea50b2df2db6666bddf57a8_b.jpg" data-size="normal" data-rawwidth="1834" data-rawheight="992" class="origin_image zh-lightbox-thumb" width="1834" data-original="https://pic1.zhimg.com/v2-8d55cebadea50b2df2db6666bddf57a8_r.jpg"/&gt;</noscript><div><img src="data:image/svg+xml;utf8,&lt;svg xmlns='http://www.w3.org/2000/svg' width='1834' height='992'&gt;&lt;/svg&gt;" data-size="normal" data-rawwidth="1834" data-rawheight="992" class="origin_image zh-lightbox-thumb lazy" width="1834" data-original="https://pic1.zhimg.com/v2-8d55cebadea50b2df2db6666bddf57a8_r.jpg" data-actualsrc="https://pic1.zhimg.com/v2-8d55cebadea50b2df2db6666bddf57a8_b.jpg" data-original-token="v2-4e9f220e7760ff850db80716f931f156"></div><figcaption>Structual Testing</figcaption></figure><p class="ztext-empty-paragraph"><br></p><p data-pid="TLJym2o-">通过代码行覆盖工具（例如 IntelliJ 中自带的，或者 JaCoCo 等），可以检查我们当前的测试用例覆盖度情况。对于还没有覆盖到的部分，分析是否需要添加用例来进行覆盖。我个人的标准是对于领域核心文件，一般要求达到 100% 的覆盖率。</p><p data-pid="UC5gIjFu">在高代码覆盖率的基础上，我们还可以引入 mutaition testing。这是一个很有意思的技术，通过分析代码结构，去随机对功能代码做出修改，然后再执行相关的测试用例。如果修改后的代码（称为变种人）导致测试失败了，那么说明测试对于预防代码功能失效有着比较高的覆盖率。而如果修改后的代码如果还是成功跑通了，那就有可能说明测试用例不够完善。</p><p class="ztext-empty-paragraph"><br></p><figure data-size="normal"><noscript>&lt;img src="https://pic4.zhimg.com/v2-fda912bc7533fb3a12020925e9e5cc67_b.jpg" data-size="normal" data-rawwidth="2562" data-rawheight="1172" class="origin_image zh-lightbox-thumb" width="2562" data-original="https://pic4.zhimg.com/v2-fda912bc7533fb3a12020925e9e5cc67_r.jpg"/&gt;</noscript><div><img src="data:image/svg+xml;utf8,&lt;svg xmlns='http://www.w3.org/2000/svg' width='2562' height='1172'&gt;&lt;/svg&gt;" data-size="normal" data-rawwidth="2562" data-rawheight="1172" class="origin_image zh-lightbox-thumb lazy" width="2562" data-original="https://pic4.zhimg.com/v2-fda912bc7533fb3a12020925e9e5cc67_r.jpg" data-actualsrc="https://pic4.zhimg.com/v2-fda912bc7533fb3a12020925e9e5cc67_b.jpg" data-original-token="v2-11cf071e2a76591a66a7fd60827a8bc0"></div><figcaption>Mutation Testing</figcaption></figure><p class="ztext-empty-paragraph"><br></p><p data-pid="1LwILMOV">一般来说这三个步骤下来，我们的单元测试覆盖应该已经能达到一个及格线以上的水平了。后续像发现 bugfix 应该同步带上相关的单元测试等也是很多项目的常规做法，在此就不多做赘述。关于集成测试和端到端测试，我们放到后面再展开。</p><h3>测试与代码设计的关系</h3><p data-pid="kkqC4e5t">前面我们已经提到很多次，如果发现测试不好写，可能跟代码设计不够好有关系。还有一些常见的问题包括，我是否应该测试 private API？什么情况下我应该用单元测试来覆盖，什么时候应该写集成测试？接下来我们就来展开看下这个话题。</p><p data-pid="F_khuJBA">现代软件工程的两个重要目标是控制软件整体的复杂度和快速获取反馈适应变化。前面我们看到测试可以在获取反馈方面给我们提供巨大的帮助，而且事实上测试对于控制复杂度方面也有很大的作用。</p><p data-pid="ZP76mt0G">很多同学在写测试时会碰到一个问题，被测对象的依赖非常多，需要把它构建出来就很困难。这可能是我们在设计这个类时，没有很好地遵循单一职责原则。一个类如果要做太多事情，不够内聚，那么很可能就会变成一个边界模糊的“大杂烩”，依赖了一堆其它类来完成各不相同的工作，导致系统的耦合度也过高。对于我们的核心领域模型来说，应该尽可能做清晰的职责划分，减少依赖交互方。</p><p data-pid="2Hsau-7s">也有同学会说，感觉 private API 比较复杂，需要做测试，但发现很多框架不支持 private API 的测试。这也是因为测试需要验证的应该是可观测行为和状态，而 private API 一般都属于实现细节，是很容易做重构改动的，那样的话测试的维护成本就会大大提高。如果发现 private API 很复杂，或者一个 public API 里涉及了很多步骤，其实也是缺乏单一职责设计的表象。可能更好的做法是把这些 private API 拆成单独的领域模型，去协同完成某个具体场景。</p><p class="ztext-empty-paragraph"><br></p><figure data-size="normal"><noscript>&lt;img src="https://pic4.zhimg.com/v2-073f8606ec6b95f0c6f8c2b9f891b6df_b.jpg" data-size="normal" data-rawwidth="2150" data-rawheight="692" class="origin_image zh-lightbox-thumb" width="2150" data-original="https://pic4.zhimg.com/v2-073f8606ec6b95f0c6f8c2b9f891b6df_r.jpg"/&gt;</noscript><div><img src="data:image/svg+xml;utf8,&lt;svg xmlns='http://www.w3.org/2000/svg' width='2150' height='692'&gt;&lt;/svg&gt;" data-size="normal" data-rawwidth="2150" data-rawheight="692" class="origin_image zh-lightbox-thumb lazy" width="2150" data-original="https://pic4.zhimg.com/v2-073f8606ec6b95f0c6f8c2b9f891b6df_r.jpg" data-actualsrc="https://pic4.zhimg.com/v2-073f8606ec6b95f0c6f8c2b9f891b6df_b.jpg" data-original-token="v2-05084f12b1c19301811d30f1b0c1b2f6"></div><figcaption>理想的 public/private API 区分</figcaption></figure><p class="ztext-empty-paragraph"><br></p><p data-pid="pOU9kNDj">另外像测试的验证比较复杂，不好写，可能也是类似的问题，没有做好职责分离和架构分层。举个极端的例子，我写了个<code>void</code>函数从头到尾把什么事情都做完了，那么自然要做 assertion 是件很困难的事情。</p><p data-pid="si6CvMC5">总结一下上面的问题，提出可测试性的几个直观要求：</p><ul><li data-pid="-39U_ulJ">代码应该遵循单一职责原则，每个模块负责自己领域的事情，边界清晰。</li><li data-pid="gJzXIwFv">模块具有良好设计的 API，能够实现可控制，可观测。例如行为调用有清晰明确的返回信息，对象的状态可以通过接口进行查询等。</li><li data-pid="GnI4RGI3">需要有良好的架构来管理内部依赖（领域模型之间）和外部依赖（infra，数据库，API 等）。</li></ul><p data-pid="2mrXpPHd">这就很自然引出了很多讲架构的书中的典型分层方式，如六边形架构，clean architecture 等。其主要思想就是架构的内层是领域模型，包含所有的业务逻辑。外层是 service/controller 层，负责与外界的交互以及串联领域模型调用，尽可能不带业务逻辑。依赖关系永远是外层依赖内层，而不是反过来。典型的例子如我们不应该在领域模型里去建立数据库连接，依赖外部的 infra。直观的理解例如数组这样的领域对象，可以有访问，追加等操作，但如果它还有个方法是写入数据库，就会感觉有些“违和”了。</p><p class="ztext-empty-paragraph"><br></p><figure data-size="normal"><noscript>&lt;img src="https://pic1.zhimg.com/v2-a7b97213f7d40b6118c3658abc41f9fc_b.jpg" data-size="normal" data-rawwidth="1802" data-rawheight="1264" class="origin_image zh-lightbox-thumb" width="1802" data-original="https://pic1.zhimg.com/v2-a7b97213f7d40b6118c3658abc41f9fc_r.jpg"/&gt;</noscript><div><img src="data:image/svg+xml;utf8,&lt;svg xmlns='http://www.w3.org/2000/svg' width='1802' height='1264'&gt;&lt;/svg&gt;" data-size="normal" data-rawwidth="1802" data-rawheight="1264" class="origin_image zh-lightbox-thumb lazy" width="1802" data-original="https://pic1.zhimg.com/v2-a7b97213f7d40b6118c3658abc41f9fc_r.jpg" data-actualsrc="https://pic1.zhimg.com/v2-a7b97213f7d40b6118c3658abc41f9fc_b.jpg" data-original-token="v2-bf8a004076aaba76ad933ff0933f156a"></div><figcaption>六边形架构</figcaption></figure><p class="ztext-empty-paragraph"><br></p><p data-pid="Omd-QB9o">书中还介绍了将这种风格推向极致的一种 functional architecture，把各类 side effects，exceptions，对内外部状态的依赖，都挪到业务逻辑的“外边缘”，让领域核心成为“纯函数”，也是控制代码复杂度的一种手段。不过这样做也会带来很多额外开销，例如性能和一些实现复杂度方面。</p><p data-pid="Eo0gLalk">可测试性会“强迫”我们做出更好的架构设计，反过来，我们也可以通过架构设计来思考测试的分类。从上面六边形架构的示意图中我们也可以看出来，对于 controller 层测测试来说，领域模型之间的交互就属于实现细节，是不需要进行测试的。这其实就天然区分了单元测试和集成测试所负责的范围。</p><p data-pid="mgbkptYQ">具体来说，我们以复杂度、领域相关度，和协作方（依赖）数量两个维度，来看领域模型与 controller 层的区别：</p><p class="ztext-empty-paragraph"><br></p><figure data-size="normal"><noscript>&lt;img src="https://pic1.zhimg.com/v2-e997ed0fee769eadd523f8df88f45cb8_b.jpg" data-size="normal" data-rawwidth="1874" data-rawheight="1082" class="origin_image zh-lightbox-thumb" width="1874" data-original="https://pic1.zhimg.com/v2-e997ed0fee769eadd523f8df88f45cb8_r.jpg"/&gt;</noscript><div><img src="data:image/svg+xml;utf8,&lt;svg xmlns='http://www.w3.org/2000/svg' width='1874' height='1082'&gt;&lt;/svg&gt;" data-size="normal" data-rawwidth="1874" data-rawheight="1082" class="origin_image zh-lightbox-thumb lazy" width="1874" data-original="https://pic1.zhimg.com/v2-e997ed0fee769eadd523f8df88f45cb8_r.jpg" data-actualsrc="https://pic1.zhimg.com/v2-e997ed0fee769eadd523f8df88f45cb8_b.jpg" data-original-token="v2-203b9ef7b316a2f17b4c7f073ae13f41"></div><figcaption>架构分层与对应的测试</figcaption></figure><p class="ztext-empty-paragraph"><br></p><p data-pid="N-By9KBf">这张图可以说是非常精髓了。我们前面提到的测试难写，很多都落到了职责划分，架构分层不够清晰上，所以产生了很多过于复杂的代码（右上角）。为了提升可测试性，我们应该通过重构，把复杂代码拆分成领域模型和 controller 层两部分，前者负责复杂业务逻辑，后者负责大量的编排工作。因为领域核心的依赖交互方少，所以比较好写单元测试，而且这部分测试的价值也会比较高。而 controller 层因为没有复杂业务逻辑，但交互依赖众多，所以可以通过少量的集成测试来进行覆盖。有些同学会有疑问，我要测试一个用户购买的场景，是不是同样的功能测试要在单元测试和集成测试写两遍呢？这里就给出了比较清晰的指导原则。</p><p class="ztext-empty-paragraph"><br></p><figure data-size="normal"><noscript>&lt;img src="https://pic4.zhimg.com/v2-f22c3d743a77c0e8da0647aec7ca8d73_b.jpg" data-size="normal" data-rawwidth="1882" data-rawheight="1420" class="origin_image zh-lightbox-thumb" width="1882" data-original="https://pic4.zhimg.com/v2-f22c3d743a77c0e8da0647aec7ca8d73_r.jpg"/&gt;</noscript><div><img src="data:image/svg+xml;utf8,&lt;svg xmlns='http://www.w3.org/2000/svg' width='1882' height='1420'&gt;&lt;/svg&gt;" data-size="normal" data-rawwidth="1882" data-rawheight="1420" class="origin_image zh-lightbox-thumb lazy" width="1882" data-original="https://pic4.zhimg.com/v2-f22c3d743a77c0e8da0647aec7ca8d73_r.jpg" data-actualsrc="https://pic4.zhimg.com/v2-f22c3d743a77c0e8da0647aec7ca8d73_b.jpg" data-original-token="v2-d9dd427afee85539a3011da999ed8b3e"></div><figcaption>测试的“分形”特质</figcaption></figure><p class="ztext-empty-paragraph"><br></p><p data-pid="8P5iaDI0">如果我们有比较良好的架构和职责划分，那么测试在不同层级上，是会具有这种“分形”特质的。书中还有一张图对 controller 层和领域模型层的特性给出了很形象的 code depth vs. width 说明：</p><p class="ztext-empty-paragraph"><br></p><figure data-size="normal"><noscript>&lt;img src="https://pic2.zhimg.com/v2-676a2bb986da4f1c635f92a27b2dc8f9_b.jpg" data-size="normal" data-rawwidth="2194" data-rawheight="1070" class="origin_image zh-lightbox-thumb" width="2194" data-original="https://pic2.zhimg.com/v2-676a2bb986da4f1c635f92a27b2dc8f9_r.jpg"/&gt;</noscript><div><img src="data:image/svg+xml;utf8,&lt;svg xmlns='http://www.w3.org/2000/svg' width='2194' height='1070'&gt;&lt;/svg&gt;" data-size="normal" data-rawwidth="2194" data-rawheight="1070" class="origin_image zh-lightbox-thumb lazy" width="2194" data-original="https://pic2.zhimg.com/v2-676a2bb986da4f1c635f92a27b2dc8f9_r.jpg" data-actualsrc="https://pic2.zhimg.com/v2-676a2bb986da4f1c635f92a27b2dc8f9_b.jpg" data-original-token="v2-5c2ee9336526615e18f351384125a445"></div><figcaption>Controller 与领域模型的职责划分</figcaption></figure><p class="ztext-empty-paragraph"><br></p><p data-pid="MpHt9evV">当然在现实情况中要比这个理想情况复杂很多，我们通常很难把业务逻辑清晰地切割成“获取信息→执行业务逻辑→写回数据”这样的三步，很多时候会在业务过程中动态判断要读取哪些信息或者要写入哪些信息。这时候有几种选项：</p><ul><li data-pid="y7mjSPwg">将决策过程切割成更细的步骤，在每个步骤保证信息读写处于 controller 层。</li><li data-pid="sTJVr3Nc">将外部依赖（数据读写）注入到领域模型里。</li><li data-pid="rft8mh7l">严格遵守把读写放在外围的方法，即使过程中不一定要用到的数据也都提前读取好。</li></ul><p data-pid="u8Gc1vPr">这里具体的判断选择也有几个评估标准：</p><ul><li data-pid="kJXYIeqW">Controller 层的逻辑简单性。上述第一种选项牺牲了这一点。</li><li data-pid="S013h1jb">领域模型的可测试性。第二种选项依赖注入牺牲了这一点。</li><li data-pid="MH7Vv_vw">性能。最后一种选项牺牲了这一点。</li></ul><p class="ztext-empty-paragraph"><br></p><figure data-size="normal"><noscript>&lt;img src="https://pic2.zhimg.com/v2-9a622703a89a3cdbd8d86ce78e665211_b.jpg" data-size="normal" data-rawwidth="2082" data-rawheight="1200" class="origin_image zh-lightbox-thumb" width="2082" data-original="https://pic2.zhimg.com/v2-9a622703a89a3cdbd8d86ce78e665211_r.jpg"/&gt;</noscript><div><img src="data:image/svg+xml;utf8,&lt;svg xmlns='http://www.w3.org/2000/svg' width='2082' height='1200'&gt;&lt;/svg&gt;" data-size="normal" data-rawwidth="2082" data-rawheight="1200" class="origin_image zh-lightbox-thumb lazy" width="2082" data-original="https://pic2.zhimg.com/v2-9a622703a89a3cdbd8d86ce78e665211_r.jpg" data-actualsrc="https://pic2.zhimg.com/v2-9a622703a89a3cdbd8d86ce78e665211_b.jpg" data-original-token="v2-afcd8a7a808fcb6b72eb477ec2863e78"></div><figcaption>现实世界的权衡</figcaption></figure><p class="ztext-empty-paragraph"><br></p><p data-pid="DbaqucCI">相比来说，性能和领域模型的可测性都比较重要。可以通过一些手段来管理 controller 的复杂度：</p><ul><li data-pid="fIeLI8A4">即使做决策步骤拆分，也要避免把业务逻辑检查放到 controller 层来做。这可能会导致领域模型的不一致性。例如 controller 检查是否可以重命名，再由领域模型执行。如果 controller 层忘了检查，那么就会出现非法的情况被执行。</li><li data-pid="X9JBkWZd">可以使用 CanExecute/Execute 模式，在领域模型里提供检查方法，controller 可以调用，且自身执行逻辑前也会做检查。</li><li data-pid="Fotm4oYK">Domain event 模式，将触发的操作放在 domain event 属性里，由 controller 或专门的 event dispatcher 去处理。相当于增加了一类协作交互对象，但没有提升 controller 的复杂度。</li></ul><p data-pid="_TfA8wLI">实在不可行的时候，再考虑把依赖注入到领域模型中。总体的原则还是尽量分离领域逻辑和编排这两种职责在整体架构的不同层去完成。</p><p data-pid="hy4WMNwO">既然提到了依赖注入，也顺带一提为了保证可测试性，也会天然要求我们做依赖注入，而不是在类的内部去自己创建对象。另外像时间，随机数等依赖，也可以通过显式依赖传入，提升可控制性。</p><p data-pid="Ph6_SxSn">而为了在测试中能够方便地 mock/stub 各种依赖，提升测试的重构友好度，也非常建议我们应该依赖抽象接口，而不是具体的实现。这显然也是良好架构设计的一大指引原则，可以降低耦合。当然这里也不是硬性规则，需要与“过度设计”进行权衡。</p><p class="ztext-empty-paragraph"><br></p><figure data-size="normal"><noscript>&lt;img src="https://pic2.zhimg.com/v2-076450ea2061f8f99e71d2c8c29556e9_b.jpg" data-size="normal" data-rawwidth="1948" data-rawheight="1036" class="origin_image zh-lightbox-thumb" width="1948" data-original="https://pic2.zhimg.com/v2-076450ea2061f8f99e71d2c8c29556e9_r.jpg"/&gt;</noscript><div><img src="data:image/svg+xml;utf8,&lt;svg xmlns='http://www.w3.org/2000/svg' width='1948' height='1036'&gt;&lt;/svg&gt;" data-size="normal" data-rawwidth="1948" data-rawheight="1036" class="origin_image zh-lightbox-thumb lazy" width="1948" data-original="https://pic2.zhimg.com/v2-076450ea2061f8f99e71d2c8c29556e9_r.jpg" data-actualsrc="https://pic2.zhimg.com/v2-076450ea2061f8f99e71d2c8c29556e9_b.jpg" data-original-token="v2-64fe77371a3002515cadcf3ca14fdbe7"></div><figcaption>依赖接口而不是具体实现</figcaption></figure><p class="ztext-empty-paragraph"><br></p><h3>TDD</h3><p data-pid="o8N4ZsMa">前面一大块阐述了测试对于代码设计的促进作用，也正是因为测试不仅帮助我们保证质量，甚至还能促进我们做出好的设计，所以自然又诞生出了测试驱动开发（TDD）的思想。这不仅仅是把测试放在前面先写这么简单，而是会整体的改变我们的思维与行动方式，带来很多优点：</p><ul><li data-pid="vqyuKjq7">根据需求先写测试，就是以需求为原点出发，先思考问题的抽象，而不是一上来考虑各种细节的技术手段选择。</li><li data-pid="JJFf0dT8">小批量，增量式开发，每次多通过一个测试。在不确定性的环境下，这种方式能提升我们学习的速度。其本身也是一种“关注点分离”的做法。</li><li data-pid="GmC-OBmd">快速的反馈，而不是等到全部写完再去检查是否有问题。</li><li data-pid="pNmIyPt8">可以提升代码的可测试性，因为从一开始就是先写测试。反之很容易以线性过程思考来写代码，没有可测试性的考量。</li><li data-pid="tpomlrgf">对代码设计的即时反馈。可测试性差的代码，往往设计上就存在问题。测试驱动强迫我们持续去“使用”代码，能及早发现问题。</li><li data-pid="eJqycn8S">事后写测试还有一个“陷阱”在于容易针对具体的实现去写，导致测试代码对于重构的友好程度降低。</li></ul><p data-pid="UAEQoGPi">当然也有一些例外情况，例如对于一次性使用的代码，不一定要写相关测试。如果对于需要写的功能已经非常熟悉，完全了解实现方法，也可以不用 TDD 的方式。</p><p data-pid="QEp-LpiI">总体来说，只要有测试的需求，即使不严格遵循 TDD，我们也应该尽可能缩短实现功能与写测试中间的时间间隔。不要写了一整天的功能代码，最后再去补测试。</p><p data-pid="f-gcXu5r">关于 TDD 的具体操作方式，可以参考 <a href="https://link.zhihu.com/?target=https%3A//youtu.be/nlGSDUuK7C4" class=" wrap external" target="_blank" rel="nofollow noreferrer">James Shore 的演示视频</a>。</p><h3>如何写大型测试</h3><p data-pid="VZ54PMnP">前面在架构分层对应的测试部分已经提到，对于 controller 层的测试，我们一般会通过集成测试的手段来覆盖。当然这里也有不同的选择，例如我们也可以 mock/stub 所有的外部依赖，用单元测试的方法来覆盖 controller 层。或者尽量使用真实的依赖来做集成测试。与单元测试相比，集成测试有以下特性：</p><ul><li data-pid="vjIBTyXo">劣势：执行速度慢，更加难以维护。包括外部依赖的运维，更多的外部依赖也需要更多的 arrange 操作，让测试本身变得臃肿。</li><li data-pid="oKiMjeqX">优势：测试覆盖到了更多的代码，不光是内部的，也包括第三方库，外部依赖等，对于 regression 的预防能起到更好的作用。测试的维度一般也更贴近终端用户，重构友好的程度也会比较高。</li></ul><p data-pid="W7B5TalO">前面也提到，controller 层一般是没有什么业务逻辑，但是依赖方众多，所以的确天然也更倾向于使用真实的依赖来做它的核心职责的验证。因此这里的取舍原则是，尽可能使用单元测试来覆盖各种复杂/边界场景，用集成测试来覆盖一条主要的 happy path（尽可能覆盖所有外部依赖），以及单元测试无法覆盖的边界场景。</p><p data-pid="cLguOFmt">集成测试中的外部依赖，也并不是完全不需要使用测试替代。我们可以从是否是应用自身管理的角度（典型特征就是看是否在同个代码 repo 里管理）来把它们分为两类：</p><ul><li data-pid="sQ3RZM7B">managed：例如应用自身的数据库，其它应用不会直接访问这个数据库。对调用方来说，这部分属于实现细节。因此集成测试中，推荐直接使用这些真实依赖。</li><li data-pid="9el134j0">unmanaged：例如外部 API，邮件服务，消息队列等。应用与这些依赖的交互要保证兼容性。对调用方来说，这部分是可观测的行为，需要通过 mock 来模拟和验证。这也是 mock 唯一推荐的使用场景，其它情况下对于实现细节做交互验证，会让测试变得脆弱。</li></ul><p class="ztext-empty-paragraph"><br></p><figure data-size="normal"><noscript>&lt;img src="https://pic2.zhimg.com/v2-456becfe192b90949f19df1ef31eb67d_b.jpg" data-size="normal" data-rawwidth="1714" data-rawheight="1328" class="origin_image zh-lightbox-thumb" width="1714" data-original="https://pic2.zhimg.com/v2-456becfe192b90949f19df1ef31eb67d_r.jpg"/&gt;</noscript><div><img src="data:image/svg+xml;utf8,&lt;svg xmlns='http://www.w3.org/2000/svg' width='1714' height='1328'&gt;&lt;/svg&gt;" data-size="normal" data-rawwidth="1714" data-rawheight="1328" class="origin_image zh-lightbox-thumb lazy" width="1714" data-original="https://pic2.zhimg.com/v2-456becfe192b90949f19df1ef31eb67d_r.jpg" data-actualsrc="https://pic2.zhimg.com/v2-456becfe192b90949f19df1ef31eb67d_b.jpg" data-original-token="v2-c6c16daae5eca6c0a99fe72d36553fd3"></div><figcaption>不同的外部依赖类型</figcaption></figure><p class="ztext-empty-paragraph"><br></p><p data-pid="51Wy10bu">集成测试的极端情况就是全部使用真实依赖的端到端测试。不过整体来说端到端测试的质量保障范围与典型的集成测试接近，因此数量会更少。Google 一书中也提到，他们的端到端大型测试，一般都是在生产环境跑的（可以结合一些灰度发布手段），用于保障部署发布本身没有问题。此外一些特定需求的测试，如性能，可扩展性，稳定性，安全测试等，也经常会使用端到端的测试方法。</p><p data-pid="1xjOfkeD">在自身管理的外部依赖方面，最常见的就是应用的数据库了。如何在集成测试中维护数据库呢？</p><ul><li data-pid="igkRbYxB">数据库 schema 的信息以及相关变更都应该通过 git 之类的管理起来。而不是大家共享某个具体的“标准测试数据库”。</li><li data-pid="AXATrq-B">Reference data（如一些映射关系）也应该是数据库 schema 的一部分。</li><li data-pid="QlLqz2qh">每个开发者都应该拥有自己独立的数据库 instance，集成测试本身就没法并发执行，共享数据库会碰到 schema，测试冲突等种种问题。</li><li data-pid="Sv1ksrvC">使用 migration based 方法（如 Flyway，Liquibase），而不是 state based 方法来维护数据库变化。</li><li data-pid="c7NIuA64">如何清理数据？最好的办法可能是在测试开始时执行清理。也可以选择每次测试前 restore 数据库，但会比较耗时。在测试结束后清理很多时候可能会没被执行到，例如测试挂掉，或者 debug 测试没有执行完等情况。</li><li data-pid="4Ni_r8Jl">尽量使用与真实生产环境相同的数据库，而不是为了测试跑的更快选择内存数据库来替代。</li></ul><p data-pid="oZx8Gx8D">最后总结一些大型测试的最佳实践：</p><ul><li data-pid="ThG9SMg5">明确 domain model 的边界。让代码更容易维护，也让测试更清晰，可以区分单元测试与集成测试。</li><li data-pid="Zb4pCMFC">减少应用中的 layer 数量。层次越多，可能需要的集成测试越复杂，但没有带来实质性的收益。</li><li data-pid="E6w12nfs">移除循环依赖。循环依赖会导致逻辑理解难度大大上升，对于测试也增加了接口抽象和 mock 的需求。</li><li data-pid="h_r1Hkie">即使在集成测试中，也尽量保证一个测试只验证一种情境，如创建用户和删除用户最好分成两个测试。只有在外部依赖的创建非常昂贵时，可以考虑在一个测试中做多个场景验证。</li><li data-pid="v1hJkyBX">大型测试的 setup 一般比较复杂，可以通过一些设计模式，第三方库来复用和简化代码，如 test data builder，<a href="https://link.zhihu.com/?target=https%3A//github.com/DiUS/java-faker" class=" wrap external" target="_blank" rel="nofollow noreferrer">java-faker</a> 等。</li><li data-pid="7ZtQgGPU">同样，大型测试的 assertion 也会比较复杂，需要设计可复用，易读的 assertion API，也可以使用 AssertJ 这类三方库。</li><li data-pid="zJVA9DHt">每次测试前做状态清理。这里可能涉及到为测试专门开发的 reset API，要千万小心不要放到线上。如果可以，最好避免这种特殊 API 的做法。</li><li data-pid="sB1wvY_j">注意 ROI 测算，例如撰写，执行，维护大型测试的开销如何，是否能找到 bug，是否已经被 UT 覆盖等。任何代码都是“负债”，没有价值的测试应该及时被删除。</li><li data-pid="yf4-uK6-">可以通过对测试 infra 的投入，降低一些大型测试的成本。</li></ul><p class="ztext-empty-paragraph"><br></p><figure data-size="normal"><noscript>&lt;img src="https://pic3.zhimg.com/v2-dc473ee926b8ef45ae1e361b2b87bb9a_b.jpg" data-size="normal" data-rawwidth="1836" data-rawheight="1458" class="origin_image zh-lightbox-thumb" width="1836" data-original="https://pic3.zhimg.com/v2-dc473ee926b8ef45ae1e361b2b87bb9a_r.jpg"/&gt;</noscript><div><img src="data:image/svg+xml;utf8,&lt;svg xmlns='http://www.w3.org/2000/svg' width='1836' height='1458'&gt;&lt;/svg&gt;" data-size="normal" data-rawwidth="1836" data-rawheight="1458" class="origin_image zh-lightbox-thumb lazy" width="1836" data-original="https://pic3.zhimg.com/v2-dc473ee926b8ef45ae1e361b2b87bb9a_r.jpg" data-actualsrc="https://pic3.zhimg.com/v2-dc473ee926b8ef45ae1e361b2b87bb9a_b.jpg" data-original-token="v2-0bf05f765956482f0e65c933adc9a125"></div><figcaption>减少应用的 layer 数量</figcaption></figure><p class="ztext-empty-paragraph"><br></p><h3>如何使用测试替代</h3><p data-pid="W9VC3Lvj">测试替代永远是测试实践中的一个重要主题，前面我们已经提到了一些重要原则，例如应该测试可观测的行为状态，而不是实现细节。所以只有集成测试才需要使用 mock，并且应该仅被用在 unmanaged 依赖上，其它情况使用 mock 都会让测试变得脆弱。</p><p data-pid="Lvc04DNg">延续这个思路，我们在验证与 unmanaged 依赖交互时，应该尽量在系统最外层的边界去做，这样能覆盖到更多的系统内部代码。</p><p class="ztext-empty-paragraph"><br></p><figure data-size="normal"><noscript>&lt;img src="https://pic3.zhimg.com/v2-5109a402c93ed03f62c20f641ac759be_b.jpg" data-size="normal" data-rawwidth="2004" data-rawheight="1800" class="origin_image zh-lightbox-thumb" width="2004" data-original="https://pic3.zhimg.com/v2-5109a402c93ed03f62c20f641ac759be_r.jpg"/&gt;</noscript><div><img src="data:image/svg+xml;utf8,&lt;svg xmlns='http://www.w3.org/2000/svg' width='2004' height='1800'&gt;&lt;/svg&gt;" data-size="normal" data-rawwidth="2004" data-rawheight="1800" class="origin_image zh-lightbox-thumb lazy" width="2004" data-original="https://pic3.zhimg.com/v2-5109a402c93ed03f62c20f641ac759be_r.jpg" data-actualsrc="https://pic3.zhimg.com/v2-5109a402c93ed03f62c20f641ac759be_b.jpg" data-original-token="v2-2ddb92911fdaa4fbc2c54d4afaa0f13d"></div><figcaption>Mock 位置的选择</figcaption></figure><p class="ztext-empty-paragraph"><br></p><p data-pid="HcllixkI">在 mock 验证交互行为时，应该跟其它 assertion 一样，越精确越好。不光要看是否发生了调用，还要看调用的次数是否正确，以及不应该做的调用没有发生等。</p><p data-pid="5t9F4fl0">放宽到测试替代整体来看，stub 使用的场景可能会更多一些，例如：</p><ul><li data-pid="6JR3jxw8">速度较慢的外部依赖。例如某个类需要进行大量计算才能返回结果。</li><li data-pid="k49A3CbG">基于外部 infra，如数据库，第三方 API 等。当然还是要注意，领域模型里应该尽量减少这些依赖。</li><li data-pid="6i1yxURE">难以模拟的状态，如需要让某些组件抛出错误异常。</li></ul><p data-pid="_7NLt0QW">对于测试替代整体来说，我们应该仅仅替代自己“拥有”的类型，而不是直接去模拟第三方库的类型和 API。因为这些第三方库是有可能发生变化的，我们也可能会选择切换第三方的实现。所以更好的方法是先做抽象封装，让我们的应用去依赖抽象好的接口，而不是某个具体实现。</p><p data-pid="OXiHsTVM">为了能在测试时灵活切换测试替代对象，需要使用依赖注入手段。这里有个选择，依赖注入是放在类构造方法里，还是放在其它方法的参数里？前者对于类本身的复杂度有所增加，但对于调用方来说会更加友好。多数情况下，我们还是选择让调用方更友好的方式。</p><h3>测试质量</h3><p data-pid="1vl0vZk0">测试的代码也是我们项目代码的一部分，因此测试本身的质量也非常重要。这里简单列举一些基本的评判原则：</p><ul><li data-pid="bba-Q8k8">测试应该执行速度较快。</li><li data-pid="fkpIZZiH">测试应该做到高内聚，互相独立，聚焦于某个场景。</li><li data-pid="tcNXpaaa">测试应该有一个存在的理由，为了预防 bug，而不仅仅是以提高代码覆盖率为目的。</li><li data-pid="SLsSCSBb">测试应该是稳定的，可重复执行，可复现的。谨慎引入外部依赖，各种超时设置等。不要与其他测试互相影响。</li><li data-pid="YSt-KMFY">测试应该有足够强的 assertion 覆盖。</li><li data-pid="1M471d4T">当被测对象行为发生变化时，测试应该失败。Mutation test 就是一个很好的检验方式。</li><li data-pid="V4KC-mdF">测试应该有且仅有一个明确的原因造成失败，便于定位问题和修复。</li><li data-pid="AXEOcfkp">测试应该易于撰写。需要对 test infra 有所重视与投入。</li><li data-pid="l3LrX1In">测试应该易于阅读和理解。使用有意义的命名，通过 fluent API 来增强可读性等。</li><li data-pid="iId2pf4v">测试应该易于修改和演进。</li></ul><p data-pid="eUlVvgpZ">一些不好的测试代码 smell 表现与“反模式”：</p><ul><li data-pid="Ewjd9RmB">过多的重复代码，增加了修改演进难度。</li><li data-pid="lPzOut8O">不明确的 assertion，报错信息不友好。</li><li data-pid="abK5Cwz7">没有处理好复杂的外部资源依赖，如数据库等。</li><li data-pid="NfGfh59i">大量继承过于 general 的 fixtures，会很难维护。</li><li data-pid="d6ZtbXr1">过于敏感的 assertion（针对实现细节），任何的代码改动都会让测试失败。</li><li data-pid="s6qY1qo4">测试私有方法。私有方法一般属于实现细节，而不是可观测的行为。测试私有方法会导致失去对重构的友好性，也是单元测试最重要的一个特性。如果发现 private 方法里有很复杂的业务逻辑，可以考虑做领域模型的拆分独立。</li><li data-pid="hBR6GcdC">基于私有属性做判断。同理，我们应该从业务的可观测行为角度进行判断，而不是把私有属性暴露出来。</li><li data-pid="nkr8n2lY">将领域知识引入到了测试中，极端的情况是在测试的 arrange 里直接把被测试代码的逻辑又复制了一遍过来。</li><li data-pid="x_deiPBI">代码污染，在生产代码中添加了只为测试用例服务的逻辑。更好的做法是在测试中去做接口的不同实现。</li><li data-pid="dH3pzAzk">Mock/stub 具体的类。往往违反了单一职责原则，建议将外部依赖拆出来接口化。</li></ul><h2>如何改进“遗留代码”</h2><p data-pid="m8u4YyZD">前面聊了很多测试的最佳实践，但绝大多数时候，我们接触的都是已有项目，不一定从一开始就注重单元测试这块的建设。对于没有测试覆盖的遗留代码，我们要如何入手呢？</p><p data-pid="HhJQ1JR2">这部分又是一个很大的话题，甚至有专门一本经典的书《<a href="https://link.zhihu.com/?target=https%3A//book.douban.com/subject/2248759/" class=" wrap external" target="_blank" rel="nofollow noreferrer">修改代码的艺术</a>》来讨论。这里我们就简单介绍一些基本步骤和方法。</p><p data-pid="UfhM9DNN">首先一个选择是，我们是否可以针对遗留代码来补充测试。这里测试的目标更多是希望保证原有系统在改造过程中不发生行为的变化，所以有个做法是先调用一下系统的功能，获取到输出后，就把这个输出作为检查点放到测试里。这种测试也被称为 characterization test。往往第一个测试是最难写的，因为要涉及到很多 setup，但有了第一个测试，在此基础上添加更多的用例就会相对容易不少。</p><p data-pid="10NTxgjS">但很多时候，由于一开始代码的设计并没有从可测试性角度出发思考，所以添加测试会非常的困难，而且写出来的测试在后续也有大概率会被修改掉。为了能让代码更容易进行测试，我们需要使用一些“安全重构”的手段来优化代码设计。很多 IDE 里都有这类功能的支持，如重命名，代码移动（拆分类），抽取方法等。注意在这个过程中只做搬运和重命名这类安全操作，不要同时修改逻辑，在没有测试覆盖情况下会很危险。</p><p data-pid="hH0A2oep">在遗留系统中添加新功能时，我们可以考虑创建一个新的类，同时对这个类加上单元测试。然后在旧有类中去调用这个新的类中的方法。以此来至少保证新功能是有测试覆盖的。</p><p data-pid="4-OnU103">如果还需要对旧有代码做持续的 bugfix 等改动，那么也必然需要对遗留代码做重构和测试的补充。我们可以使用一些第三方工具来分析项目整体的依赖关系图，寻找明显问题，切入进行改造。这里的方法也是常见的重构手段，抽取类或者接口，把外部依赖做注入，实现多个实例化方法，在旧的类和方法里去调用逐渐抽取出来的新的类和方法。重构本身是没有完美状态的，我们只需要保证每次提交都比之前进步一些就可以。具体的衡量指标可以参考代码的测试覆盖率，SonarQube 等静态代码检查的结果等。</p><p data-pid="2oJBzig1">最后，如何培养整体团队的意识，让所有人都开始重视，学习，并掌握测试技术也是非常关键的。对于所有的新功能，bugfix，重构，都应该要求带上相应的测试代码覆盖。同时也需要在研发流程中提升测试的结合程度，完善测试相关的基础设施，让测试更好写，更容易执行并查看结果，逐渐让大家意识到测试带来的巨大价值。在赋能和培训方面，把这篇文章转发给团队，可能也是一个不错的开始 :)</p></div></div></div></div><div class="Post-ReadMark"></div><div role="button" tabindex="0" class="ContentItem-time">编辑于 2022-12-15 09:25<!-- -->・IP 属地浙江</div></article><div class="KfeCollection-VipRecommendCard KfeCollection-VipRecommendCard-article Post-VipRecommendCard"><div class="KfeCollection-VipRecommendCard-title">有什么好看的追妻火葬场的小说推荐？</div><div class="KfeCollection-VipRecommendCard-author"><div class="KfeCollection-VipRecommendCard-author-avatar"><img src="https://pic3.zhimg.com/v2-7f52c46dbe2c4352454f9cca4c1ddda4.jpg"></div><div class="KfeCollection-VipRecommendCard-author-name">小尘</div></div><div class="KfeCollection-VipRecommendCard-content">我爱了一个男人十五年，他说只拿我当妹妹。为了让我死心，他做媒将我介绍给了他的朋友。可我真正和别的男人在一起后，他又反悔了。1.凌慬的白月光结婚了，我以为我有机会了。我在他家陪了他半个月，看着他烂醉如泥，看着他颓废落寞，看着他逐渐清醒。他在晨光中将我裹进被子里，四肢缠上来，拼尽全力一般紧紧拥住。我试图挣脱，他却压抑地说：「别动，小念。」小念。自从宋云念出现后，他就很久没有这么叫过我了。这个称呼成了她的专属。青梅敌不过天降。这是我每每想起都会感到窒息的事情，像被一只尖利的爪子扼住了心脏，进而拧住了我的咽喉。现在她退出了这段关系，我们终于可以在一起了。对吧。几天后，凌慬带我去见了他的朋友。他微微噙笑将我介绍给那人，说他虽然年轻，但人还不错，我们很合适。那时是在静吧，流转的灯光里，我望着他，他慢慢朝我瞧过来，面容是惯常的儒雅温和。我看见他眼里的内容，有刹那的怅然若失。那一刻，我感知到的不是难过，也不是恼怒他将我推给别人，而是平静到仿佛有什么抽空了我的情绪。这是他给我的交代。或者说，拒绝。他已经拒绝过我很多次了，多到我习以为常，不知什么时候起，我已经不会再为他的拒绝伤心，连些微的受挫感都没有了。我早已经不奢望他会爱我。在那一瞬间，我蓦然发觉，原来我对他的感情已经消失了。对面的男孩望着我，轻声说：「林念你好，我叫宋之恒。」和宋云念一个姓。我心想，一时间没有作声。他没有等到我的回应，长长的睫毛扇了扇，像是有些局促，紧接着又弯弯唇笑道：「是我拜托凌哥约你出来的，你不要生气。」我突然记起来，他是宋云念的弟弟，高二那年的暑假，我还做过他的英语家教。那时候，我害怕凌慬和宋云念走得太近，所以想方设法插入他们之间，为了能教好宋之恒留下来，每天不厌其烦地教他背单词记语法，他不肯背，我就在他耳边一遍一遍重复，每天早上拿着单词本去他家门口堵他，逼得他烦不甚烦，为了堵住我的嘴成绩提升得飞快。后来他似乎考上了一所不错的大学。我从记忆中抽回思绪，也微微笑道：「所以这顿酒的意思是，你想追我？」他的脸一下子红透了。凌慬在一旁望着我们，端起酒杯喝了一口。隔了一会儿，宋之恒才下定决心似的说：「可以吗？」我注意到凌慬放下酒杯，手指漫不经心地敲打着杯壁。宋之恒的视线滚烫，落在我脸上甚至有种被灼伤的错觉。我笑了笑，确定自己没有不甘或者类似于报复的情绪，平和地说：「那我们试试吧。」敲击杯壁的响声停了一下。宋之恒一滞，「试试？怎么试？」很快他又反应过来，红着脸说，「好……好。」我说：「谈恋爱这种事情我没有经验，所以先做朋友吧。」凌慬又喝了口酒，语气带笑，「的确，她没有经验。」轻描淡写的一句话，带过了我努力向他奔赴的十五年。三个人里，只有宋之恒没有喝酒，他说可以送我回家。凌慬叫了代驾，目送着我坐上宋之恒的副驾，他用开玩笑一般的语气说，我最缺乏安全感，所以和我在一起后，千万不要和别的女生有什么牵扯。我熟知他的个性，并不觉得他是在嘲讽，只是到了这一刻方才察觉。他对我，多少是有些歉疚的。这些年我的痛苦和焦虑，以及在宋云念面前刻入骨子的自卑，他并非一无所觉。只是那个女孩更重要罢了，他还没开始选择，内心就已经有了偏向。车子启动，凌慬后退几步，不知想到什么，抬头看了我一眼。驶出一段距离后，我从后视镜里看到他的身影，修长的身躯倚靠在车上，指间燃起一支烟，在夜色下闪着红亮的光。2.和宋之恒认识一周后，他牵了我的手，送我回家时在楼下亲了我。一个符合他年纪的，略带青涩的吻。然后想看又不敢看我，有些紧张地说：「明天见。」我心口的弦像被什么拨了一下，那种触动感让我有些恍惚。如果青春期时，我爱上的是这样一个男孩，可能一切都不一样。我反握住他温热的大手，盯着他的脸看了一会儿，笑道：「二十几岁的人谈恋爱，就这样？」他不知所以地望着我。「去我家坐坐吧。」宋之恒喉头动了一下。后来我发觉，这是他动情的表现。其实一开始，我并没有打算和他走多远。小我四岁的男孩，还是宋云念的弟弟，或许在青春懵懂时期对我有过微妙的好感，但实际接触下来，那点朦胧的好感并不能支持到他接受我的本来面目，包括我的大小缺点。但一回过头来，我们已经认识两个月了。他越来越多地占据了我的时间和生活，会提前问我晚饭想吃什么，下了班来公司接我，两个人一起去超市买菜，我负责洗他负责切和炒。有一次为了方便他找我要备用钥匙，我很自然地给他了。钥匙放到他手心里的时候，我们都愣了一下。他哑着嗓子问：「要不我搬过来吧？」我说不行。他马上说：「我开玩笑的。」然后小心翼翼地试探我，「那我可以搬到你隔壁吗？」我不置可否，谁知没过两天，他真的大包小包地搬进我隔壁那套空置了两年之久的房子，半夜灰扑扑地敲开门问我，他家燃气还没开通，能不能借我家浴室用一下。洗完秀色可餐地站在那里擦头发，说他家里太乱没地方睡，能不能借我家沙发睡一夜。还再三保证他什么都不会做的。我丢了一条毯子给他，他抱着睡了一夜，高高大大的男孩子蜷缩在我不足一米六的沙发上，显得有些可怜。我偷拍了下来，第二天在办公室看着照片忍不住笑了出来。同事揶揄我是不是谈恋爱了，最近看着开朗多了。有吗。不过我确实很久没有想到凌慬了，以前只是将这个名字与宋云念联系起来，心口就会涌起一股淡淡的郁痛。明明宋之恒是宋云念的弟弟，他们的眉眼那么相像。……这天吃晚饭时，宋之恒很可怜地问我，明天能不能陪他过生日。我这才知道凌慬妈妈的忌日和宋之恒的生日是同一天。往年这个时候，都是我陪着凌慬度过的。我会跟公司请假，备好食材敲开凌慬家的门，两个人一整天待在屋子里哪也不去，陪他说说话，看看电影，帮他把阳台上的绿植浇浇水，然后做好晚饭等他吃完，把毯子盖在他身上，看着沙发上的他逐渐睡去。凌慬妈妈的忌日，只有我和他记得。他有告诉过宋云念，但是宋云念并没有放在心上。母亲自杀给他带来的打击和创伤，在外人看来并不明显，那时候风传他妈是出轨方，差点抛夫弃子跟着奸夫去了美国，所以母亲死后，他照常上学上课，外表丝毫没有异常。但我知道他是悲伤的，他的每一个姿势和动作，甚至连微笑的表情，都浸透着悲伤。女生其实很容易被男人的脆弱打动。就是那个时候，我发觉自己喜欢上他了。我看着日历上标红的一点，默默删除了标记。今天我照例请了假，陪宋之恒和他的两个同学在王者峡谷遨游了一天，午餐还是点的外卖。傍晚，我接到了凌慬的电话，他略显疲惫地问我，为什么没有来。我说：「宋之恒要我陪他。」那头一下子没了声音，半晌凌慬才缓缓问我：「知不知道今天是什么日子？」我说：「我知道，但是今天是宋之恒生日。」意识到这样说可能过于冷漠，我深吸了一口气，换了个口吻安慰他，「你还好吧，难过的时候就出来走走，或者叫个朋友陪陪你。」良久，那头淡淡「嗯」了一声，挂断了。毕竟陪不了他一辈子。我想。3.隔天醒来的时候，我发现凌慬给我打了两通电话，时间显示是在凌晨 12 点和 2 点，那时我已经将手机调成静音，睡着了。我看着那两通未接来电，想起以前和凌慬闹别扭，都是我整夜整夜睡不着，心脏像一块被拧紧的脏抹布，又干又皱，又酸又涩，最后承受不住煎熬主动向他求和。我不敢给他打电话，只能反复斟酌词汇，小心翼翼地编辑成文字发给他，每一段话，每一个字眼都尽显无奈和卑微。以至于日后无论我们争吵的原因是什么，凌慬都习惯了我主动低头示弱，到时他再矜持地点点头，然后我们重归于好，恢复如初。可是昨夜我和宋之恒待到太晚，把他赶回自己家后我随便洗了个脸，就精疲力尽地睡着了。如果不是早上打开手机看到他的电话，我甚至忘记了昨天和他有过不愉快。我想了想，最终给他回了一条消息：昨天睡着了，有什么事吗？发完我起床洗漱化妆，再拿起手机时，才发现他回得比我想象中的快，只有三个字：没什么。再次和凌慬碰面是在朋友音乐餐吧的开业酒会上，我和凌慬的朋友大多是共通的，但是这个朋友却和他磁场不合，相互嫌弃，不止一次劝我不要在他这一棵树上吊死。所以凌慬会来，我略略有些意外。他看起来瘦了一些，端着酒杯站在离我不远的地方，张了张口，却没有发出声音。朋友往我手里塞了盘水果，揽着我的肩膀把我带到一边，「别理他，宋云念也来了。」朋友嘿嘿一笑，「我故意把她请来的。」我明白了什么。朋友碰了碰我肩膀，带点揶揄地说：「看，他们又凑到一块去了。」我转过头，看见身着淡雅长裙的宋云念主动走向他，凌慬站在原地，微垂着眼不知道在想什么，没有动弹。如果是以往的我，此刻估计会坐立难安，连手指都在难堪又无望地颤抖。我恨不得放在心口呵护的男孩，却在另一个女孩面前一再妥协、退让，他对她的放纵和宠溺，让我如鲠在喉，疼痛难抑，呼吸之间甚至能嗅到从喉管里溢出的血腥气。可现如今，除了一开始生出了些惆怅的情绪，再无其他。我淡漠得，连自己都想不明白。朋友问我要不要去她老公那边玩把牌。我答应了。朋友却奇怪地看了我一眼，摸了一把我的手，嘟囔着说：「竟然还是热的。」玩了几场，我运气不错，只输了一次，朋友对我刮目相看，「脑子很清醒嘛。」中间宋之恒发消息问我：什么时候回来？我看了眼时间，说快了。他发了个开心的表情：那我去接你。犹豫了一下，我说好。结束后我去了趟洗手间，出来时看见凌慬站在廊道里，眉头微微蹙着，神情有些阴郁。我下意识去搜寻宋云念的身影，却听凌慬说：「她已经走了。」他深吸了口气，略显焦躁的，不知道是在向我解释还是想说明什么，「她已经结婚了，我们是不可能的。」我没有说话，手机嗡嗡响了两声，我猜想是不是宋之恒到了，想要点开屏幕看看，却被凌慬捉住了手。他紧紧盯着我，声音有些冷，「你最近到底怎么了？」4.望着他的眼睛，我隐约明白他在问什么。手机响了，有朋友注意到这边的动静，探头朝我们看来。我放缓语气，「让我先接个电话。」他的唇绷成一条线，良久才慢慢放开我。宋之恒在那头嗓音愉悦：「林念我到了，在餐吧门口。」我嗯了一声，「就出来了。」然后挂断电话看向凌慬，「有什么事情下次再说吧，我……」我在有关宋之恒的称呼上顿了顿，「朋友来接我了。」凌慬食指微微蜷缩了一下，这表示他在忍耐，「……周末有空吗？」他看了我一会儿，「我们很久没有出来聚聚了。」我沉默片刻，说好。和上次不一样，这次凌慬站在原地，目送着我和宋之恒的车子驶离他的视线。车上，我发觉宋之恒的情绪有些恹恹的，漫不经意地开着车，连话都变少了。明明刚才还笑容满面地跟凌慬打招呼，一副男朋友的姿态给我开车门。我好像猜到了什么，故意逗他，「不想看到我吗？牙帮子咬那么紧。」宋之恒委屈地看了我一眼，「我们现在算谈恋爱吗？」我没想到他会这么问，不由一愣。宋之恒好像有些失望，之后一路上都没有再开口，把我送到家门口，就耷拉着脑袋掏出钥匙走向自己家的门。我有股冲动想叫住他，但最终还是按捺住了。谁知门刚一打开，我的手就被攥住了。宋之恒脸上有掩藏不住的失落，又像是在磨牙，「你就一句话都不说，你知不知道我今晚会睡不着的。」</div><div class="KfeCollection-VipRecommendCard-footer"><div class="KfeCollection-VipRecommendCard-footer-number">3431 点赞 · 79 评论 · 盐选推荐</div></div></div><div class="Post-Sub Post-Sub-Mobile"><div class="css-3rj67r"><div class="css-n51fzv">评论 </div><div class="css-5nsq0q"><div class="css-1w5k7wg"><img src="https://pic1.zhimg.com/v2-abed1a8c04700ba7d72b45195223e0ff_s.jpeg" class="css-rdccu8"></div><div href="https://www.zhihu.com/comment/list/article/591751476?open_editor=true" class="css-entir"><div role="link" tabindex="0" class="css-eh6tr1"><div class="css-1n5v8m5">写评论</div></div></div></div></div><div class="PostIndex-Contributions" data-za-detail-view-path-module="ColumnList" data-za-detail-view-path-module_name="文章被以下专栏收录" data-za-extra-module="{}"><h3 class="BlockTitle">文章被以下专栏收录</h3><ul><div class="ContentItem Column-ColumnItem"><div class="ContentItem-main"><div class="ContentItem-image"><img class="Avatar css-1any501" src="https://picx.zhimg.com/v2-b7a5731b9b518c13c4a82a90453ebaf6_l.jpg?source=172ae18b" srcset="https://picx.zhimg.com/v2-b7a5731b9b518c13c4a82a90453ebaf6_l.jpg?source=172ae18b 2x" alt="RandomGenerator"></div><div class="ContentItem-head"><h2 class="ContentItem-title"><span>RandomGenerator</span></h2></div></div></div></ul></div><div><div class="Sticky RichContent-actions is-fixed is-bottom" style="width: 390px; bottom: 0px; left: 16px;"><div class="ContentItem-actions" data-za-detail-view-path-module="BottomBar" data-za-extra-module="{&quot;card&quot;:{&quot;content&quot;:{&quot;type&quot;:&quot;Post&quot;,&quot;id&quot;:&quot;591751476&quot;}}}"><span><button aria-label="赞同 12 " aria-live="polite" type="button" class="Button VoteButton VoteButton--up"><span style="display:inline-flex;align-items:center">​<svg width="10" height="10" viewBox="0 0 24 24" class="Zi Zi--TriangleUp VoteButton-TriangleUp" fill="currentColor"><path fill-rule="evenodd" d="M13.792 3.681c-.781-1.406-2.803-1.406-3.584 0l-7.79 14.023c-.76 1.367.228 3.046 1.791 3.046h15.582c1.563 0 2.55-1.68 1.791-3.046l-7.79-14.023Z" clip-rule="evenodd"></path></svg></span>赞同 12</button><button aria-label="反对" aria-live="polite" type="button" class="Button VoteButton VoteButton--down VoteButton--mobileDown"><span style="display:inline-flex;align-items:center">​<svg width="10" height="10" viewBox="0 0 24 24" class="Zi Zi--TriangleDown" fill="currentColor"><path fill-rule="evenodd" d="M13.792 20.319c-.781 1.406-2.803 1.406-3.584 0L2.418 6.296c-.76-1.367.228-3.046 1.791-3.046h15.582c1.563 0 2.55 1.68 1.791 3.046l-7.79 14.023Z" clip-rule="evenodd"></path></svg></span></button></span><button type="button" class="Button BottomActions-CommentBtn Button--plain Button--withIcon Button--withLabel"><span style="display:inline-flex;align-items:center">​<svg width="1.2em" height="1.2em" viewBox="0 0 24 24" class="Zi Zi--Comment Button-zi" fill="currentColor"><path fill-rule="evenodd" d="M12 2.75a9.25 9.25 0 1 0 4.737 17.197l2.643.817a1 1 0 0 0 1.25-1.25l-.8-2.588A9.25 9.25 0 0 0 12 2.75Z" clip-rule="evenodd"></path></svg></span>添加评论</button><button type="button" class="Button Button--plain Button--withIcon Button--iconOnly undefined"><span style="display:inline-flex;align-items:center">​<svg width="1.2em" height="1.2em" viewBox="0 0 24 24" class="Zi Zi--Star Button-zi" fill="currentColor"><path d="M10.484 3.307c.673-1.168 2.358-1.168 3.032 0l2.377 4.122a.25.25 0 0 0 .165.12l4.655.987c1.319.28 1.84 1.882.937 2.884l-3.186 3.535a.25.25 0 0 0-.063.193l.5 4.733c.142 1.34-1.222 2.33-2.453 1.782l-4.346-1.938a.25.25 0 0 0-.204 0l-4.346 1.938c-1.231.549-2.595-.442-2.453-1.782l.5-4.733a.25.25 0 0 0-.064-.193L2.35 11.42c-.903-1.002-.382-2.604.937-2.884l4.655-.987a.25.25 0 0 0 .164-.12l2.378-4.122Z"></path></svg></span></button><div class="Post-ActionMenuButton"><div class="Popover"><div id="Popover1-toggle" aria-haspopup="true" aria-expanded="false" aria-owns="Popover1-content"><button type="button" class="Button Button--plain Button--withIcon Button--iconOnly undefined"><span style="display:inline-flex;align-items:center">​<svg width="1.2em" height="1.2em" viewBox="0 0 24 24" class="Zi Zi--Dots Button-zi" fill="currentColor"><path fill-rule="evenodd" d="M5.83 12a1.665 1.665 0 1 1-3.33 0 1.665 1.665 0 0 1 3.33 0Zm7.835 0a1.665 1.665 0 1 1-3.33 0 1.665 1.665 0 0 1 3.33 0Zm6.17 1.665a1.665 1.665 0 1 0 0-3.33 1.665 1.665 0 0 0 0 3.33Z" clip-rule="evenodd"></path></svg></span></button></div></div></div></div></div><div class="Sticky--holder" style="position: static; inset: auto auto 0px 0px; display: block; float: none; margin: 0px; height: 54px;"></div></div></div></div></main></div></div><script id="js-clientConfig" type="text/json">{"fetchRoot":{"www":"https:\u002F\u002Fwww.zhihu.com","api":"https:\u002F\u002Fapi.zhihu.com","lens":"https:\u002F\u002Flens.zhihu.com","zhuanlan":"https:\u002F\u002Fzhuanlan.zhihu.com\u002Fapi\u002F","walletpay":"https:\u002F\u002Fwalletpay.zhihu.com","captcha":"https:\u002F\u002Fcaptcha.zhihu.com","vzuu":"https:\u002F\u002Fv.vzuu.com","openapi":"https:\u002F\u002Fopenapi.zhihu.com","svip":"https:\u002F\u002Fsvip.zhihu.com"},"host":"zhihu.com","protocol":"https:","wwwHost":"www.zhihu.com","videoHost":"video.zhihu.com","zhuanlanHost":"zhuanlan.zhihu.com","allowSignUp":true,"refreshValidityPeriod":"30","release":"824-bcf32e16","currentEntry":"column","isMobileEntry":false,"apollo":{"env":"prod","globalSilence":"","ncgModeSign":"3f8e56febda4fb3bbea72e379d76de1e","topstory_rec_adp":"1","test_canary":"member|0-100,1-0","use_new_player":"member|0-0,1-100","player_vendor":"member|0-0,1-100,2-0","use_hevc":"member|0-0,1-100","upload_use_signature":"member|0-0,1-100","use_backdrop_blur":"member|0-0,1-100","article_title_imagex":"member|0-50,1-50","play_station":"member|0-0,1-100"}}</script><script id="js-initialData" type="text/json">{"initialState":{"common":{"ask":{}},"loading":{"global":{"count":0},"local":{"env\u002FgetIpinfo\u002F":false,"article\u002Fget\u002F":false,"brand\u002FgetUrl\u002F":false,"article\u002FloadPostSearchEntity\u002F":false}},"entities":{"users":{"zijie0":{"isFollowed":false,"avatarUrlTemplate":"https:\u002F\u002Fpic1.zhimg.com\u002Fv2-95ba0bb27d5abbdac132d83c17310b22.jpg?source=172ae18b","uid":"27758868561920","userType":"people","isFollowing":false,"urlToken":"zijie0","id":"dd44fd707897acda43e0a65ba07b3199","description":"如果您对我的作品感兴趣，欢迎关注个人公众号：RandomGenerator","name":"字节","isAdvertiser":false,"headline":"天地大观，志存高远","gender":1,"url":"\u002Fpeople\u002Fdd44fd707897acda43e0a65ba07b3199","avatarUrl":"https:\u002F\u002Fpic1.zhimg.com\u002Fv2-95ba0bb27d5abbdac132d83c17310b22_l.jpg?source=172ae18b","isOrg":false,"type":"people","badge":[],"badgeV2":{"title":"","mergedBadges":[],"detailBadges":[],"icon":"","nightIcon":""},"exposedMedal":{"medalId":"1055464808517865473","medalName":"专业","avatarUrl":"https:\u002F\u002Fpic1.zhimg.com\u002Fv2-b42f593c6ccee918d956a183eed2ffd7_r.png?source=172ae18b","miniAvatarUrl":"https:\u002F\u002Fpic1.zhimg.com\u002Fv2-b42f593c6ccee918d956a183eed2ffd7_l.png?source=172ae18b","description":"回答收到「专业认可」即可获得","medalAvatarFrame":""}}},"questions":{},"answers":{},"articles":{"591751476":{"trackUrl":["https:\u002F\u002Fsugar.zhihu.com\u002Fplutus_adreaper\u002Fcontent_monitor_log?si=__SESSIONID__&ti=__ATOKEN__&at=view&pf=__OS__&ed=BiBUKF0xBSkqGGJ-QhvjYHlDBQ==&idfa=__IDFA__&imei=__IMEI__&androidid=__ANDROIDID__&oaid=__OAID__&ci=__CREATIVEID__&zid=__ZONEID__"],"entityWords":[{"name":"基础系统架构","mention":"基础系统架构","matchorder":1,"begin":411,"end":417,"entityid":0,"isBookMark":false,"link":{"linkType":0,"linkUrl":"","docType":"","topicToken":""},"entityClass":"Computer","score":0,"attachedInfoBytes":"sgJeChLln7rnoYDns7vnu5\u002FmnrbmnoQSCENvbXB1dGVyGJsDIKEDKAE1AAAAADoHYXJ0aWNsZUAASABSJDI2MDkzNTE5LTk5OTgtNGRhMi05ZjNjLWQ5MTFkZDc4ZmRjYw==","isOnAB":false,"isNatural":1,"isDelete":false,"contentType":"","contentId":"","contentToken":""},{"name":"瀑布式模型","mention":"瀑布式模型","matchorder":1,"begin":1716,"end":1721,"entityid":0,"isBookMark":false,"link":{"linkType":0,"linkUrl":"","docType":"","topicToken":""},"entityClass":"Math","score":0,"attachedInfoBytes":"sgJXCg\u002FngJHluIPlvI\u002FmqKHlnosSBE1hdGgYtA0guQ0oATUAAAAAOgdhcnRpY2xlQABIAFIkMjYwOTM1MTktOTk5OC00ZGEyLTlmM2MtZDkxMWRkNzhmZGNj","isOnAB":false,"isNatural":1,"isDelete":false,"contentType":"","contentId":"","contentToken":""},{"name":"internet scale","mention":"internet scale","matchorder":1,"begin":556,"end":570,"entityid":0,"isBookMark":false,"link":{"linkType":0,"linkUrl":"","docType":"","topicToken":""},"entityClass":"Commodity","score":0,"attachedInfoBytes":"sgJbCg5pbnRlcm5ldCBzY2FsZRIJQ29tbW9kaXR5GKwEILoEKAE1AAAAADoHYXJ0aWNsZUAASABSJDI2MDkzNTE5LTk5OTgtNGRhMi05ZjNjLWQ5MTFkZDc4ZmRjYw==","isOnAB":false,"isNatural":1,"isDelete":false,"contentType":"","contentId":"","contentToken":""},{"name":"软件测试","mention":"软件测试","matchorder":1,"begin":7783,"end":7787,"entityid":0,"isBookMark":false,"link":{"linkType":0,"linkUrl":"","docType":"","topicToken":""},"entityClass":"Unknown","score":0,"attachedInfoBytes":"sgJXCgzova\u002Fku7bmtYvor5USB1Vua25vd24Y5zwg6zwoATUAAAAAOgdhcnRpY2xlQABIAFIkMjYwOTM1MTktOTk5OC00ZGEyLTlmM2MtZDkxMWRkNzhmZGNj","isOnAB":false,"isNatural":1,"isDelete":false,"contentType":"","contentId":"","contentToken":""},{"name":"逻辑检查","mention":"逻辑检查","matchorder":1,"begin":28407,"end":28411,"entityid":0,"isBookMark":false,"link":{"linkType":0,"linkUrl":"","docType":"","topicToken":""},"entityClass":"Unknown","score":0,"attachedInfoBytes":"sgJZCgzpgLvovpHmo4Dmn6USB1Vua25vd24Y990BIPvdASgBNQAAAAA6B2FydGljbGVAAEgAUiQyNjA5MzUxOS05OTk4LTRkYTItOWYzYy1kOTExZGQ3OGZkY2M=","isOnAB":false,"isNatural":1,"isDelete":false,"contentType":"","contentId":"","contentToken":""},{"name":"自动化测试","mention":"自动化测试","matchorder":1,"begin":5653,"end":5658,"entityid":0,"isBookMark":false,"link":{"linkType":0,"linkUrl":"","docType":"","topicToken":""},"entityClass":"Computer","score":0,"attachedInfoBytes":"sgJbCg\u002Foh6rliqjljJbmtYvor5USCENvbXB1dGVyGJUsIJosKAE1AAAAADoHYXJ0aWNsZUAASABSJDI2MDkzNTE5LTk5OTgtNGRhMi05ZjNjLWQ5MTFkZDc4ZmRjYw==","isOnAB":false,"isNatural":1,"isDelete":false,"contentType":"","contentId":"","contentToken":""},{"name":"e2e","mention":"e2e","matchorder":2,"begin":6953,"end":6956,"entityid":0,"isBookMark":false,"link":{"linkType":0,"linkUrl":"","docType":"","topicToken":""},"entityClass":"OtherTerm","score":0,"attachedInfoBytes":"sgJQCgNlMmUSCU90aGVyVGVybRipNiCsNigCNQAAAAA6B2FydGljbGVAAEgAUiQyNjA5MzUxOS05OTk4LTRkYTItOWYzYy1kOTExZGQ3OGZkY2M=","isOnAB":false,"isNatural":1,"isDelete":false,"contentType":"","contentId":"","contentToken":""},{"name":"emacs","mention":"emacs","matchorder":1,"begin":5501,"end":5506,"entityid":0,"isBookMark":false,"link":{"linkType":0,"linkUrl":"","docType":"","topicToken":""},"entityClass":"Commodity","score":0,"attachedInfoBytes":"sgJSCgVlbWFjcxIJQ29tbW9kaXR5GP0qIIIrKAE1AAAAADoHYXJ0aWNsZUAASABSJDI2MDkzNTE5LTk5OTgtNGRhMi05ZjNjLWQ5MTFkZDc4ZmRjYw==","isOnAB":false,"isNatural":1,"isDelete":false,"contentType":"","contentId":"","contentToken":""},{"name":"网络抖动","mention":"网络抖动","matchorder":1,"begin":7132,"end":7136,"entityid":0,"isBookMark":false,"link":{"linkType":0,"linkUrl":"","docType":"","topicToken":""},"entityClass":"Unknown","score":0,"attachedInfoBytes":"sgJXCgznvZHnu5zmipbliqgSB1Vua25vd24Y3Dcg4DcoATUAAAAAOgdhcnRpY2xlQABIAFIkMjYwOTM1MTktOTk5OC00ZGEyLTlmM2MtZDkxMWRkNzhmZGNj","isOnAB":false,"isNatural":1,"isDelete":false,"contentType":"","contentId":"","contentToken":""},{"name":"测试驱动开发","mention":"测试驱动开发","matchorder":1,"begin":29697,"end":29703,"entityid":0,"isBookMark":false,"link":{"linkType":0,"linkUrl":"","docType":"","topicToken":""},"entityClass":"Unknown","score":0,"attachedInfoBytes":"sgJfChLmtYvor5XpqbHliqjlvIDlj5ESB1Vua25vd24YgegBIIfoASgBNQAAAAA6B2FydGljbGVAAEgAUiQyNjA5MzUxOS05OTk4LTRkYTItOWYzYy1kOTExZGQ3OGZkY2M=","isOnAB":false,"isNatural":1,"isDelete":false,"contentType":"","contentId":"","contentToken":""},{"name":"反馈速度","mention":"反馈速度","matchorder":1,"begin":5340,"end":5344,"entityid":0,"isBookMark":false,"link":{"linkType":0,"linkUrl":"","docType":"","topicToken":""},"entityClass":"Physics","score":0,"attachedInfoBytes":"sgJXCgzlj43ppojpgJ\u002FluqYSB1BoeXNpY3MY3Ckg4CkoATUAAAAAOgdhcnRpY2xlQABIAFIkMjYwOTM1MTktOTk5OC00ZGEyLTlmM2MtZDkxMWRkNzhmZGNj","isOnAB":false,"isNatural":1,"isDelete":false,"contentType":"","contentId":"","contentToken":""},{"name":"legacy system","mention":"legacy system","matchorder":1,"begin":626,"end":639,"entityid":0,"isBookMark":false,"link":{"linkType":0,"linkUrl":"","docType":"","topicToken":""},"entityClass":"OtherTerm","score":0,"attachedInfoBytes":"sgJaCg1sZWdhY3kgc3lzdGVtEglPdGhlclRlcm0Y8gQg\u002FwQoATUAAAAAOgdhcnRpY2xlQABIAFIkMjYwOTM1MTktOTk5OC00ZGEyLTlmM2MtZDkxMWRkNzhmZGNj","isOnAB":false,"isNatural":1,"isDelete":false,"contentType":"","contentId":"","contentToken":""},{"name":"trade-off","mention":"trade-off","matchorder":2,"begin":3714,"end":3723,"entityid":0,"isBookMark":false,"link":{"linkType":0,"linkUrl":"","docType":"","topicToken":""},"entityClass":"OtherTerm","score":0,"attachedInfoBytes":"sgJWCgl0cmFkZS1vZmYSCU90aGVyVGVybRiCHSCLHSgCNQAAAAA6B2FydGljbGVAAEgAUiQyNjA5MzUxOS05OTk4LTRkYTItOWYzYy1kOTExZGQ3OGZkY2M=","isOnAB":false,"isNatural":1,"isDelete":false,"contentType":"","contentId":"","contentToken":""},{"name":"人月神话","mention":"人月神话","matchorder":1,"begin":952,"end":956,"entityid":0,"isBookMark":false,"link":{"linkType":0,"linkUrl":"","docType":"","topicToken":""},"entityClass":"Artwork","score":0,"attachedInfoBytes":"sgJXCgzkurrmnIjnpZ7or50SB0FydHdvcmsYuAcgvAcoATUAAAAAOgdhcnRpY2xlQABIAFIkMjYwOTM1MTktOTk5OC00ZGEyLTlmM2MtZDkxMWRkNzhmZGNj","isOnAB":false,"isNatural":1,"isDelete":false,"contentType":"","contentId":"","contentToken":""}],"id":591751476,"title":"重新思考软件测试","type":"article","articleType":"normal","excerptTitle":"","url":"https:\u002F\u002Fzhuanlan.zhihu.com\u002Fp\u002F591751476","imageUrl":"https:\u002F\u002Fpic1.zhimg.com\u002Fv2-8bb94a3857a9a2891b9707b92f7ad76a_720w.jpg?source=172ae18b","titleImage":"https:\u002F\u002Fpic1.zhimg.com\u002Fv2-8bb94a3857a9a2891b9707b92f7ad76a_720w.jpg?source=172ae18b","excerpt":"\u003Cimg src=\"https:\u002F\u002Fpic2.zhimg.com\u002Fv2-79f3cb0cf479f1456da98e5713917411_200x112.jpg\" data-caption=\"瀑布式开发模型\" data-size=\"normal\" data-rawwidth=\"1297\" data-rawheight=\"936\" data-watermark=\"watermark\" data-original-src=\"v2-79f3cb0cf479f1456da98e5713917411\" data-watermark-src=\"v2-379dfcb55c9ea7eb0a0b0382c96c263a\" data-private-watermark-src=\"\" class=\"origin_image inline-img zh-lightbox-thumb\" data-original=\"https:\u002F\u002Fpic2.zhimg.com\u002Fv2-79f3cb0cf479f1456da98e5713917411_r.jpg\"\u002F\u003E虽然之前也写了快二十年代码了，对于很多现代软件工程的 buzz word 如敏捷，持续集成，DevOps 等都耳熟能详。但这两年在项目上碰到的各种挑战，以及跟一些开发者同僚交流下来发现，其实软件工程的很多最佳实践并没有被广泛接受和应用，在软件质量领域，我们…","created":1670999923,"updated":1671067516,"author":{"isFollowed":false,"avatarUrlTemplate":"https:\u002F\u002Fpic1.zhimg.com\u002Fv2-95ba0bb27d5abbdac132d83c17310b22.jpg?source=172ae18b","uid":"27758868561920","userType":"people","isFollowing":false,"urlToken":"zijie0","id":"dd44fd707897acda43e0a65ba07b3199","description":"如果您对我的作品感兴趣，欢迎关注个人公众号：RandomGenerator","name":"字节","isAdvertiser":false,"headline":"天地大观，志存高远","gender":1,"url":"\u002Fpeople\u002Fdd44fd707897acda43e0a65ba07b3199","avatarUrl":"https:\u002F\u002Fpic1.zhimg.com\u002Fv2-95ba0bb27d5abbdac132d83c17310b22_l.jpg?source=172ae18b","isOrg":false,"type":"people","badge":[],"badgeV2":{"title":"","mergedBadges":[],"detailBadges":[],"icon":"","nightIcon":""},"exposedMedal":{"medalId":"1055464808517865473","medalName":"专业","avatarUrl":"https:\u002F\u002Fpic1.zhimg.com\u002Fv2-b42f593c6ccee918d956a183eed2ffd7_r.png?source=172ae18b","miniAvatarUrl":"https:\u002F\u002Fpic1.zhimg.com\u002Fv2-b42f593c6ccee918d956a183eed2ffd7_l.png?source=172ae18b","description":"回答收到「专业认可」即可获得","medalAvatarFrame":""}},"commentPermission":"all","copyrightPermission":"need_review","state":"published","ipInfo":"IP 属地浙江","imageWidth":900,"imageHeight":430,"content":"\u003Cp data-pid=\"JpKltOQh\"\u003E虽然之前也写了快二十年代码了，对于很多现代软件工程的 buzz word 如敏捷，持续集成，DevOps 等都耳熟能详。但这两年在项目上碰到的各种挑战，以及跟一些开发者同僚交流下来发现，其实软件工程的很多最佳实践并没有被广泛接受和应用，在软件质量领域，我们持续受到了很大的挑战。\u003C\u002Fp\u003E\u003Cp data-pid=\"hi_MuUoc\"\u003E过去十多年，中国的互联网软件得到了蓬勃的发展，其中有两个看起来比较突出的挑战：一是如何能快速推出一个产品原型，迅速尝试一些新想法，抢占市场知名度；另一个是当产品赢得大量用户之后，随之而来对于底层基础设施的大规模计算执行，大数据量存储与处理方面的挑战。在这两个挑战下，形成了很多具有“互联网特色”的软件工程实践，例如早年很有名的 Facebook 的口号“Move fast and break things”，以及各种技术分享中最火热的一般都是基础系统架构的演进之类的话题。\u003C\u002Fp\u003E\u003Cp data-pid=\"tGBwOcWV\"\u003E这两年国内的 SaaS to B 领域逐渐开始升温，很多“传统”软件开发的挑战也随之而来，跟互联网类软件的问题还不太一样。例如很多 SaaS 软件的数据量没有那么大，对底层基础设施没有很高的要求，如果照搬“internet scale”的设计就很容易自己给自己添麻烦。商业软件的演进路线也相对比较明确，后续持续维护的时间一般也更长，所以碰到所谓 legacy system 的情况也会更常见。另外就是很多公司内部的业务需求与流程非常的复杂，由此而来对于软件“领域模型”的复杂度要求也上升了很多。\u003C\u002Fp\u003E\u003Cp data-pid=\"e2EBLqL7\"\u003E这些挑战即使是比较有经验的互联网软件开发者也不一定有积累的技能可以直接解决，也经常让我们感叹国内的软件人才为何如此稀缺。所以我们还是需要回到软件工程角度，去看看适合此类企业级软件开发的最佳实践到底是怎么样的。\u003C\u002Fp\u003E\u003Ch2\u003E现代软件工程\u003C\u002Fh2\u003E\u003Cp data-pid=\"MHn055Id\"\u003E当年在计算机硬件飞速发展时，人们就发现与之配套的软件开发的增长速度却极其有限，经常碰到无法按时交付，超出预算，品质低下，不符合需求，难以维护等等问题。著名的《人月神话》也是在那个时代撰写出版的，描述了大型软件开发项目中所遇到的困境。\u003C\u002Fp\u003E\u003Cp data-pid=\"t-Y_8gwE\"\u003E为了解决这个问题，人们非常自然的一个思路就是借鉴我们其它大型工程中已经应用过的实践，最典型的就是“瀑布式开发”模式。\u003C\u002Fp\u003E\u003Cp class=\"ztext-empty-paragraph\"\u003E\u003Cbr\u002F\u003E\u003C\u002Fp\u003E\u003Cfigure data-size=\"normal\"\u003E\u003Cnoscript\u003E\u003Cimg src=\"https:\u002F\u002Fpic3.zhimg.com\u002Fv2-379dfcb55c9ea7eb0a0b0382c96c263a_b.jpg\" data-size=\"normal\" data-rawwidth=\"1297\" data-rawheight=\"936\" class=\"origin_image zh-lightbox-thumb\" width=\"1297\" data-original=\"https:\u002F\u002Fpic3.zhimg.com\u002Fv2-379dfcb55c9ea7eb0a0b0382c96c263a_r.jpg\"\u002F\u003E\u003C\u002Fnoscript\u003E\u003Cimg src=\"data:image\u002Fsvg+xml;utf8,&lt;svg xmlns=&#39;http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg&#39; width=&#39;1297&#39; height=&#39;936&#39;&gt;&lt;\u002Fsvg&gt;\" data-size=\"normal\" data-rawwidth=\"1297\" data-rawheight=\"936\" class=\"origin_image zh-lightbox-thumb lazy\" width=\"1297\" data-original=\"https:\u002F\u002Fpic3.zhimg.com\u002Fv2-379dfcb55c9ea7eb0a0b0382c96c263a_r.jpg\" data-actualsrc=\"https:\u002F\u002Fpic3.zhimg.com\u002Fv2-379dfcb55c9ea7eb0a0b0382c96c263a_b.jpg\" data-original-token=\"v2-79f3cb0cf479f1456da98e5713917411\"\u002F\u003E\u003Cfigcaption\u003E瀑布式开发模型\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp class=\"ztext-empty-paragraph\"\u003E\u003Cbr\u002F\u003E\u003C\u002Fp\u003E\u003Cp data-pid=\"Qews57We\"\u003E在这个模型中，每一个步骤有着严格的先后顺序之分，希望能严格把需求和设计确定好后再开始开发，然后测试验收后部署上线。这套方法在很多其它类型的工程里都得到了大量的应用，比如如果家里做过装修的话就会切身体验一遍这个流程。\u003C\u002Fp\u003E\u003Cp data-pid=\"D-Qj29S2\"\u003E瀑布式模型之所以有效，一个很重要的原因是它很好地解决了“实体化生产”带来的挑战。比如我们要做装修，把所有实体部件构建出来，像水管，电线，开关，地板，橱柜，家居，电器等等，需要花费非常大的代价。同理如果我们要做硬件的生产，如芯片，汽车等，批量化制造的成本也是非常高的。这些最终实体生产出来后，如果发现有问题，需要返工修改，几乎就代表了项目的失败。\u003C\u002Fp\u003E\u003Cp data-pid=\"iAP1vLcY\"\u003E但对于软件来说，其本身并不存在“实体化生产”的问题。我们知道任何一份代码写出来，做批量化的复制运行可以说是成本很低的。所以瀑布式模型后来受到很多诟病的原因也不难理解了，因为它想要解决的问题，在软件工程领域并不存在（至少不那么严重）。\u003C\u002Fp\u003E\u003Cp data-pid=\"R9HgBW96\"\u003E所以我们在思考软件工程时，需要抵制住套用人类千年来的传统工程思维的影响，从软件本身的特性出发去寻找更加匹配的方法论。没有“实体化生产”的包袱，可以快速做修改迭代，需要服务于现实需求，但又会随着环境，技术的演变发生丰富而又难以预料的变化，是不是可以联想到一个有些类似的活动：科学研究。\u003C\u002Fp\u003E\u003Cp data-pid=\"DSpZHjLv\"\u003E跟软件一样，科学研究很多时候会在理论和设计层面进行推演，即使涉及到实验，一般也是相对来说较低成本的形式。科研的探索方向是明确的，但具体的路径和实现方式有着很大的不确定性，因此需要不断地提出假设，设计实验，进行实验，获取反馈，迭代认知，再提出新的假设这样循环往复。这与后续出现的“敏捷”开发模式有着很高的相似度。\u003C\u002Fp\u003E\u003Cp class=\"ztext-empty-paragraph\"\u003E\u003Cbr\u002F\u003E\u003C\u002Fp\u003E\u003Cfigure data-size=\"normal\"\u003E\u003Cnoscript\u003E\u003Cimg src=\"https:\u002F\u002Fpic4.zhimg.com\u002Fv2-270cc75c660df284b623598370c877b7_b.jpg\" data-size=\"normal\" data-rawwidth=\"2000\" data-rawheight=\"1340\" class=\"origin_image zh-lightbox-thumb\" width=\"2000\" data-original=\"https:\u002F\u002Fpic4.zhimg.com\u002Fv2-270cc75c660df284b623598370c877b7_r.jpg\"\u002F\u003E\u003C\u002Fnoscript\u003E\u003Cimg src=\"data:image\u002Fsvg+xml;utf8,&lt;svg xmlns=&#39;http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg&#39; width=&#39;2000&#39; height=&#39;1340&#39;&gt;&lt;\u002Fsvg&gt;\" data-size=\"normal\" data-rawwidth=\"2000\" data-rawheight=\"1340\" class=\"origin_image zh-lightbox-thumb lazy\" width=\"2000\" data-original=\"https:\u002F\u002Fpic4.zhimg.com\u002Fv2-270cc75c660df284b623598370c877b7_r.jpg\" data-actualsrc=\"https:\u002F\u002Fpic4.zhimg.com\u002Fv2-270cc75c660df284b623598370c877b7_b.jpg\" data-original-token=\"v2-e04ef33802c8a6726db70e8e55261c4d\"\u002F\u003E\u003Cfigcaption\u003EAgile 模型\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp class=\"ztext-empty-paragraph\"\u003E\u003Cbr\u002F\u003E\u003C\u002Fp\u003E\u003Cp data-pid=\"0wmqV3cA\"\u003E所以当前主流的现代软件工程思想，就是把软件开发行为的本质理解为假设，行动，反馈，学习这几个步骤。大家应该也经常听到类似的说法，比如“架构是演进出来的，而不是设计出来的”。与科学研究不同的是，软件工程一般有更长的持续性，因此在设计与行动这块，会更加注重“控制软件熵（复杂度）”。这篇文章会更多从软件质量角度出发，来讨论软件工程中的反馈与学习。如果我们能做到高质量的反馈与学习，就能打造出更符合用户需求，功能完备性和质量都更好的软件产品。同时我们也会看到，反馈学习本身对于复杂度的控制也有很大的协同促进作用。\u003C\u002Fp\u003E\u003Ch2\u003E软件质量的综合指标\u003C\u002Fh2\u003E\u003Cp data-pid=\"rSKT-At5\"\u003E如何评价软件的质量呢？如果我们以传统眼光来看，一件物品的质量的衡量方式可能是其广大使用者在一定时间内遇到的故障问题数量和严重程度。但对于软件来说，质量其实是一个动态的过程，因为客户的诉求和使用场景会发生变化，而软件本身也会不断升级版本来满足相应的诉求。\u003C\u002Fp\u003E\u003Cp data-pid=\"PLDuCLDF\"\u003E在查阅了一些资料后发现，业界对于软件质量的定义主要集中在四个指标上：\u003C\u002Fp\u003E\u003Cul\u003E\u003Cli data-pid=\"qBL_XoiD\"\u003E每次软件变更带来的问题数的平均值。\u003C\u002Fli\u003E\u003Cli data-pid=\"pFIhWhCN\"\u003E每个软件问题从发现到修复所耗费时间的平均值。\u003C\u002Fli\u003E\u003Cli data-pid=\"R5aESTvH\"\u003E从提出需求，到软件交付所花费时间的平均值。\u003C\u002Fli\u003E\u003Cli data-pid=\"cfuQSjik\"\u003E发布\u002F部署到生产环境的频率。\u003C\u002Fli\u003E\u003C\u002Ful\u003E\u003Cp data-pid=\"ApMDri1P\"\u003E前两个指标主要是从稳定性的角度来看，我们发布软件的问题多不多。而后两个指标是从吞吐量角度来看，我们发布软件的速度快不快。\u003C\u002Fp\u003E\u003Cp data-pid=\"kRbDuea8\"\u003E绝大多数软件工程师都会觉得，速度和稳定性这两点是个 trade-off。如果我希望发布更稳定，那么一般来说就需要花更长的时间做质量保障相关工作，例如各种测试验证。而如果用户急着要某个功能，那么必然会影响发布版本的质量，可能引入不少 bug。\u003C\u002Fp\u003E\u003Cp data-pid=\"-aE58EHj\"\u003E但有意思的是，从《\u003Ca href=\"https:\u002F\u002Flink.zhihu.com\u002F?target=https%3A\u002F\u002Fbook.douban.com\u002Fsubject\u002F30192146\u002F\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\"\u003EAccelerate\u003C\u002Fa\u003E》这本书中我们可以看到来自 Puppet 与学术机构合作的“State of DevOps”报告中指出，具有更高发布稳定性的团队组织，往往其发布的吞吐量也会更高。而发布稳定性低的组织，可能因此引入了更多的流程，人工审核，或者引起了客户对其新版本的不信任，进一步拖慢了其发布的吞吐量。也就是说，这两者非但不是非此即彼，而是相互促进的，真正的 trade-off 是在“更好更快”与“更差更慢”这两者之间。\u003C\u002Fp\u003E\u003Cp class=\"ztext-empty-paragraph\"\u003E\u003Cbr\u002F\u003E\u003C\u002Fp\u003E\u003Cfigure data-size=\"normal\"\u003E\u003Cnoscript\u003E\u003Cimg src=\"https:\u002F\u002Fpic3.zhimg.com\u002Fv2-e01f2180e3f43c4546b0a92a5feb7e06_b.jpg\" data-size=\"normal\" data-rawwidth=\"2084\" data-rawheight=\"1388\" class=\"origin_image zh-lightbox-thumb\" width=\"2084\" data-original=\"https:\u002F\u002Fpic3.zhimg.com\u002Fv2-e01f2180e3f43c4546b0a92a5feb7e06_r.jpg\"\u002F\u003E\u003C\u002Fnoscript\u003E\u003Cimg src=\"data:image\u002Fsvg+xml;utf8,&lt;svg xmlns=&#39;http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg&#39; width=&#39;2084&#39; height=&#39;1388&#39;&gt;&lt;\u002Fsvg&gt;\" data-size=\"normal\" data-rawwidth=\"2084\" data-rawheight=\"1388\" class=\"origin_image zh-lightbox-thumb lazy\" width=\"2084\" data-original=\"https:\u002F\u002Fpic3.zhimg.com\u002Fv2-e01f2180e3f43c4546b0a92a5feb7e06_r.jpg\" data-actualsrc=\"https:\u002F\u002Fpic3.zhimg.com\u002Fv2-e01f2180e3f43c4546b0a92a5feb7e06_b.jpg\" data-original-token=\"v2-11fdb1bee9233985b3d578e1f654220c\"\u002F\u003E\u003Cfigcaption\u003E这个分类是通过聚类算法跑出来的\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp class=\"ztext-empty-paragraph\"\u003E\u003Cbr\u002F\u003E\u003C\u002Fp\u003E\u003Cp data-pid=\"5kkHEUna\"\u003E从逻辑上来说也好理解，如果我们想有更多的学习与认知迭代，打造出更符合用户需求的软件，更快的发现问题并修复，那么就需要有更快的发布速度获取反馈。如果我们想要有更快的发布速度，那么本身的质量也需要过硬避免复杂的流程（书中也提到，流程通常对质量没什么帮助），发现问题要尽可能提早减少返工等。而且代码设计上需要更加合理，才便于做修改与演进，后面我们也会看到代码设计与可测试性之间也有着协同促进的关系。\u003C\u002Fp\u003E\u003Cp data-pid=\"imMw7hzl\"\u003E所以还是回到前面所说的，为了提升软件质量，还是回到反馈学习这个核心上。而这其中最有意思的，莫过于测试了。传统的看法会把测试等价于做其它实体产品的“质量检测”环节。但在软件工程中，测试不仅仅只是保障软件没有问题的一个步骤，而是我们获取反馈，学习知识最重要的一项基础手段。如果没有高质量，即时的反馈，那我们就不得不在过程中带入更多的猜测，这在复杂的软件项目上往往是很不靠谱的。\u003C\u002Fp\u003E\u003Cp data-pid=\"iFFF4-zv\"\u003E就像在科学研究中，我们会通过实验来获取理论在真实世界中的反馈一样，测试就是软件开发中获取反馈的方式。如果以玩游戏来类比，做实验有点像回合制游戏，玩家会通过缜密的思考推演，来下一步棋，然后再等待对手的反馈。而软件中的测试，则是实时化的，我们指挥兵力前进过程中，能即时地感知到周围环境的变化，对手的动作反应等。如果网络卡了，你很可能就无法发挥出很好的水平，因为反馈速度变慢了。\u003C\u002Fp\u003E\u003Cp data-pid=\"H1w9gOOz\"\u003E同理我们在 IDE 里写代码时，都是有实时的静态代码分析与提示，告诉你这里可能写的有问题。进一步，我们也需要添加相关的测试来丰富我们的“感知”，实时地了解这里的改动可能会破坏某些已有功能。顺便一提很多人推崇\u003Ccode\u003Evim\u003C\u002Fcode\u003E，\u003Ccode\u003Eemacs\u003C\u002Fcode\u003E这样的工具，但从实时反馈，以及反馈信息的丰富程度上来说，IDE 应该是更好的选择，而且现在很多这类传统编辑器也在尝试通过各种插件在终端里去实现类似 IDE 的效果。\u003C\u002Fp\u003E\u003Cp data-pid=\"2Xd04YxA\"\u003E讲到这里大家应该可以理解为何测试与软件开发应该是一个整体了。在自动化测试这个重要的基础手段之上，后续才演化出更多的如持续集成，持续部署，更全面的 DevOps 等实践。\u003C\u002Fp\u003E\u003Ch2\u003E为何需要研发来写测试\u003C\u002Fh2\u003E\u003Cp data-pid=\"PmfS_7rC\"\u003E前面我们已经提到测试与开发应该是一体的，而不应该独立开来。这个想法可能会受到很多传统工程思维或者旧行为模式习惯的挑战，例如：\u003C\u002Fp\u003E\u003Cul\u003E\u003Cli data-pid=\"-bMW_Itm\"\u003E很多人潜意识中会觉得，工程师的任务就是写“功能代码”，写完就算任务完成了。但实际上，工程师的任务应该是解决客户问题，创造业务价值。任何对这个目标有帮助的事情，都应该放在我们的职责范围内，例如写测试，写文档，完善持续集成与交付等。\u003C\u002Fli\u003E\u003Cli data-pid=\"RSFG5oTE\"\u003E为什么写自动化测试没有成为大家的习惯？一个常见的“陷阱”是，写完功能代码能跑通，会给人带来满足感；把功能上线后出了问题，我加班解决问题拯救公司，加倍带来满足感。这种短期满足感的叠加，反而让我们陷入一个恶性循环。\u003C\u002Fli\u003E\u003Cli data-pid=\"h6K-_hE8\"\u003E还有一个常见的想法叫“速度与质量不可兼得”，因为排期紧，所以研发只能只写功能代码。但实际情况我们前面也提到了，这两者恰恰是高度正相关的。达到高质量软件的重要途径，是更快速的发布，以获得更及时的内外部反馈信息（测试是否通过，客户是否对功能满意）；达到更快发布速度的路径，是高质量的软件，否则引入一堆的问题肯定会拖慢发布速度，或者用户根本不愿意升级。几乎没有公司是反过来的，质量很高，但迭代发布很慢，或者质量很差，但迭代发布很快。我们作为专业研发人员，在估算开发周期时就不应该有意把写代码和写测试分开来。\u003C\u002Fli\u003E\u003Cli data-pid=\"Aj8mD7LH\"\u003E还有一个常见的抱怨是，需求总是变，那我写测试有什么意义？这个问题也印证了我们前面所说的，软件开发与科学探索是具有一些相似性的。“唯一不变的就是变化”，对于绝大多数的真实世界问题来说，其复杂度和变化速度，都是很难以人类大脑来进行预先设计的，因此现代软件工程的核心其实也就集中在这两方面，“控制复杂度”和“反馈学习”。得益于软件易于改变的优势，我们得以应用敏捷模式，而不是其它现实世界工程中常用的瀑布模式。但这个思维的转变，其实需要很长时间才能逐渐成为大家的共识。\u003C\u002Fli\u003E\u003Cli data-pid=\"k3sxFw_G\"\u003E为什么测试和功能开发应该同步进行，而不是先写功能，等全部完成后再写测试呢？作为开发者，我们产出功能代码的速度总体来说是稳定的，修改完成后，你获得测试反馈的延迟越长，则这段时间内你作出的修改就越多。是 1 秒钟就知道自己代码写得对不对，还是 1 周后才知道，这个差别是巨大的。如果 1 周后才发现有问题，那么是不是这一周里做的很多东西都有可能要返工了？这也是 TDD 之类的思想产生的原因之一。\u003C\u002Fli\u003E\u003Cli data-pid=\"qQiA_cUB\"\u003E大家也经常提术业有专攻，如果自己测试自己写的代码，容易进入思维盲区。后面我们会详细讲到测试的分类，但是如果仅依赖传统质检步骤的端到端（e2e）测试，是有很多问题的。例如 e2e 测试的开发，执行与维护成本很高，需要覆盖的 case 数量更多，检查的粒度太粗，难以做变量控制等等。从获取反馈的质量角度来思考，e2e 测试也有不少缺陷，因为它把整个系统的复杂度都包含进去了。当出现 case 失败时，我们是不是还需要花更多的时间去定位问题，是数据问题吗，是环境配置的问题吗，是别的组件的问题吗，是网络抖动的问题吗，等等。而好的测试应该能非常精确的告诉我们出问题的地方在哪里，做好“变量控制”，使得测试本身也更加稳定和可信。\u003C\u002Fli\u003E\u003Cli data-pid=\"FYUiWmGK\"\u003E软件工程还有一个核心诉求是“控制复杂度”，而通过写测试，我们会成为自己设计的类和 API 的第一使用者，能更早的发现设计上的问题，尽量规避“偶然复杂度”。如果发现不好写测试，那么很可能就是我们的设计有问题，可能是 API 不够清晰，可能是不够模块化，可能是没有遵循高内聚低耦合的原则等等，可以及时进行优化。如果是写完代码再写测试，那么很可能就会偏向 end to end 的粗粒度测试，而到了几个月后要修改功能或添加新功能时，你仍然会遇到修改困难，需要重构的问题。所以至少写单元测试，应该跟开发功能的是同一个人才更能发挥出这些好处。\u003C\u002Fli\u003E\u003Cli data-pid=\"GcVp9dbG\"\u003E最后在团队协作层面，模块的开发者负责模块的测试也对于沟通成本的控制会有很大的好处。试想如果我们要造一辆汽车，所有的测试都要在整车拼装完成后在马路上进行，那样的话团队间的沟通成本，可能造成的返工风险，各个模块的可复用程度等都会大打折扣。仅仅依赖 e2e 测试，那么系统集成的开销和风险就会大幅上升。\u003C\u002Fli\u003E\u003C\u002Ful\u003E\u003Cp data-pid=\"8wbYvYOy\"\u003E综合这些点来看，要成为一名合格的现代软件工程师，自己的功能自己写测试是非常有必要的。且在绝大多数的先进公司，开源项目中，都已经成为了一种主流实践方式。\u003C\u002Fp\u003E\u003Ch2\u003E软件测试基本概念\u003C\u002Fh2\u003E\u003Cp data-pid=\"3lRNkA0s\"\u003E前面聊了这么多，终于要来上点干货了。以下内容很多来自于《\u003Ca href=\"https:\u002F\u002Flink.zhihu.com\u002F?target=https%3A\u002F\u002Fbook.douban.com\u002Fsubject\u002F34875994\u002F\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\"\u003ESoftware Engineering at Google\u003C\u002Fa\u003E》，《\u003Ca href=\"https:\u002F\u002Flink.zhihu.com\u002F?target=https%3A\u002F\u002Fbook.douban.com\u002Fsubject\u002F35817720\u002F\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\"\u003EEffective Software Testing\u003C\u002Fa\u003E》，《\u003Ca href=\"https:\u002F\u002Flink.zhihu.com\u002F?target=https%3A\u002F\u002Fbook.douban.com\u002Fsubject\u002F34429421\u002F\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\"\u003EUnit Testing\u003C\u002Fa\u003E》这三本书。尤其是最后一本，是我从业以来看过最好的一本关于测试的技术书籍，值得强烈推荐。\u003C\u002Fp\u003E\u003Ch3\u003E什么是好的测试\u003C\u002Fh3\u003E\u003Cp data-pid=\"JvA5svhq\"\u003E写测试也是需要有很多深入思考的，并不是大家印象中的“周边工作”。相信很多人就没有深入想过，到底什么才是一个好的测试？为什么有些项目也写了很多测试，但好像经常挂掉也没人去看，维护又要花很多时间，线上的 bug 也没有多少被抓到，好像完全成了摆设？\u003C\u002Fp\u003E\u003Cp data-pid=\"P6XAOsL3\"\u003E为了找到好测试的标准，我们先来看一下测试的目标是什么。如果没有测试或者测试的质量很差，会导致随着项目的推进，开发迭代速度出现剧烈下降。这样的现象被称为软件熵，也即代表了软件的腐化。好的测试的目标是保证软件的可持续发展，在长期开发之后，依然可以持续演进。\u003C\u002Fp\u003E\u003Cp class=\"ztext-empty-paragraph\"\u003E\u003Cbr\u002F\u003E\u003C\u002Fp\u003E\u003Cfigure data-size=\"normal\"\u003E\u003Cnoscript\u003E\u003Cimg src=\"https:\u002F\u002Fpic3.zhimg.com\u002Fv2-ef61b93990ca12b05a6566b53f41433a_b.jpg\" data-size=\"normal\" data-rawwidth=\"2162\" data-rawheight=\"1170\" class=\"origin_image zh-lightbox-thumb\" width=\"2162\" data-original=\"https:\u002F\u002Fpic3.zhimg.com\u002Fv2-ef61b93990ca12b05a6566b53f41433a_r.jpg\"\u002F\u003E\u003C\u002Fnoscript\u003E\u003Cimg src=\"data:image\u002Fsvg+xml;utf8,&lt;svg xmlns=&#39;http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg&#39; width=&#39;2162&#39; height=&#39;1170&#39;&gt;&lt;\u002Fsvg&gt;\" data-size=\"normal\" data-rawwidth=\"2162\" data-rawheight=\"1170\" class=\"origin_image zh-lightbox-thumb lazy\" width=\"2162\" data-original=\"https:\u002F\u002Fpic3.zhimg.com\u002Fv2-ef61b93990ca12b05a6566b53f41433a_r.jpg\" data-actualsrc=\"https:\u002F\u002Fpic3.zhimg.com\u002Fv2-ef61b93990ca12b05a6566b53f41433a_b.jpg\" data-original-token=\"v2-ed109cf0254896c23f5f834ed97a2f9f\"\u002F\u003E\u003Cfigcaption\u003E好的测试才能让项目持续可控\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp class=\"ztext-empty-paragraph\"\u003E\u003Cbr\u002F\u003E\u003C\u002Fp\u003E\u003Cp data-pid=\"YjAUzRR8\"\u003E具体来说，测试的目标包括：\u003C\u002Fp\u003E\u003Cul\u003E\u003Cli data-pid=\"WKpFLXLQ\"\u003E与研发流程紧密集成，达到前面所说的“实时反馈”的效果。\u003C\u002Fli\u003E\u003Cli data-pid=\"Hr8zXq9g\"\u003E针对代码库中最重要的部分进行测试，一般就是领域模型。\u003C\u002Fli\u003E\u003Cli data-pid=\"GXSZXPQs\"\u003E以最小的维护成本产出最大的价值。测试的维护成本包括：\u003C\u002Fli\u003E\u003Cul\u003E\u003Cli data-pid=\"CWkgNAOF\"\u003E重构功能代码时，有时候也需要重构测试。\u003C\u002Fli\u003E\u003Cli data-pid=\"pMfE_jM-\"\u003E每次代码变更时都需要执行测试，因此执行成本也需要考虑。\u003C\u002Fli\u003E\u003Cli data-pid=\"PhmlBF65\"\u003E测试报错时，需要进行排查和处理，尤其要注意误报。\u003C\u002Fli\u003E\u003Cli data-pid=\"Pdk2vkxr\"\u003E阅读和理解测试也需要投入时间。\u003C\u002Fli\u003E\u003C\u002Ful\u003E\u003C\u002Ful\u003E\u003Cp data-pid=\"bATy--i7\"\u003E如果仅仅只是增加测试用例的数量，并不能很好地实现控制软件熵的目标，同时也需要结合测试成本考虑总体的 ROI。一个好的自动化测试应该符合四条标准：\u003C\u002Fp\u003E\u003Cul\u003E\u003Cli data-pid=\"mbqI0AxE\"\u003E防止代码功能失效（regression）。为了起到更好的保护作用，测试执行时应该考虑去尽可能覆盖更多的代码，项目中复杂度高或者对于业务逻辑重要的部分。\u003C\u002Fli\u003E\u003Cli data-pid=\"p8hTovAu\"\u003E对重构友好。测试应该对可观测的领域行为进行测试与验证，而不是对于实现细节。因为实现细节是很容易被重构影响的，在软件行为没有发生改变时，不应该需要对测试代码做修改，减少测试失败的误报。\u003C\u002Fli\u003E\u003Cli data-pid=\"9nyQmqQ8\"\u003E快速反馈。测试跑得越快，我们就越可以频繁执行，实时发现问题，降低修复成本。\u003C\u002Fli\u003E\u003Cli data-pid=\"gd39jT6q\"\u003E可维护性。包括是否容易理解测试代码，是否容易执行测试。\u003C\u002Fli\u003E\u003C\u002Ful\u003E\u003Cp class=\"ztext-empty-paragraph\"\u003E\u003Cbr\u002F\u003E\u003C\u002Fp\u003E\u003Cfigure data-size=\"normal\"\u003E\u003Cnoscript\u003E\u003Cimg src=\"https:\u002F\u002Fpic1.zhimg.com\u002Fv2-4ae767775457e93eace4956ba6b8eac0_b.jpg\" data-size=\"normal\" data-rawwidth=\"2010\" data-rawheight=\"990\" class=\"origin_image zh-lightbox-thumb\" width=\"2010\" data-original=\"https:\u002F\u002Fpic1.zhimg.com\u002Fv2-4ae767775457e93eace4956ba6b8eac0_r.jpg\"\u002F\u003E\u003C\u002Fnoscript\u003E\u003Cimg src=\"data:image\u002Fsvg+xml;utf8,&lt;svg xmlns=&#39;http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg&#39; width=&#39;2010&#39; height=&#39;990&#39;&gt;&lt;\u002Fsvg&gt;\" data-size=\"normal\" data-rawwidth=\"2010\" data-rawheight=\"990\" class=\"origin_image zh-lightbox-thumb lazy\" width=\"2010\" data-original=\"https:\u002F\u002Fpic1.zhimg.com\u002Fv2-4ae767775457e93eace4956ba6b8eac0_r.jpg\" data-actualsrc=\"https:\u002F\u002Fpic1.zhimg.com\u002Fv2-4ae767775457e93eace4956ba6b8eac0_b.jpg\" data-original-token=\"v2-8261f57525f5f3b168dfb02bb9a68d6c\"\u002F\u003E\u003Cfigcaption\u003E提升测试的“准确率”\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp class=\"ztext-empty-paragraph\"\u003E\u003Cbr\u002F\u003E\u003C\u002Fp\u003E\u003Cp data-pid=\"QPN67mEb\"\u003E其中前两点分别对应了测试中的 false negative（测试没有报错，但其实有 bug）和 false positive（测试报错了，但其实没有 bug）这两类情况。对于成熟项目来说，因为测试的数量会非常大，重构的频率也会更高，所以控制 false positive 一般会更加重要。反复出现 false alarm，会很快让开发者丧失对测试的信任，从而失去其存在价值。\u003C\u002Fp\u003E\u003Cp data-pid=\"a3GvyNkF\"\u003E我们可以对上述四条标准打个分，而总体的测试价值是这四个得分的乘积。这意味着如果有任意一个维度得分为零，那么整体测试的价值就会迅速降到零。\u003C\u002Fp\u003E\u003Cp data-pid=\"WKzFvyUk\"\u003E是否存在完美的测试呢？其实上面提到的前三点之间，是有一些互斥性的，需要做一些权衡。举例来说：\u003C\u002Fp\u003E\u003Cul\u003E\u003Cli data-pid=\"MWpqZ1cS\"\u003E端到端测试有非常好的预防 regression 能力，并且对重构友好，但执行速度很慢。同时端到端测试也不好维护。\u003C\u002Fli\u003E\u003Cli data-pid=\"4b3kio0G\"\u003E无关紧要的测试满足重构友好和快速反馈，但对预防 regression 作用不大，例如用户名密码验证这类非常简单的逻辑。\u003C\u002Fli\u003E\u003Cli data-pid=\"gIr7IoSp\"\u003E脆弱（过于敏感）的测试可以预防 regression 并快速执行，但对重构不友好。例如检查非常具体的实现逻辑没有发生变化。\u003C\u002Fli\u003E\u003C\u002Ful\u003E\u003Cp class=\"ztext-empty-paragraph\"\u003E\u003Cbr\u002F\u003E\u003C\u002Fp\u003E\u003Cfigure data-size=\"normal\"\u003E\u003Cnoscript\u003E\u003Cimg src=\"https:\u002F\u002Fpic1.zhimg.com\u002Fv2-c2af648ca7dc4844622c6962f660d8f0_b.jpg\" data-size=\"normal\" data-rawwidth=\"1770\" data-rawheight=\"1342\" class=\"origin_image zh-lightbox-thumb\" width=\"1770\" data-original=\"https:\u002F\u002Fpic1.zhimg.com\u002Fv2-c2af648ca7dc4844622c6962f660d8f0_r.jpg\"\u002F\u003E\u003C\u002Fnoscript\u003E\u003Cimg src=\"data:image\u002Fsvg+xml;utf8,&lt;svg xmlns=&#39;http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg&#39; width=&#39;1770&#39; height=&#39;1342&#39;&gt;&lt;\u002Fsvg&gt;\" data-size=\"normal\" data-rawwidth=\"1770\" data-rawheight=\"1342\" class=\"origin_image zh-lightbox-thumb lazy\" width=\"1770\" data-original=\"https:\u002F\u002Fpic1.zhimg.com\u002Fv2-c2af648ca7dc4844622c6962f660d8f0_r.jpg\" data-actualsrc=\"https:\u002F\u002Fpic1.zhimg.com\u002Fv2-c2af648ca7dc4844622c6962f660d8f0_b.jpg\" data-original-token=\"v2-1978bcd69f9620d141141ce7bc2d7c5d\"\u002F\u003E\u003Cfigcaption\u003E测试价值的取舍\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp class=\"ztext-empty-paragraph\"\u003E\u003Cbr\u002F\u003E\u003C\u002Fp\u003E\u003Cp data-pid=\"euW8Cep2\"\u003E考虑到实际中，是否重构友好往往是个非零即一的选项，所以一般无法在这一点上做妥协，我们只能在剩下的两点里做选择。例如 e2e 测试会更偏向防止代码功能失效，而典型的单元测试则更偏向于快速反馈。\u003C\u002Fp\u003E\u003Ch3\u003E测试的种类\u003C\u002Fh3\u003E\u003Cp data-pid=\"vzeM851n\"\u003E既然聊到了不同测试在测试价值上的取舍，那自然就引出了不同测试的类型的问题。很多同学都会问，到底什么才算是单元测试？是测试一个具体的函数\u002F方法，还是测试一个具体的类？这个粒度要有多细才能算单元测试呢？\u003C\u002Fp\u003E\u003Cp data-pid=\"YpuG7UKV\"\u003E个人认为有两种定义比较好理解和执行：\u003C\u002Fp\u003E\u003Cul\u003E\u003Cli data-pid=\"4_rZdxwL\"\u003E单元指的应该是“业务功能单元”而不是类或者方法。为了实现一个业务功能，具体的实现，类和方法的拆分粒度都是在过程中可以重构的，测试本身不应该受到实现细节的影响，否则会变得支离破碎，难以理解和维护。\u003C\u002Fli\u003E\u003Cli data-pid=\"PcaCgaTf\"\u003EGoogle 软件工程的书中提到，他们把测试分成单个进程，单台机器，多台机器这三种类型。其中单元测试基本对应的是单进程中执行的小型测试。如果我们依赖了真实的数据库实例，那么显然就是跨进程了。\u003C\u002Fli\u003E\u003C\u002Ful\u003E\u003Cp data-pid=\"jO-3wH_6\"\u003E这两种定义下的单元测试都有比较明确的特点，如：\u003C\u002Fp\u003E\u003Cul\u003E\u003Cli data-pid=\"uHno2C0q\"\u003E每个测试验证一个业务单元的执行。\u003C\u002Fli\u003E\u003Cli data-pid=\"nuyYIxXd\"\u003E能够快速运行。\u003C\u002Fli\u003E\u003Cli data-pid=\"tyosY5Ai\"\u003E测试之间相互独立，可以同时运行多个测试而不会互相影响。\u003C\u002Fli\u003E\u003C\u002Ful\u003E\u003Cp data-pid=\"PBWiWaTB\"\u003E在这个基础上，集成测试会引入外部的依赖进行验证。而端到端测试可以算是集成测试的最极端的情况，完全使用真实组件来完成测试，例如直接在网页端进行点击操作，验证结果。Google 提到的中型和大型测试也基本可以对应上这两类测试。\u003C\u002Fp\u003E\u003Cp class=\"ztext-empty-paragraph\"\u003E\u003Cbr\u002F\u003E\u003C\u002Fp\u003E\u003Cfigure data-size=\"normal\"\u003E\u003Cnoscript\u003E\u003Cimg src=\"https:\u002F\u002Fpic3.zhimg.com\u002Fv2-4209e3b2bfc0d86fd8ae4a0a9316a066_b.jpg\" data-size=\"normal\" data-rawwidth=\"1960\" data-rawheight=\"1524\" class=\"origin_image zh-lightbox-thumb\" width=\"1960\" data-original=\"https:\u002F\u002Fpic3.zhimg.com\u002Fv2-4209e3b2bfc0d86fd8ae4a0a9316a066_r.jpg\"\u002F\u003E\u003C\u002Fnoscript\u003E\u003Cimg src=\"data:image\u002Fsvg+xml;utf8,&lt;svg xmlns=&#39;http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg&#39; width=&#39;1960&#39; height=&#39;1524&#39;&gt;&lt;\u002Fsvg&gt;\" data-size=\"normal\" data-rawwidth=\"1960\" data-rawheight=\"1524\" class=\"origin_image zh-lightbox-thumb lazy\" width=\"1960\" data-original=\"https:\u002F\u002Fpic3.zhimg.com\u002Fv2-4209e3b2bfc0d86fd8ae4a0a9316a066_r.jpg\" data-actualsrc=\"https:\u002F\u002Fpic3.zhimg.com\u002Fv2-4209e3b2bfc0d86fd8ae4a0a9316a066_b.jpg\" data-original-token=\"v2-de86b2187ebb7182bb8c1b7f976761d4\"\u002F\u003E\u003Cfigcaption\u003E测试的不同种类\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp class=\"ztext-empty-paragraph\"\u003E\u003Cbr\u002F\u003E\u003C\u002Fp\u003E\u003Cp data-pid=\"xikaYFug\"\u003E有了这三种测试的分类，就可以引出很多人都听说过的经典测试金字塔了：\u003C\u002Fp\u003E\u003Cp class=\"ztext-empty-paragraph\"\u003E\u003Cbr\u002F\u003E\u003C\u002Fp\u003E\u003Cfigure data-size=\"normal\"\u003E\u003Cnoscript\u003E\u003Cimg src=\"https:\u002F\u002Fpic1.zhimg.com\u002Fv2-bc8cba1fa7639cb5f2eb824e74e16654_b.jpg\" data-size=\"normal\" data-rawwidth=\"1492\" data-rawheight=\"1266\" class=\"origin_image zh-lightbox-thumb\" width=\"1492\" data-original=\"https:\u002F\u002Fpic1.zhimg.com\u002Fv2-bc8cba1fa7639cb5f2eb824e74e16654_r.jpg\"\u002F\u003E\u003C\u002Fnoscript\u003E\u003Cimg src=\"data:image\u002Fsvg+xml;utf8,&lt;svg xmlns=&#39;http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg&#39; width=&#39;1492&#39; height=&#39;1266&#39;&gt;&lt;\u002Fsvg&gt;\" data-size=\"normal\" data-rawwidth=\"1492\" data-rawheight=\"1266\" class=\"origin_image zh-lightbox-thumb lazy\" width=\"1492\" data-original=\"https:\u002F\u002Fpic1.zhimg.com\u002Fv2-bc8cba1fa7639cb5f2eb824e74e16654_r.jpg\" data-actualsrc=\"https:\u002F\u002Fpic1.zhimg.com\u002Fv2-bc8cba1fa7639cb5f2eb824e74e16654_b.jpg\" data-original-token=\"v2-c03380d6e10f43700dfa6f777c2a2361\"\u002F\u003E\u003Cfigcaption\u003E测试金字塔\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp class=\"ztext-empty-paragraph\"\u003E\u003Cbr\u002F\u003E\u003C\u002Fp\u003E\u003Cp data-pid=\"FbNE6sDO\"\u003E由于单元测试本身专注于足够小的业务单元，执行又快，而且没有外部依赖更加稳定，因此很自然的一个想法就是在可能的情况下，都应该使用单元测试来覆盖功能验证。\u003C\u002Fp\u003E\u003Cp data-pid=\"IdT0HZxi\"\u003E例如一个系统有 3 个模块，每个模块又有 10 种不同的场景，如果我们只能通过端到端集成测试来做，需要的测试用例可能就需要 10 * 10 * 10 这个量级。而且不同的场景可能需要复杂的准备，例如有些需要保持数据库里没有数据，有些又需要预先有些数据，有些还需要特定组件抛出错误等。这些准备工作进一步加大了测试准备所需要的耗时，同时也会让这些测试之间很难共享依赖并发执行。集成测试还可能碰到环境不稳定的问题，也容易提升测试误报的可能。种种问题叠加起来，也不难理解即使集成测试会使用更多的“真实组件”，但在实践过程中仍然不是一个好的选择。\u003C\u002Fp\u003E\u003Cp data-pid=\"m9uxsU8W\"\u003E当然测试金字塔也有例外情况，例如业务逻辑越简单，则单元测试能发挥的作用就越小。或者外部依赖较少，使用真实依赖的成本较低时，也可以增加集成测试的数量。所以不同项目的测试金字塔构成比例也会因项目特性而有所不同。\u003C\u002Fp\u003E\u003Ch3\u003E什么是测试替代\u003C\u002Fh3\u003E\u003Cp data-pid=\"2UyVGuM1\"\u003E为了在更多的场景下能够使用单元测试来覆盖场景，我们就需要引入一些测试替代（test doubles）来帮助我们模拟外部依赖。很多书里会区分 dummy，stub，fake，mock，spy 等概念，再加上很多框架自己就叫 mockxxx，经常让人看的有些云里雾里不明所以。\u003C\u002Fp\u003E\u003Cp data-pid=\"ajWLPIrX\"\u003EUnit Testing 这本书里给出了很系统化的分类方法，主要就分成两类：\u003C\u002Fp\u003E\u003Cul\u003E\u003Cli data-pid=\"9It9JSrh\"\u003E自内向外调用的模拟和检查，称为 mock。例如系统在用户注册成功后会发送一封邮件，那么我们需要检查是否调用了邮件服务来确认这个行为。\u003C\u002Fli\u003E\u003Cli data-pid=\"5d8QFtk1\"\u003E自外向内获取的模拟，称为 stub。例如从数据库中查询某个用户的信息，我们只需要模拟返回信息即可，不需要去检查是否真的做了数据库调用。\u003C\u002Fli\u003E\u003C\u002Ful\u003E\u003Cp class=\"ztext-empty-paragraph\"\u003E\u003Cbr\u002F\u003E\u003C\u002Fp\u003E\u003Cfigure data-size=\"normal\"\u003E\u003Cnoscript\u003E\u003Cimg src=\"https:\u002F\u002Fpic3.zhimg.com\u002Fv2-3a789efb78acd3e92974c7a7515e8ff6_b.jpg\" data-size=\"normal\" data-rawwidth=\"2234\" data-rawheight=\"1020\" class=\"origin_image zh-lightbox-thumb\" width=\"2234\" data-original=\"https:\u002F\u002Fpic3.zhimg.com\u002Fv2-3a789efb78acd3e92974c7a7515e8ff6_r.jpg\"\u002F\u003E\u003C\u002Fnoscript\u003E\u003Cimg src=\"data:image\u002Fsvg+xml;utf8,&lt;svg xmlns=&#39;http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg&#39; width=&#39;2234&#39; height=&#39;1020&#39;&gt;&lt;\u002Fsvg&gt;\" data-size=\"normal\" data-rawwidth=\"2234\" data-rawheight=\"1020\" class=\"origin_image zh-lightbox-thumb lazy\" width=\"2234\" data-original=\"https:\u002F\u002Fpic3.zhimg.com\u002Fv2-3a789efb78acd3e92974c7a7515e8ff6_r.jpg\" data-actualsrc=\"https:\u002F\u002Fpic3.zhimg.com\u002Fv2-3a789efb78acd3e92974c7a7515e8ff6_b.jpg\" data-original-token=\"v2-22ddf2d07f8782fdfd86549676c1f2ab\"\u002F\u003E\u003Cfigcaption\u003E测试替代的不同类型\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp class=\"ztext-empty-paragraph\"\u003E\u003Cbr\u002F\u003E\u003C\u002Fp\u003E\u003Cp data-pid=\"ugm_Jcu8\"\u003E为什么 mock 需要做调用的检查，而 stub 却不需要呢？这又回到了我们之前提到过的对重构友好的重要原则：应该测试可观测的行为状态，而不是实现细节。对外发送一封邮件，这件事情最终是会被用户感受到的，所以属于“可观测的行为状态”，需要进行检查。而从数据库中获取用户信息，则不属于用户可以观测到的行为，而是实现细节。我们完全可以改成从不同的数据库中获取，或者从缓存中获取等等其他实现方式。\u003C\u002Fp\u003E\u003Cp data-pid=\"3aNvfaXk\"\u003E所以在这里，选择 mock 还是 stub 就有了个比较明确的标准：当被测组件向外调用的行为属于可观测行为状态时，才使用 mock，其它情况下使用 stub 即可。\u003C\u002Fp\u003E\u003Cp data-pid=\"OpNy9Pls\"\u003E不过问题到这里也还没结束，两本书中都提到了对于测试替代，业界还有两种不同的流派，分别是伦敦派与经典派。前面提到单元测试应该是相互隔离可以独立运行的，而这两个流派之间的主要分歧就在于对测试隔离范围的区别。\u003C\u002Fp\u003E\u003Cp data-pid=\"8TZMiN_Y\"\u003E对于测试的外部依赖，我们可以分为两大类，分别是共享和私有。对于共享的依赖，如数据库，消息队列，第三方 API 需要被独立开来（测试替代），使得测试可以独立执行。这点对于两个流派来说都是一致的。\u003C\u002Fp\u003E\u003Cp data-pid=\"OYRqUsbZ\"\u003E而私有依赖这部分，又可以区分为可变依赖和只读依赖。例如我当前正在测试用户购买行为，其中涉及到两个外部依赖，一个是商品，一个是库存。当进行购买时，商品只提供名称信息，是个只读对象；而库存则需要在购买成功后进行库存扣减操作，是个可变对象。这里就出现了两种流派的区别：伦敦派会替代掉私有依赖中的可变对象，而经典派则倾向于在私有依赖中都使用真实对象而不是测试替代。\u003C\u002Fp\u003E\u003Cp class=\"ztext-empty-paragraph\"\u003E\u003Cbr\u002F\u003E\u003C\u002Fp\u003E\u003Cfigure data-size=\"normal\"\u003E\u003Cnoscript\u003E\u003Cimg src=\"https:\u002F\u002Fpic1.zhimg.com\u002Fv2-9714b6c5d61c8b64f3a92f926422c168_b.jpg\" data-size=\"normal\" data-rawwidth=\"1912\" data-rawheight=\"1264\" class=\"origin_image zh-lightbox-thumb\" width=\"1912\" data-original=\"https:\u002F\u002Fpic1.zhimg.com\u002Fv2-9714b6c5d61c8b64f3a92f926422c168_r.jpg\"\u002F\u003E\u003C\u002Fnoscript\u003E\u003Cimg src=\"data:image\u002Fsvg+xml;utf8,&lt;svg xmlns=&#39;http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg&#39; width=&#39;1912&#39; height=&#39;1264&#39;&gt;&lt;\u002Fsvg&gt;\" data-size=\"normal\" data-rawwidth=\"1912\" data-rawheight=\"1264\" class=\"origin_image zh-lightbox-thumb lazy\" width=\"1912\" data-original=\"https:\u002F\u002Fpic1.zhimg.com\u002Fv2-9714b6c5d61c8b64f3a92f926422c168_r.jpg\" data-actualsrc=\"https:\u002F\u002Fpic1.zhimg.com\u002Fv2-9714b6c5d61c8b64f3a92f926422c168_b.jpg\" data-original-token=\"v2-ccea31e469d70a473156628d2c631ebf\"\u002F\u003E\u003Cfigcaption\u003E伦敦派与经典派的区别\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp class=\"ztext-empty-paragraph\"\u003E\u003Cbr\u002F\u003E\u003C\u002Fp\u003E\u003Cp data-pid=\"tjN6Y9E3\"\u003E在 Google 的那本书中，也提到他们对于测试替代的态度在两者之间游走。当前他们更倾向于完全不使用 mock，偶尔考虑使用 stub\u002Ffake，主要原因也是怕过多依赖 mock 会有 over specification 的问题（例如检查具体发出的邮件是什么），使得测试变得更加脆弱。可以说他们的实践是一种更加严格的经典派做法。\u003C\u002Fp\u003E\u003Ch3\u003E如何看待覆盖率\u003C\u002Fh3\u003E\u003Cp data-pid=\"qogQHSsn\"\u003E前面提到测试的价值标准，很多人可能会想到代码覆盖率这个经常被提起的概念。这里的覆盖率又分成好几种，包括：\u003C\u002Fp\u003E\u003Cul\u003E\u003Cli data-pid=\"YxhFZpF2\"\u003E代码行覆盖\u003C\u002Fli\u003E\u003Cli data-pid=\"rOPapQQP\"\u003E分支\u002F条件覆盖\u003C\u002Fli\u003E\u003Cli data-pid=\"f78SWLcn\"\u003E执行路径覆盖\u003C\u002Fli\u003E\u003C\u002Ful\u003E\u003Cp data-pid=\"1jSQzC5K\"\u003E不过目前绝大多数工具提供的还是代码行覆盖，辅助会带一些条件覆盖的指示（部分条件覆盖会显示黄色）。所以我们一般讨论的也是以行覆盖率指标为主。\u003C\u002Fp\u003E\u003Cp data-pid=\"oXUBXB59\"\u003E覆盖率本身与测试价值是一个相关性指标，我们总体的评判标准是：低的代码覆盖率，一般来说是不好的，但高的代码覆盖率并不一定表示测试是优秀的。例如极端的例子如果测试中只有逻辑执行，没有 assertion 检查，那么 100% 覆盖率也是没有意义的。同理回到前面测试价值的评判标准，如果某些逻辑简单，或者非核心业务逻辑的代码，我们可能也没有必要去追求高覆盖率。\u003C\u002Fp\u003E\u003Ch2\u003E软件测试最佳实践\u003C\u002Fh2\u003E\u003Cp data-pid=\"_DMAHNLr\"\u003E前面梳理了一下软件测试的基本概念，接下来我们来看下一些最佳实践，具体怎么来写高价值的自动化测试，以及测试本身对于优良架构设计的促进作用。\u003C\u002Fp\u003E\u003Ch3\u003E单元测试的构成\u003C\u002Fh3\u003E\u003Cp data-pid=\"C65q1t90\"\u003E一般来说，单元测试的构成分三个部分：\u003C\u002Fp\u003E\u003Cul\u003E\u003Cli data-pid=\"hRVpKYtN\"\u003EArrange：把被测对象和环境依赖设置到目标状态。\u003C\u002Fli\u003E\u003Cli data-pid=\"_t1cSvJz\"\u003EAct：调用被测对象的方法，执行操作。\u003C\u002Fli\u003E\u003Cli data-pid=\"y4tFKp79\"\u003EAssert：验证结果的正确性，包括返回值，被测对象的状态，与外界的预期交互行为等所有属于可观测行为状态的内容。\u003C\u002Fli\u003E\u003C\u002Ful\u003E\u003Cp data-pid=\"S-rclgyb\"\u003EGiven-When-Then 模式与上述的 AAA 模式是等价的。\u003C\u002Fp\u003E\u003Cp data-pid=\"NTXv2QLj\"\u003E一般来说，一个单测里应该只有一组 AAA 的流程，保证验证场景的聚焦与清晰。在集成测试中，可能一些环境的 arrange 开销会比较大，所以有时候会考虑将之前的 arrange\u002Fact 给后续操作复用，例如先创建用户，验证用户创建成功，然后继续验证该用户的其它操作场景。\u003C\u002Fp\u003E\u003Cp data-pid=\"8FTqxzaX\"\u003E写测试中经常碰到的一个问题是 arrange 部分比较复杂，可以考虑引入一些设计模式，例如 object mother 和 test data builder 等，抽取一些共用方法来提效。这也属于对 test infra 的投入，会提升开发者写测试的效率。单元测试一般不太需要公共的 setup 和 teardown，共享的 arrange 可能会导致测试间的高度耦合，破坏测试之间的独立性。但在集成测试中很多 setup 是可能共用的，而且集成测试一般没法并行执行，可以在集成测试的基类中定义这些可复用的 fixture。\u003C\u002Fp\u003E\u003Cp data-pid=\"B2jid6g9\"\u003EAct 部分一般一行代码调用就足够了，如果发现这部分的代码行数比较多，需要注意是否是 public API 的设计有问题。还是以测试购买行为为例，如果在操作时需要分别调用购买操作和库存扣减操作，那么显然就破坏了封装性。如果客户端只调用了购买，而忘了调用库存扣减，就会导致状态的不一致（invariant violation）。\u003C\u002Fp\u003E\u003Cp data-pid=\"dJ1rv4D2\"\u003EAssertion 部分倒没有严格要求只用一行调用来验证，因为可观测的行为状态可能是多方面的，例如返回值，对象状态，外部调用行为等。要注意我们应该对可观测行为和状态进行检查，而不是实现细节。例如我们对返回 json 结构做原封不动的检查，可能就是不太好的实践，其中可能有些信息属于实现细节，这部分做重构优化时就很容易 break 测试。\u003C\u002Fp\u003E\u003Cp class=\"ztext-empty-paragraph\"\u003E\u003Cbr\u002F\u003E\u003C\u002Fp\u003E\u003Cfigure data-size=\"normal\"\u003E\u003Cnoscript\u003E\u003Cimg src=\"https:\u002F\u002Fpic4.zhimg.com\u002Fv2-d43cb5f72371734c0f51eab15ff79ae3_b.jpg\" data-size=\"normal\" data-rawwidth=\"2252\" data-rawheight=\"992\" class=\"origin_image zh-lightbox-thumb\" width=\"2252\" data-original=\"https:\u002F\u002Fpic4.zhimg.com\u002Fv2-d43cb5f72371734c0f51eab15ff79ae3_r.jpg\"\u002F\u003E\u003C\u002Fnoscript\u003E\u003Cimg src=\"data:image\u002Fsvg+xml;utf8,&lt;svg xmlns=&#39;http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg&#39; width=&#39;2252&#39; height=&#39;992&#39;&gt;&lt;\u002Fsvg&gt;\" data-size=\"normal\" data-rawwidth=\"2252\" data-rawheight=\"992\" class=\"origin_image zh-lightbox-thumb lazy\" width=\"2252\" data-original=\"https:\u002F\u002Fpic4.zhimg.com\u002Fv2-d43cb5f72371734c0f51eab15ff79ae3_r.jpg\" data-actualsrc=\"https:\u002F\u002Fpic4.zhimg.com\u002Fv2-d43cb5f72371734c0f51eab15ff79ae3_b.jpg\" data-original-token=\"v2-62f038c020f61352c697cba19b9ffda7\"\u002F\u003E\u003Cfigcaption\u003E不要验证实现细节\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp class=\"ztext-empty-paragraph\"\u003E\u003Cbr\u002F\u003E\u003C\u002Fp\u003E\u003Cp data-pid=\"Bwbl7Gtd\"\u003E另外要注意的是当 assertion 失败时的报错信息是否友好，很多时候只看到一个 expected False actual True 这样的信息显然是很难理解和定位问题的。有一些类似 AssertJ 的库可以帮助我们提升代码本身的可读性以及报错\u002Fcallstack 的友好性。\u003C\u002Fp\u003E\u003Cp data-pid=\"sqLoq0BJ\"\u003E除了结构外，也需要格外注意测试代码的可读性，包括测试函数的命名应该更贴近场景描述的自然语言，而不是跟具体的类名、方法名挂钩。同时也需要考虑减少重复代码，其它变量名，方法名的可读性等，这个跟功能代码是一致的。Google 的书中提到测试代码应该逻辑简单，不要有 if，for 循环这类，甚至可以允许一定的代码重复，一切以可理解性为前提。个人同意尽量减少测试代码的圈复杂度，但还是觉得也需要考虑一下可维护性，抽取一些共用方法，使用 property based 测试等。除了验证功能是否正常，可读性良好的测试也可以作为一种可以执行的文档帮助新人快速上手项目。\u003C\u002Fp\u003E\u003Ch3\u003E如何系统性地写测试\u003C\u002Fh3\u003E\u003Cp data-pid=\"Ie3HOz2T\"\u003EEffective Software Testing 中，给出了系统化的进行测试的步骤：\u003C\u002Fp\u003E\u003Cp class=\"ztext-empty-paragraph\"\u003E\u003Cbr\u002F\u003E\u003C\u002Fp\u003E\u003Cfigure data-size=\"normal\"\u003E\u003Cnoscript\u003E\u003Cimg src=\"https:\u002F\u002Fpic4.zhimg.com\u002Fv2-e993a03bb248efbd947491c84fa90303_b.jpg\" data-size=\"normal\" data-rawwidth=\"2370\" data-rawheight=\"1630\" class=\"origin_image zh-lightbox-thumb\" width=\"2370\" data-original=\"https:\u002F\u002Fpic4.zhimg.com\u002Fv2-e993a03bb248efbd947491c84fa90303_r.jpg\"\u002F\u003E\u003C\u002Fnoscript\u003E\u003Cimg src=\"data:image\u002Fsvg+xml;utf8,&lt;svg xmlns=&#39;http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg&#39; width=&#39;2370&#39; height=&#39;1630&#39;&gt;&lt;\u002Fsvg&gt;\" data-size=\"normal\" data-rawwidth=\"2370\" data-rawheight=\"1630\" class=\"origin_image zh-lightbox-thumb lazy\" width=\"2370\" data-original=\"https:\u002F\u002Fpic4.zhimg.com\u002Fv2-e993a03bb248efbd947491c84fa90303_r.jpg\" data-actualsrc=\"https:\u002F\u002Fpic4.zhimg.com\u002Fv2-e993a03bb248efbd947491c84fa90303_b.jpg\" data-original-token=\"v2-98ddfe619df58f83b4a9b346820a0462\"\u002F\u003E\u003Cfigcaption\u003E系统化测试\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp class=\"ztext-empty-paragraph\"\u003E\u003Cbr\u002F\u003E\u003C\u002Fp\u003E\u003Cp data-pid=\"45OqiIZi\"\u003E主要关注右边方框里的内容。首先是基于软件的功能 spec 来开发测试：\u003C\u002Fp\u003E\u003Cp class=\"ztext-empty-paragraph\"\u003E\u003Cbr\u002F\u003E\u003C\u002Fp\u003E\u003Cfigure data-size=\"normal\"\u003E\u003Cnoscript\u003E\u003Cimg src=\"https:\u002F\u002Fpic2.zhimg.com\u002Fv2-d3a0876dabb8272684d85265a6a06221_b.jpg\" data-size=\"normal\" data-rawwidth=\"2180\" data-rawheight=\"594\" class=\"origin_image zh-lightbox-thumb\" width=\"2180\" data-original=\"https:\u002F\u002Fpic2.zhimg.com\u002Fv2-d3a0876dabb8272684d85265a6a06221_r.jpg\"\u002F\u003E\u003C\u002Fnoscript\u003E\u003Cimg src=\"data:image\u002Fsvg+xml;utf8,&lt;svg xmlns=&#39;http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg&#39; width=&#39;2180&#39; height=&#39;594&#39;&gt;&lt;\u002Fsvg&gt;\" data-size=\"normal\" data-rawwidth=\"2180\" data-rawheight=\"594\" class=\"origin_image zh-lightbox-thumb lazy\" width=\"2180\" data-original=\"https:\u002F\u002Fpic2.zhimg.com\u002Fv2-d3a0876dabb8272684d85265a6a06221_r.jpg\" data-actualsrc=\"https:\u002F\u002Fpic2.zhimg.com\u002Fv2-d3a0876dabb8272684d85265a6a06221_b.jpg\" data-original-token=\"v2-93f15c2af32c194e7174e9b2339407a2\"\u002F\u003E\u003Cfigcaption\u003ESpec Testing\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp class=\"ztext-empty-paragraph\"\u003E\u003Cbr\u002F\u003E\u003C\u002Fp\u003E\u003Cp data-pid=\"3UZEhmzx\"\u003E个人理解具体展开包括：\u003C\u002Fp\u003E\u003Cul\u003E\u003Cli data-pid=\"t_bSgx-k\"\u003E识别程序的每一个输入参数，它的类型是什么，可能的范围，特殊取值等。\u003C\u002Fli\u003E\u003Cli data-pid=\"NMIbAmbA\"\u003E识别参数之间的相互关系，思考其可能的组合情况有哪些。\u003C\u002Fli\u003E\u003Cli data-pid=\"2-PEnd21\"\u003E识别程序的输出，其类型，可能的范围，特殊值等，反推需要覆盖的情况。\u003C\u002Fli\u003E\u003Cli data-pid=\"sB3J-ITh\"\u003E识别代码中的各种边界条件，及相关的组合情况。\u003C\u002Fli\u003E\u003Cli data-pid=\"ZI92mnic\"\u003E基于业务定义 spec，针对上述的 case 进行发散性思考，查漏补缺。\u003C\u002Fli\u003E\u003C\u002Ful\u003E\u003Cp data-pid=\"JGN3Mw70\"\u003E这里尤其重要的是特殊值与边界条件的分析，也是最容易出现 bug 的地方。例如判断条件是\u003Ccode\u003Ex &gt;= 10\u003C\u002Fcode\u003E，那么就需要在\u003Ccode\u003Ex = 10\u003C\u002Fcode\u003E和\u003Ccode\u003Ex = 11\u003C\u002Fcode\u003E这两个边界点上分别构造测试用例。\u003C\u002Fp\u003E\u003Cp data-pid=\"KcXbsrvI\"\u003E完成 spec testing 步骤后，我们可以进一步引入 structual testing，即前面提到的代码行覆盖的分析，辅助我们去完善测试用例。\u003C\u002Fp\u003E\u003Cp class=\"ztext-empty-paragraph\"\u003E\u003Cbr\u002F\u003E\u003C\u002Fp\u003E\u003Cfigure data-size=\"normal\"\u003E\u003Cnoscript\u003E\u003Cimg src=\"https:\u002F\u002Fpic1.zhimg.com\u002Fv2-8d55cebadea50b2df2db6666bddf57a8_b.jpg\" data-size=\"normal\" data-rawwidth=\"1834\" data-rawheight=\"992\" class=\"origin_image zh-lightbox-thumb\" width=\"1834\" data-original=\"https:\u002F\u002Fpic1.zhimg.com\u002Fv2-8d55cebadea50b2df2db6666bddf57a8_r.jpg\"\u002F\u003E\u003C\u002Fnoscript\u003E\u003Cimg src=\"data:image\u002Fsvg+xml;utf8,&lt;svg xmlns=&#39;http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg&#39; width=&#39;1834&#39; height=&#39;992&#39;&gt;&lt;\u002Fsvg&gt;\" data-size=\"normal\" data-rawwidth=\"1834\" data-rawheight=\"992\" class=\"origin_image zh-lightbox-thumb lazy\" width=\"1834\" data-original=\"https:\u002F\u002Fpic1.zhimg.com\u002Fv2-8d55cebadea50b2df2db6666bddf57a8_r.jpg\" data-actualsrc=\"https:\u002F\u002Fpic1.zhimg.com\u002Fv2-8d55cebadea50b2df2db6666bddf57a8_b.jpg\" data-original-token=\"v2-4e9f220e7760ff850db80716f931f156\"\u002F\u003E\u003Cfigcaption\u003EStructual Testing\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp class=\"ztext-empty-paragraph\"\u003E\u003Cbr\u002F\u003E\u003C\u002Fp\u003E\u003Cp data-pid=\"TLJym2o-\"\u003E通过代码行覆盖工具（例如 IntelliJ 中自带的，或者 JaCoCo 等），可以检查我们当前的测试用例覆盖度情况。对于还没有覆盖到的部分，分析是否需要添加用例来进行覆盖。我个人的标准是对于领域核心文件，一般要求达到 100% 的覆盖率。\u003C\u002Fp\u003E\u003Cp data-pid=\"UC5gIjFu\"\u003E在高代码覆盖率的基础上，我们还可以引入 mutaition testing。这是一个很有意思的技术，通过分析代码结构，去随机对功能代码做出修改，然后再执行相关的测试用例。如果修改后的代码（称为变种人）导致测试失败了，那么说明测试对于预防代码功能失效有着比较高的覆盖率。而如果修改后的代码如果还是成功跑通了，那就有可能说明测试用例不够完善。\u003C\u002Fp\u003E\u003Cp class=\"ztext-empty-paragraph\"\u003E\u003Cbr\u002F\u003E\u003C\u002Fp\u003E\u003Cfigure data-size=\"normal\"\u003E\u003Cnoscript\u003E\u003Cimg src=\"https:\u002F\u002Fpic4.zhimg.com\u002Fv2-fda912bc7533fb3a12020925e9e5cc67_b.jpg\" data-size=\"normal\" data-rawwidth=\"2562\" data-rawheight=\"1172\" class=\"origin_image zh-lightbox-thumb\" width=\"2562\" data-original=\"https:\u002F\u002Fpic4.zhimg.com\u002Fv2-fda912bc7533fb3a12020925e9e5cc67_r.jpg\"\u002F\u003E\u003C\u002Fnoscript\u003E\u003Cimg src=\"data:image\u002Fsvg+xml;utf8,&lt;svg xmlns=&#39;http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg&#39; width=&#39;2562&#39; height=&#39;1172&#39;&gt;&lt;\u002Fsvg&gt;\" data-size=\"normal\" data-rawwidth=\"2562\" data-rawheight=\"1172\" class=\"origin_image zh-lightbox-thumb lazy\" width=\"2562\" data-original=\"https:\u002F\u002Fpic4.zhimg.com\u002Fv2-fda912bc7533fb3a12020925e9e5cc67_r.jpg\" data-actualsrc=\"https:\u002F\u002Fpic4.zhimg.com\u002Fv2-fda912bc7533fb3a12020925e9e5cc67_b.jpg\" data-original-token=\"v2-11cf071e2a76591a66a7fd60827a8bc0\"\u002F\u003E\u003Cfigcaption\u003EMutation Testing\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp class=\"ztext-empty-paragraph\"\u003E\u003Cbr\u002F\u003E\u003C\u002Fp\u003E\u003Cp data-pid=\"1LwILMOV\"\u003E一般来说这三个步骤下来，我们的单元测试覆盖应该已经能达到一个及格线以上的水平了。后续像发现 bugfix 应该同步带上相关的单元测试等也是很多项目的常规做法，在此就不多做赘述。关于集成测试和端到端测试，我们放到后面再展开。\u003C\u002Fp\u003E\u003Ch3\u003E测试与代码设计的关系\u003C\u002Fh3\u003E\u003Cp data-pid=\"kkqC4e5t\"\u003E前面我们已经提到很多次，如果发现测试不好写，可能跟代码设计不够好有关系。还有一些常见的问题包括，我是否应该测试 private API？什么情况下我应该用单元测试来覆盖，什么时候应该写集成测试？接下来我们就来展开看下这个话题。\u003C\u002Fp\u003E\u003Cp data-pid=\"F_khuJBA\"\u003E现代软件工程的两个重要目标是控制软件整体的复杂度和快速获取反馈适应变化。前面我们看到测试可以在获取反馈方面给我们提供巨大的帮助，而且事实上测试对于控制复杂度方面也有很大的作用。\u003C\u002Fp\u003E\u003Cp data-pid=\"ZP76mt0G\"\u003E很多同学在写测试时会碰到一个问题，被测对象的依赖非常多，需要把它构建出来就很困难。这可能是我们在设计这个类时，没有很好地遵循单一职责原则。一个类如果要做太多事情，不够内聚，那么很可能就会变成一个边界模糊的“大杂烩”，依赖了一堆其它类来完成各不相同的工作，导致系统的耦合度也过高。对于我们的核心领域模型来说，应该尽可能做清晰的职责划分，减少依赖交互方。\u003C\u002Fp\u003E\u003Cp data-pid=\"2Hsau-7s\"\u003E也有同学会说，感觉 private API 比较复杂，需要做测试，但发现很多框架不支持 private API 的测试。这也是因为测试需要验证的应该是可观测行为和状态，而 private API 一般都属于实现细节，是很容易做重构改动的，那样的话测试的维护成本就会大大提高。如果发现 private API 很复杂，或者一个 public API 里涉及了很多步骤，其实也是缺乏单一职责设计的表象。可能更好的做法是把这些 private API 拆成单独的领域模型，去协同完成某个具体场景。\u003C\u002Fp\u003E\u003Cp class=\"ztext-empty-paragraph\"\u003E\u003Cbr\u002F\u003E\u003C\u002Fp\u003E\u003Cfigure data-size=\"normal\"\u003E\u003Cnoscript\u003E\u003Cimg src=\"https:\u002F\u002Fpic4.zhimg.com\u002Fv2-073f8606ec6b95f0c6f8c2b9f891b6df_b.jpg\" data-size=\"normal\" data-rawwidth=\"2150\" data-rawheight=\"692\" class=\"origin_image zh-lightbox-thumb\" width=\"2150\" data-original=\"https:\u002F\u002Fpic4.zhimg.com\u002Fv2-073f8606ec6b95f0c6f8c2b9f891b6df_r.jpg\"\u002F\u003E\u003C\u002Fnoscript\u003E\u003Cimg src=\"data:image\u002Fsvg+xml;utf8,&lt;svg xmlns=&#39;http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg&#39; width=&#39;2150&#39; height=&#39;692&#39;&gt;&lt;\u002Fsvg&gt;\" data-size=\"normal\" data-rawwidth=\"2150\" data-rawheight=\"692\" class=\"origin_image zh-lightbox-thumb lazy\" width=\"2150\" data-original=\"https:\u002F\u002Fpic4.zhimg.com\u002Fv2-073f8606ec6b95f0c6f8c2b9f891b6df_r.jpg\" data-actualsrc=\"https:\u002F\u002Fpic4.zhimg.com\u002Fv2-073f8606ec6b95f0c6f8c2b9f891b6df_b.jpg\" data-original-token=\"v2-05084f12b1c19301811d30f1b0c1b2f6\"\u002F\u003E\u003Cfigcaption\u003E理想的 public\u002Fprivate API 区分\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp class=\"ztext-empty-paragraph\"\u003E\u003Cbr\u002F\u003E\u003C\u002Fp\u003E\u003Cp data-pid=\"pOU9kNDj\"\u003E另外像测试的验证比较复杂，不好写，可能也是类似的问题，没有做好职责分离和架构分层。举个极端的例子，我写了个\u003Ccode\u003Evoid\u003C\u002Fcode\u003E函数从头到尾把什么事情都做完了，那么自然要做 assertion 是件很困难的事情。\u003C\u002Fp\u003E\u003Cp data-pid=\"si6CvMC5\"\u003E总结一下上面的问题，提出可测试性的几个直观要求：\u003C\u002Fp\u003E\u003Cul\u003E\u003Cli data-pid=\"-39U_ulJ\"\u003E代码应该遵循单一职责原则，每个模块负责自己领域的事情，边界清晰。\u003C\u002Fli\u003E\u003Cli data-pid=\"gJzXIwFv\"\u003E模块具有良好设计的 API，能够实现可控制，可观测。例如行为调用有清晰明确的返回信息，对象的状态可以通过接口进行查询等。\u003C\u002Fli\u003E\u003Cli data-pid=\"GnI4RGI3\"\u003E需要有良好的架构来管理内部依赖（领域模型之间）和外部依赖（infra，数据库，API 等）。\u003C\u002Fli\u003E\u003C\u002Ful\u003E\u003Cp data-pid=\"2mrXpPHd\"\u003E这就很自然引出了很多讲架构的书中的典型分层方式，如六边形架构，clean architecture 等。其主要思想就是架构的内层是领域模型，包含所有的业务逻辑。外层是 service\u002Fcontroller 层，负责与外界的交互以及串联领域模型调用，尽可能不带业务逻辑。依赖关系永远是外层依赖内层，而不是反过来。典型的例子如我们不应该在领域模型里去建立数据库连接，依赖外部的 infra。直观的理解例如数组这样的领域对象，可以有访问，追加等操作，但如果它还有个方法是写入数据库，就会感觉有些“违和”了。\u003C\u002Fp\u003E\u003Cp class=\"ztext-empty-paragraph\"\u003E\u003Cbr\u002F\u003E\u003C\u002Fp\u003E\u003Cfigure data-size=\"normal\"\u003E\u003Cnoscript\u003E\u003Cimg src=\"https:\u002F\u002Fpic1.zhimg.com\u002Fv2-a7b97213f7d40b6118c3658abc41f9fc_b.jpg\" data-size=\"normal\" data-rawwidth=\"1802\" data-rawheight=\"1264\" class=\"origin_image zh-lightbox-thumb\" width=\"1802\" data-original=\"https:\u002F\u002Fpic1.zhimg.com\u002Fv2-a7b97213f7d40b6118c3658abc41f9fc_r.jpg\"\u002F\u003E\u003C\u002Fnoscript\u003E\u003Cimg src=\"data:image\u002Fsvg+xml;utf8,&lt;svg xmlns=&#39;http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg&#39; width=&#39;1802&#39; height=&#39;1264&#39;&gt;&lt;\u002Fsvg&gt;\" data-size=\"normal\" data-rawwidth=\"1802\" data-rawheight=\"1264\" class=\"origin_image zh-lightbox-thumb lazy\" width=\"1802\" data-original=\"https:\u002F\u002Fpic1.zhimg.com\u002Fv2-a7b97213f7d40b6118c3658abc41f9fc_r.jpg\" data-actualsrc=\"https:\u002F\u002Fpic1.zhimg.com\u002Fv2-a7b97213f7d40b6118c3658abc41f9fc_b.jpg\" data-original-token=\"v2-bf8a004076aaba76ad933ff0933f156a\"\u002F\u003E\u003Cfigcaption\u003E六边形架构\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp class=\"ztext-empty-paragraph\"\u003E\u003Cbr\u002F\u003E\u003C\u002Fp\u003E\u003Cp data-pid=\"Omd-QB9o\"\u003E书中还介绍了将这种风格推向极致的一种 functional architecture，把各类 side effects，exceptions，对内外部状态的依赖，都挪到业务逻辑的“外边缘”，让领域核心成为“纯函数”，也是控制代码复杂度的一种手段。不过这样做也会带来很多额外开销，例如性能和一些实现复杂度方面。\u003C\u002Fp\u003E\u003Cp data-pid=\"Eo0gLalk\"\u003E可测试性会“强迫”我们做出更好的架构设计，反过来，我们也可以通过架构设计来思考测试的分类。从上面六边形架构的示意图中我们也可以看出来，对于 controller 层测测试来说，领域模型之间的交互就属于实现细节，是不需要进行测试的。这其实就天然区分了单元测试和集成测试所负责的范围。\u003C\u002Fp\u003E\u003Cp data-pid=\"mgbkptYQ\"\u003E具体来说，我们以复杂度、领域相关度，和协作方（依赖）数量两个维度，来看领域模型与 controller 层的区别：\u003C\u002Fp\u003E\u003Cp class=\"ztext-empty-paragraph\"\u003E\u003Cbr\u002F\u003E\u003C\u002Fp\u003E\u003Cfigure data-size=\"normal\"\u003E\u003Cnoscript\u003E\u003Cimg src=\"https:\u002F\u002Fpic1.zhimg.com\u002Fv2-e997ed0fee769eadd523f8df88f45cb8_b.jpg\" data-size=\"normal\" data-rawwidth=\"1874\" data-rawheight=\"1082\" class=\"origin_image zh-lightbox-thumb\" width=\"1874\" data-original=\"https:\u002F\u002Fpic1.zhimg.com\u002Fv2-e997ed0fee769eadd523f8df88f45cb8_r.jpg\"\u002F\u003E\u003C\u002Fnoscript\u003E\u003Cimg src=\"data:image\u002Fsvg+xml;utf8,&lt;svg xmlns=&#39;http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg&#39; width=&#39;1874&#39; height=&#39;1082&#39;&gt;&lt;\u002Fsvg&gt;\" data-size=\"normal\" data-rawwidth=\"1874\" data-rawheight=\"1082\" class=\"origin_image zh-lightbox-thumb lazy\" width=\"1874\" data-original=\"https:\u002F\u002Fpic1.zhimg.com\u002Fv2-e997ed0fee769eadd523f8df88f45cb8_r.jpg\" data-actualsrc=\"https:\u002F\u002Fpic1.zhimg.com\u002Fv2-e997ed0fee769eadd523f8df88f45cb8_b.jpg\" data-original-token=\"v2-203b9ef7b316a2f17b4c7f073ae13f41\"\u002F\u003E\u003Cfigcaption\u003E架构分层与对应的测试\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp class=\"ztext-empty-paragraph\"\u003E\u003Cbr\u002F\u003E\u003C\u002Fp\u003E\u003Cp data-pid=\"N-By9KBf\"\u003E这张图可以说是非常精髓了。我们前面提到的测试难写，很多都落到了职责划分，架构分层不够清晰上，所以产生了很多过于复杂的代码（右上角）。为了提升可测试性，我们应该通过重构，把复杂代码拆分成领域模型和 controller 层两部分，前者负责复杂业务逻辑，后者负责大量的编排工作。因为领域核心的依赖交互方少，所以比较好写单元测试，而且这部分测试的价值也会比较高。而 controller 层因为没有复杂业务逻辑，但交互依赖众多，所以可以通过少量的集成测试来进行覆盖。有些同学会有疑问，我要测试一个用户购买的场景，是不是同样的功能测试要在单元测试和集成测试写两遍呢？这里就给出了比较清晰的指导原则。\u003C\u002Fp\u003E\u003Cp class=\"ztext-empty-paragraph\"\u003E\u003Cbr\u002F\u003E\u003C\u002Fp\u003E\u003Cfigure data-size=\"normal\"\u003E\u003Cnoscript\u003E\u003Cimg src=\"https:\u002F\u002Fpic4.zhimg.com\u002Fv2-f22c3d743a77c0e8da0647aec7ca8d73_b.jpg\" data-size=\"normal\" data-rawwidth=\"1882\" data-rawheight=\"1420\" class=\"origin_image zh-lightbox-thumb\" width=\"1882\" data-original=\"https:\u002F\u002Fpic4.zhimg.com\u002Fv2-f22c3d743a77c0e8da0647aec7ca8d73_r.jpg\"\u002F\u003E\u003C\u002Fnoscript\u003E\u003Cimg src=\"data:image\u002Fsvg+xml;utf8,&lt;svg xmlns=&#39;http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg&#39; width=&#39;1882&#39; height=&#39;1420&#39;&gt;&lt;\u002Fsvg&gt;\" data-size=\"normal\" data-rawwidth=\"1882\" data-rawheight=\"1420\" class=\"origin_image zh-lightbox-thumb lazy\" width=\"1882\" data-original=\"https:\u002F\u002Fpic4.zhimg.com\u002Fv2-f22c3d743a77c0e8da0647aec7ca8d73_r.jpg\" data-actualsrc=\"https:\u002F\u002Fpic4.zhimg.com\u002Fv2-f22c3d743a77c0e8da0647aec7ca8d73_b.jpg\" data-original-token=\"v2-d9dd427afee85539a3011da999ed8b3e\"\u002F\u003E\u003Cfigcaption\u003E测试的“分形”特质\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp class=\"ztext-empty-paragraph\"\u003E\u003Cbr\u002F\u003E\u003C\u002Fp\u003E\u003Cp data-pid=\"8P5iaDI0\"\u003E如果我们有比较良好的架构和职责划分，那么测试在不同层级上，是会具有这种“分形”特质的。书中还有一张图对 controller 层和领域模型层的特性给出了很形象的 code depth vs. width 说明：\u003C\u002Fp\u003E\u003Cp class=\"ztext-empty-paragraph\"\u003E\u003Cbr\u002F\u003E\u003C\u002Fp\u003E\u003Cfigure data-size=\"normal\"\u003E\u003Cnoscript\u003E\u003Cimg src=\"https:\u002F\u002Fpic2.zhimg.com\u002Fv2-676a2bb986da4f1c635f92a27b2dc8f9_b.jpg\" data-size=\"normal\" data-rawwidth=\"2194\" data-rawheight=\"1070\" class=\"origin_image zh-lightbox-thumb\" width=\"2194\" data-original=\"https:\u002F\u002Fpic2.zhimg.com\u002Fv2-676a2bb986da4f1c635f92a27b2dc8f9_r.jpg\"\u002F\u003E\u003C\u002Fnoscript\u003E\u003Cimg src=\"data:image\u002Fsvg+xml;utf8,&lt;svg xmlns=&#39;http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg&#39; width=&#39;2194&#39; height=&#39;1070&#39;&gt;&lt;\u002Fsvg&gt;\" data-size=\"normal\" data-rawwidth=\"2194\" data-rawheight=\"1070\" class=\"origin_image zh-lightbox-thumb lazy\" width=\"2194\" data-original=\"https:\u002F\u002Fpic2.zhimg.com\u002Fv2-676a2bb986da4f1c635f92a27b2dc8f9_r.jpg\" data-actualsrc=\"https:\u002F\u002Fpic2.zhimg.com\u002Fv2-676a2bb986da4f1c635f92a27b2dc8f9_b.jpg\" data-original-token=\"v2-5c2ee9336526615e18f351384125a445\"\u002F\u003E\u003Cfigcaption\u003EController 与领域模型的职责划分\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp class=\"ztext-empty-paragraph\"\u003E\u003Cbr\u002F\u003E\u003C\u002Fp\u003E\u003Cp data-pid=\"MpHt9evV\"\u003E当然在现实情况中要比这个理想情况复杂很多，我们通常很难把业务逻辑清晰地切割成“获取信息→执行业务逻辑→写回数据”这样的三步，很多时候会在业务过程中动态判断要读取哪些信息或者要写入哪些信息。这时候有几种选项：\u003C\u002Fp\u003E\u003Cul\u003E\u003Cli data-pid=\"y7mjSPwg\"\u003E将决策过程切割成更细的步骤，在每个步骤保证信息读写处于 controller 层。\u003C\u002Fli\u003E\u003Cli data-pid=\"sTJVr3Nc\"\u003E将外部依赖（数据读写）注入到领域模型里。\u003C\u002Fli\u003E\u003Cli data-pid=\"rft8mh7l\"\u003E严格遵守把读写放在外围的方法，即使过程中不一定要用到的数据也都提前读取好。\u003C\u002Fli\u003E\u003C\u002Ful\u003E\u003Cp data-pid=\"u8Gc1vPr\"\u003E这里具体的判断选择也有几个评估标准：\u003C\u002Fp\u003E\u003Cul\u003E\u003Cli data-pid=\"kJXYIeqW\"\u003EController 层的逻辑简单性。上述第一种选项牺牲了这一点。\u003C\u002Fli\u003E\u003Cli data-pid=\"S013h1jb\"\u003E领域模型的可测试性。第二种选项依赖注入牺牲了这一点。\u003C\u002Fli\u003E\u003Cli data-pid=\"MH7Vv_vw\"\u003E性能。最后一种选项牺牲了这一点。\u003C\u002Fli\u003E\u003C\u002Ful\u003E\u003Cp class=\"ztext-empty-paragraph\"\u003E\u003Cbr\u002F\u003E\u003C\u002Fp\u003E\u003Cfigure data-size=\"normal\"\u003E\u003Cnoscript\u003E\u003Cimg src=\"https:\u002F\u002Fpic2.zhimg.com\u002Fv2-9a622703a89a3cdbd8d86ce78e665211_b.jpg\" data-size=\"normal\" data-rawwidth=\"2082\" data-rawheight=\"1200\" class=\"origin_image zh-lightbox-thumb\" width=\"2082\" data-original=\"https:\u002F\u002Fpic2.zhimg.com\u002Fv2-9a622703a89a3cdbd8d86ce78e665211_r.jpg\"\u002F\u003E\u003C\u002Fnoscript\u003E\u003Cimg src=\"data:image\u002Fsvg+xml;utf8,&lt;svg xmlns=&#39;http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg&#39; width=&#39;2082&#39; height=&#39;1200&#39;&gt;&lt;\u002Fsvg&gt;\" data-size=\"normal\" data-rawwidth=\"2082\" data-rawheight=\"1200\" class=\"origin_image zh-lightbox-thumb lazy\" width=\"2082\" data-original=\"https:\u002F\u002Fpic2.zhimg.com\u002Fv2-9a622703a89a3cdbd8d86ce78e665211_r.jpg\" data-actualsrc=\"https:\u002F\u002Fpic2.zhimg.com\u002Fv2-9a622703a89a3cdbd8d86ce78e665211_b.jpg\" data-original-token=\"v2-afcd8a7a808fcb6b72eb477ec2863e78\"\u002F\u003E\u003Cfigcaption\u003E现实世界的权衡\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp class=\"ztext-empty-paragraph\"\u003E\u003Cbr\u002F\u003E\u003C\u002Fp\u003E\u003Cp data-pid=\"DbaqucCI\"\u003E相比来说，性能和领域模型的可测性都比较重要。可以通过一些手段来管理 controller 的复杂度：\u003C\u002Fp\u003E\u003Cul\u003E\u003Cli data-pid=\"fIeLI8A4\"\u003E即使做决策步骤拆分，也要避免把业务逻辑检查放到 controller 层来做。这可能会导致领域模型的不一致性。例如 controller 检查是否可以重命名，再由领域模型执行。如果 controller 层忘了检查，那么就会出现非法的情况被执行。\u003C\u002Fli\u003E\u003Cli data-pid=\"X9JBkWZd\"\u003E可以使用 CanExecute\u002FExecute 模式，在领域模型里提供检查方法，controller 可以调用，且自身执行逻辑前也会做检查。\u003C\u002Fli\u003E\u003Cli data-pid=\"Fotm4oYK\"\u003EDomain event 模式，将触发的操作放在 domain event 属性里，由 controller 或专门的 event dispatcher 去处理。相当于增加了一类协作交互对象，但没有提升 controller 的复杂度。\u003C\u002Fli\u003E\u003C\u002Ful\u003E\u003Cp data-pid=\"_TfA8wLI\"\u003E实在不可行的时候，再考虑把依赖注入到领域模型中。总体的原则还是尽量分离领域逻辑和编排这两种职责在整体架构的不同层去完成。\u003C\u002Fp\u003E\u003Cp data-pid=\"hy4WMNwO\"\u003E既然提到了依赖注入，也顺带一提为了保证可测试性，也会天然要求我们做依赖注入，而不是在类的内部去自己创建对象。另外像时间，随机数等依赖，也可以通过显式依赖传入，提升可控制性。\u003C\u002Fp\u003E\u003Cp data-pid=\"Ph6_SxSn\"\u003E而为了在测试中能够方便地 mock\u002Fstub 各种依赖，提升测试的重构友好度，也非常建议我们应该依赖抽象接口，而不是具体的实现。这显然也是良好架构设计的一大指引原则，可以降低耦合。当然这里也不是硬性规则，需要与“过度设计”进行权衡。\u003C\u002Fp\u003E\u003Cp class=\"ztext-empty-paragraph\"\u003E\u003Cbr\u002F\u003E\u003C\u002Fp\u003E\u003Cfigure data-size=\"normal\"\u003E\u003Cnoscript\u003E\u003Cimg src=\"https:\u002F\u002Fpic2.zhimg.com\u002Fv2-076450ea2061f8f99e71d2c8c29556e9_b.jpg\" data-size=\"normal\" data-rawwidth=\"1948\" data-rawheight=\"1036\" class=\"origin_image zh-lightbox-thumb\" width=\"1948\" data-original=\"https:\u002F\u002Fpic2.zhimg.com\u002Fv2-076450ea2061f8f99e71d2c8c29556e9_r.jpg\"\u002F\u003E\u003C\u002Fnoscript\u003E\u003Cimg src=\"data:image\u002Fsvg+xml;utf8,&lt;svg xmlns=&#39;http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg&#39; width=&#39;1948&#39; height=&#39;1036&#39;&gt;&lt;\u002Fsvg&gt;\" data-size=\"normal\" data-rawwidth=\"1948\" data-rawheight=\"1036\" class=\"origin_image zh-lightbox-thumb lazy\" width=\"1948\" data-original=\"https:\u002F\u002Fpic2.zhimg.com\u002Fv2-076450ea2061f8f99e71d2c8c29556e9_r.jpg\" data-actualsrc=\"https:\u002F\u002Fpic2.zhimg.com\u002Fv2-076450ea2061f8f99e71d2c8c29556e9_b.jpg\" data-original-token=\"v2-64fe77371a3002515cadcf3ca14fdbe7\"\u002F\u003E\u003Cfigcaption\u003E依赖接口而不是具体实现\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp class=\"ztext-empty-paragraph\"\u003E\u003Cbr\u002F\u003E\u003C\u002Fp\u003E\u003Ch3\u003ETDD\u003C\u002Fh3\u003E\u003Cp data-pid=\"o8N4ZsMa\"\u003E前面一大块阐述了测试对于代码设计的促进作用，也正是因为测试不仅帮助我们保证质量，甚至还能促进我们做出好的设计，所以自然又诞生出了测试驱动开发（TDD）的思想。这不仅仅是把测试放在前面先写这么简单，而是会整体的改变我们的思维与行动方式，带来很多优点：\u003C\u002Fp\u003E\u003Cul\u003E\u003Cli data-pid=\"vqyuKjq7\"\u003E根据需求先写测试，就是以需求为原点出发，先思考问题的抽象，而不是一上来考虑各种细节的技术手段选择。\u003C\u002Fli\u003E\u003Cli data-pid=\"JJFf0dT8\"\u003E小批量，增量式开发，每次多通过一个测试。在不确定性的环境下，这种方式能提升我们学习的速度。其本身也是一种“关注点分离”的做法。\u003C\u002Fli\u003E\u003Cli data-pid=\"GmC-OBmd\"\u003E快速的反馈，而不是等到全部写完再去检查是否有问题。\u003C\u002Fli\u003E\u003Cli data-pid=\"pNmIyPt8\"\u003E可以提升代码的可测试性，因为从一开始就是先写测试。反之很容易以线性过程思考来写代码，没有可测试性的考量。\u003C\u002Fli\u003E\u003Cli data-pid=\"tpomlrgf\"\u003E对代码设计的即时反馈。可测试性差的代码，往往设计上就存在问题。测试驱动强迫我们持续去“使用”代码，能及早发现问题。\u003C\u002Fli\u003E\u003Cli data-pid=\"eJqycn8S\"\u003E事后写测试还有一个“陷阱”在于容易针对具体的实现去写，导致测试代码对于重构的友好程度降低。\u003C\u002Fli\u003E\u003C\u002Ful\u003E\u003Cp data-pid=\"UAEQoGPi\"\u003E当然也有一些例外情况，例如对于一次性使用的代码，不一定要写相关测试。如果对于需要写的功能已经非常熟悉，完全了解实现方法，也可以不用 TDD 的方式。\u003C\u002Fp\u003E\u003Cp data-pid=\"QEp-LpiI\"\u003E总体来说，只要有测试的需求，即使不严格遵循 TDD，我们也应该尽可能缩短实现功能与写测试中间的时间间隔。不要写了一整天的功能代码，最后再去补测试。\u003C\u002Fp\u003E\u003Cp data-pid=\"f-gcXu5r\"\u003E关于 TDD 的具体操作方式，可以参考 \u003Ca href=\"https:\u002F\u002Flink.zhihu.com\u002F?target=https%3A\u002F\u002Fyoutu.be\u002FnlGSDUuK7C4\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\"\u003EJames Shore 的演示视频\u003C\u002Fa\u003E。\u003C\u002Fp\u003E\u003Ch3\u003E如何写大型测试\u003C\u002Fh3\u003E\u003Cp data-pid=\"VZ54PMnP\"\u003E前面在架构分层对应的测试部分已经提到，对于 controller 层的测试，我们一般会通过集成测试的手段来覆盖。当然这里也有不同的选择，例如我们也可以 mock\u002Fstub 所有的外部依赖，用单元测试的方法来覆盖 controller 层。或者尽量使用真实的依赖来做集成测试。与单元测试相比，集成测试有以下特性：\u003C\u002Fp\u003E\u003Cul\u003E\u003Cli data-pid=\"vjIBTyXo\"\u003E劣势：执行速度慢，更加难以维护。包括外部依赖的运维，更多的外部依赖也需要更多的 arrange 操作，让测试本身变得臃肿。\u003C\u002Fli\u003E\u003Cli data-pid=\"oKiMjeqX\"\u003E优势：测试覆盖到了更多的代码，不光是内部的，也包括第三方库，外部依赖等，对于 regression 的预防能起到更好的作用。测试的维度一般也更贴近终端用户，重构友好的程度也会比较高。\u003C\u002Fli\u003E\u003C\u002Ful\u003E\u003Cp data-pid=\"W7B5TalO\"\u003E前面也提到，controller 层一般是没有什么业务逻辑，但是依赖方众多，所以的确天然也更倾向于使用真实的依赖来做它的核心职责的验证。因此这里的取舍原则是，尽可能使用单元测试来覆盖各种复杂\u002F边界场景，用集成测试来覆盖一条主要的 happy path（尽可能覆盖所有外部依赖），以及单元测试无法覆盖的边界场景。\u003C\u002Fp\u003E\u003Cp data-pid=\"cLguOFmt\"\u003E集成测试中的外部依赖，也并不是完全不需要使用测试替代。我们可以从是否是应用自身管理的角度（典型特征就是看是否在同个代码 repo 里管理）来把它们分为两类：\u003C\u002Fp\u003E\u003Cul\u003E\u003Cli data-pid=\"sQ3RZM7B\"\u003Emanaged：例如应用自身的数据库，其它应用不会直接访问这个数据库。对调用方来说，这部分属于实现细节。因此集成测试中，推荐直接使用这些真实依赖。\u003C\u002Fli\u003E\u003Cli data-pid=\"9el134j0\"\u003Eunmanaged：例如外部 API，邮件服务，消息队列等。应用与这些依赖的交互要保证兼容性。对调用方来说，这部分是可观测的行为，需要通过 mock 来模拟和验证。这也是 mock 唯一推荐的使用场景，其它情况下对于实现细节做交互验证，会让测试变得脆弱。\u003C\u002Fli\u003E\u003C\u002Ful\u003E\u003Cp class=\"ztext-empty-paragraph\"\u003E\u003Cbr\u002F\u003E\u003C\u002Fp\u003E\u003Cfigure data-size=\"normal\"\u003E\u003Cnoscript\u003E\u003Cimg src=\"https:\u002F\u002Fpic2.zhimg.com\u002Fv2-456becfe192b90949f19df1ef31eb67d_b.jpg\" data-size=\"normal\" data-rawwidth=\"1714\" data-rawheight=\"1328\" class=\"origin_image zh-lightbox-thumb\" width=\"1714\" data-original=\"https:\u002F\u002Fpic2.zhimg.com\u002Fv2-456becfe192b90949f19df1ef31eb67d_r.jpg\"\u002F\u003E\u003C\u002Fnoscript\u003E\u003Cimg src=\"data:image\u002Fsvg+xml;utf8,&lt;svg xmlns=&#39;http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg&#39; width=&#39;1714&#39; height=&#39;1328&#39;&gt;&lt;\u002Fsvg&gt;\" data-size=\"normal\" data-rawwidth=\"1714\" data-rawheight=\"1328\" class=\"origin_image zh-lightbox-thumb lazy\" width=\"1714\" data-original=\"https:\u002F\u002Fpic2.zhimg.com\u002Fv2-456becfe192b90949f19df1ef31eb67d_r.jpg\" data-actualsrc=\"https:\u002F\u002Fpic2.zhimg.com\u002Fv2-456becfe192b90949f19df1ef31eb67d_b.jpg\" data-original-token=\"v2-c6c16daae5eca6c0a99fe72d36553fd3\"\u002F\u003E\u003Cfigcaption\u003E不同的外部依赖类型\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp class=\"ztext-empty-paragraph\"\u003E\u003Cbr\u002F\u003E\u003C\u002Fp\u003E\u003Cp data-pid=\"51Wy10bu\"\u003E集成测试的极端情况就是全部使用真实依赖的端到端测试。不过整体来说端到端测试的质量保障范围与典型的集成测试接近，因此数量会更少。Google 一书中也提到，他们的端到端大型测试，一般都是在生产环境跑的（可以结合一些灰度发布手段），用于保障部署发布本身没有问题。此外一些特定需求的测试，如性能，可扩展性，稳定性，安全测试等，也经常会使用端到端的测试方法。\u003C\u002Fp\u003E\u003Cp data-pid=\"1xjOfkeD\"\u003E在自身管理的外部依赖方面，最常见的就是应用的数据库了。如何在集成测试中维护数据库呢？\u003C\u002Fp\u003E\u003Cul\u003E\u003Cli data-pid=\"igkRbYxB\"\u003E数据库 schema 的信息以及相关变更都应该通过 git 之类的管理起来。而不是大家共享某个具体的“标准测试数据库”。\u003C\u002Fli\u003E\u003Cli data-pid=\"AXATrq-B\"\u003EReference data（如一些映射关系）也应该是数据库 schema 的一部分。\u003C\u002Fli\u003E\u003Cli data-pid=\"QlLqz2qh\"\u003E每个开发者都应该拥有自己独立的数据库 instance，集成测试本身就没法并发执行，共享数据库会碰到 schema，测试冲突等种种问题。\u003C\u002Fli\u003E\u003Cli data-pid=\"Sv1ksrvC\"\u003E使用 migration based 方法（如 Flyway，Liquibase），而不是 state based 方法来维护数据库变化。\u003C\u002Fli\u003E\u003Cli data-pid=\"c7NIuA64\"\u003E如何清理数据？最好的办法可能是在测试开始时执行清理。也可以选择每次测试前 restore 数据库，但会比较耗时。在测试结束后清理很多时候可能会没被执行到，例如测试挂掉，或者 debug 测试没有执行完等情况。\u003C\u002Fli\u003E\u003Cli data-pid=\"4Ni_r8Jl\"\u003E尽量使用与真实生产环境相同的数据库，而不是为了测试跑的更快选择内存数据库来替代。\u003C\u002Fli\u003E\u003C\u002Ful\u003E\u003Cp data-pid=\"oZx8Gx8D\"\u003E最后总结一些大型测试的最佳实践：\u003C\u002Fp\u003E\u003Cul\u003E\u003Cli data-pid=\"ThG9SMg5\"\u003E明确 domain model 的边界。让代码更容易维护，也让测试更清晰，可以区分单元测试与集成测试。\u003C\u002Fli\u003E\u003Cli data-pid=\"Zb4pCMFC\"\u003E减少应用中的 layer 数量。层次越多，可能需要的集成测试越复杂，但没有带来实质性的收益。\u003C\u002Fli\u003E\u003Cli data-pid=\"E6w12nfs\"\u003E移除循环依赖。循环依赖会导致逻辑理解难度大大上升，对于测试也增加了接口抽象和 mock 的需求。\u003C\u002Fli\u003E\u003Cli data-pid=\"h_r1Hkie\"\u003E即使在集成测试中，也尽量保证一个测试只验证一种情境，如创建用户和删除用户最好分成两个测试。只有在外部依赖的创建非常昂贵时，可以考虑在一个测试中做多个场景验证。\u003C\u002Fli\u003E\u003Cli data-pid=\"v1hJkyBX\"\u003E大型测试的 setup 一般比较复杂，可以通过一些设计模式，第三方库来复用和简化代码，如 test data builder，\u003Ca href=\"https:\u002F\u002Flink.zhihu.com\u002F?target=https%3A\u002F\u002Fgithub.com\u002FDiUS\u002Fjava-faker\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\"\u003Ejava-faker\u003C\u002Fa\u003E 等。\u003C\u002Fli\u003E\u003Cli data-pid=\"7ZtQgGPU\"\u003E同样，大型测试的 assertion 也会比较复杂，需要设计可复用，易读的 assertion API，也可以使用 AssertJ 这类三方库。\u003C\u002Fli\u003E\u003Cli data-pid=\"zJVA9DHt\"\u003E每次测试前做状态清理。这里可能涉及到为测试专门开发的 reset API，要千万小心不要放到线上。如果可以，最好避免这种特殊 API 的做法。\u003C\u002Fli\u003E\u003Cli data-pid=\"sB1wvY_j\"\u003E注意 ROI 测算，例如撰写，执行，维护大型测试的开销如何，是否能找到 bug，是否已经被 UT 覆盖等。任何代码都是“负债”，没有价值的测试应该及时被删除。\u003C\u002Fli\u003E\u003Cli data-pid=\"yf4-uK6-\"\u003E可以通过对测试 infra 的投入，降低一些大型测试的成本。\u003C\u002Fli\u003E\u003C\u002Ful\u003E\u003Cp class=\"ztext-empty-paragraph\"\u003E\u003Cbr\u002F\u003E\u003C\u002Fp\u003E\u003Cfigure data-size=\"normal\"\u003E\u003Cnoscript\u003E\u003Cimg src=\"https:\u002F\u002Fpic3.zhimg.com\u002Fv2-dc473ee926b8ef45ae1e361b2b87bb9a_b.jpg\" data-size=\"normal\" data-rawwidth=\"1836\" data-rawheight=\"1458\" class=\"origin_image zh-lightbox-thumb\" width=\"1836\" data-original=\"https:\u002F\u002Fpic3.zhimg.com\u002Fv2-dc473ee926b8ef45ae1e361b2b87bb9a_r.jpg\"\u002F\u003E\u003C\u002Fnoscript\u003E\u003Cimg src=\"data:image\u002Fsvg+xml;utf8,&lt;svg xmlns=&#39;http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg&#39; width=&#39;1836&#39; height=&#39;1458&#39;&gt;&lt;\u002Fsvg&gt;\" data-size=\"normal\" data-rawwidth=\"1836\" data-rawheight=\"1458\" class=\"origin_image zh-lightbox-thumb lazy\" width=\"1836\" data-original=\"https:\u002F\u002Fpic3.zhimg.com\u002Fv2-dc473ee926b8ef45ae1e361b2b87bb9a_r.jpg\" data-actualsrc=\"https:\u002F\u002Fpic3.zhimg.com\u002Fv2-dc473ee926b8ef45ae1e361b2b87bb9a_b.jpg\" data-original-token=\"v2-0bf05f765956482f0e65c933adc9a125\"\u002F\u003E\u003Cfigcaption\u003E减少应用的 layer 数量\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp class=\"ztext-empty-paragraph\"\u003E\u003Cbr\u002F\u003E\u003C\u002Fp\u003E\u003Ch3\u003E如何使用测试替代\u003C\u002Fh3\u003E\u003Cp data-pid=\"W9VC3Lvj\"\u003E测试替代永远是测试实践中的一个重要主题，前面我们已经提到了一些重要原则，例如应该测试可观测的行为状态，而不是实现细节。所以只有集成测试才需要使用 mock，并且应该仅被用在 unmanaged 依赖上，其它情况使用 mock 都会让测试变得脆弱。\u003C\u002Fp\u003E\u003Cp data-pid=\"Lvc04DNg\"\u003E延续这个思路，我们在验证与 unmanaged 依赖交互时，应该尽量在系统最外层的边界去做，这样能覆盖到更多的系统内部代码。\u003C\u002Fp\u003E\u003Cp class=\"ztext-empty-paragraph\"\u003E\u003Cbr\u002F\u003E\u003C\u002Fp\u003E\u003Cfigure data-size=\"normal\"\u003E\u003Cnoscript\u003E\u003Cimg src=\"https:\u002F\u002Fpic3.zhimg.com\u002Fv2-5109a402c93ed03f62c20f641ac759be_b.jpg\" data-size=\"normal\" data-rawwidth=\"2004\" data-rawheight=\"1800\" class=\"origin_image zh-lightbox-thumb\" width=\"2004\" data-original=\"https:\u002F\u002Fpic3.zhimg.com\u002Fv2-5109a402c93ed03f62c20f641ac759be_r.jpg\"\u002F\u003E\u003C\u002Fnoscript\u003E\u003Cimg src=\"data:image\u002Fsvg+xml;utf8,&lt;svg xmlns=&#39;http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg&#39; width=&#39;2004&#39; height=&#39;1800&#39;&gt;&lt;\u002Fsvg&gt;\" data-size=\"normal\" data-rawwidth=\"2004\" data-rawheight=\"1800\" class=\"origin_image zh-lightbox-thumb lazy\" width=\"2004\" data-original=\"https:\u002F\u002Fpic3.zhimg.com\u002Fv2-5109a402c93ed03f62c20f641ac759be_r.jpg\" data-actualsrc=\"https:\u002F\u002Fpic3.zhimg.com\u002Fv2-5109a402c93ed03f62c20f641ac759be_b.jpg\" data-original-token=\"v2-2ddb92911fdaa4fbc2c54d4afaa0f13d\"\u002F\u003E\u003Cfigcaption\u003EMock 位置的选择\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp class=\"ztext-empty-paragraph\"\u003E\u003Cbr\u002F\u003E\u003C\u002Fp\u003E\u003Cp data-pid=\"HcllixkI\"\u003E在 mock 验证交互行为时，应该跟其它 assertion 一样，越精确越好。不光要看是否发生了调用，还要看调用的次数是否正确，以及不应该做的调用没有发生等。\u003C\u002Fp\u003E\u003Cp data-pid=\"5t9F4fl0\"\u003E放宽到测试替代整体来看，stub 使用的场景可能会更多一些，例如：\u003C\u002Fp\u003E\u003Cul\u003E\u003Cli data-pid=\"6JR3jxw8\"\u003E速度较慢的外部依赖。例如某个类需要进行大量计算才能返回结果。\u003C\u002Fli\u003E\u003Cli data-pid=\"k49A3CbG\"\u003E基于外部 infra，如数据库，第三方 API 等。当然还是要注意，领域模型里应该尽量减少这些依赖。\u003C\u002Fli\u003E\u003Cli data-pid=\"6i1yxURE\"\u003E难以模拟的状态，如需要让某些组件抛出错误异常。\u003C\u002Fli\u003E\u003C\u002Ful\u003E\u003Cp data-pid=\"_7NLt0QW\"\u003E对于测试替代整体来说，我们应该仅仅替代自己“拥有”的类型，而不是直接去模拟第三方库的类型和 API。因为这些第三方库是有可能发生变化的，我们也可能会选择切换第三方的实现。所以更好的方法是先做抽象封装，让我们的应用去依赖抽象好的接口，而不是某个具体实现。\u003C\u002Fp\u003E\u003Cp data-pid=\"OXiHsTVM\"\u003E为了能在测试时灵活切换测试替代对象，需要使用依赖注入手段。这里有个选择，依赖注入是放在类构造方法里，还是放在其它方法的参数里？前者对于类本身的复杂度有所增加，但对于调用方来说会更加友好。多数情况下，我们还是选择让调用方更友好的方式。\u003C\u002Fp\u003E\u003Ch3\u003E测试质量\u003C\u002Fh3\u003E\u003Cp data-pid=\"1vl0vZk0\"\u003E测试的代码也是我们项目代码的一部分，因此测试本身的质量也非常重要。这里简单列举一些基本的评判原则：\u003C\u002Fp\u003E\u003Cul\u003E\u003Cli data-pid=\"bba-Q8k8\"\u003E测试应该执行速度较快。\u003C\u002Fli\u003E\u003Cli data-pid=\"fkpIZZiH\"\u003E测试应该做到高内聚，互相独立，聚焦于某个场景。\u003C\u002Fli\u003E\u003Cli data-pid=\"tcNXpaaa\"\u003E测试应该有一个存在的理由，为了预防 bug，而不仅仅是以提高代码覆盖率为目的。\u003C\u002Fli\u003E\u003Cli data-pid=\"SLsSCSBb\"\u003E测试应该是稳定的，可重复执行，可复现的。谨慎引入外部依赖，各种超时设置等。不要与其他测试互相影响。\u003C\u002Fli\u003E\u003Cli data-pid=\"YSt-KMFY\"\u003E测试应该有足够强的 assertion 覆盖。\u003C\u002Fli\u003E\u003Cli data-pid=\"1M471d4T\"\u003E当被测对象行为发生变化时，测试应该失败。Mutation test 就是一个很好的检验方式。\u003C\u002Fli\u003E\u003Cli data-pid=\"V4KC-mdF\"\u003E测试应该有且仅有一个明确的原因造成失败，便于定位问题和修复。\u003C\u002Fli\u003E\u003Cli data-pid=\"AXEOcfkp\"\u003E测试应该易于撰写。需要对 test infra 有所重视与投入。\u003C\u002Fli\u003E\u003Cli data-pid=\"l3LrX1In\"\u003E测试应该易于阅读和理解。使用有意义的命名，通过 fluent API 来增强可读性等。\u003C\u002Fli\u003E\u003Cli data-pid=\"iId2pf4v\"\u003E测试应该易于修改和演进。\u003C\u002Fli\u003E\u003C\u002Ful\u003E\u003Cp data-pid=\"eUlVvgpZ\"\u003E一些不好的测试代码 smell 表现与“反模式”：\u003C\u002Fp\u003E\u003Cul\u003E\u003Cli data-pid=\"Ewjd9RmB\"\u003E过多的重复代码，增加了修改演进难度。\u003C\u002Fli\u003E\u003Cli data-pid=\"lPzOut8O\"\u003E不明确的 assertion，报错信息不友好。\u003C\u002Fli\u003E\u003Cli data-pid=\"abK5Cwz7\"\u003E没有处理好复杂的外部资源依赖，如数据库等。\u003C\u002Fli\u003E\u003Cli data-pid=\"NfGfh59i\"\u003E大量继承过于 general 的 fixtures，会很难维护。\u003C\u002Fli\u003E\u003Cli data-pid=\"d6ZtbXr1\"\u003E过于敏感的 assertion（针对实现细节），任何的代码改动都会让测试失败。\u003C\u002Fli\u003E\u003Cli data-pid=\"s6qY1qo4\"\u003E测试私有方法。私有方法一般属于实现细节，而不是可观测的行为。测试私有方法会导致失去对重构的友好性，也是单元测试最重要的一个特性。如果发现 private 方法里有很复杂的业务逻辑，可以考虑做领域模型的拆分独立。\u003C\u002Fli\u003E\u003Cli data-pid=\"hBR6GcdC\"\u003E基于私有属性做判断。同理，我们应该从业务的可观测行为角度进行判断，而不是把私有属性暴露出来。\u003C\u002Fli\u003E\u003Cli data-pid=\"nkr8n2lY\"\u003E将领域知识引入到了测试中，极端的情况是在测试的 arrange 里直接把被测试代码的逻辑又复制了一遍过来。\u003C\u002Fli\u003E\u003Cli data-pid=\"x_deiPBI\"\u003E代码污染，在生产代码中添加了只为测试用例服务的逻辑。更好的做法是在测试中去做接口的不同实现。\u003C\u002Fli\u003E\u003Cli data-pid=\"dH3pzAzk\"\u003EMock\u002Fstub 具体的类。往往违反了单一职责原则，建议将外部依赖拆出来接口化。\u003C\u002Fli\u003E\u003C\u002Ful\u003E\u003Ch2\u003E如何改进“遗留代码”\u003C\u002Fh2\u003E\u003Cp data-pid=\"m8u4YyZD\"\u003E前面聊了很多测试的最佳实践，但绝大多数时候，我们接触的都是已有项目，不一定从一开始就注重单元测试这块的建设。对于没有测试覆盖的遗留代码，我们要如何入手呢？\u003C\u002Fp\u003E\u003Cp data-pid=\"HhJQ1JR2\"\u003E这部分又是一个很大的话题，甚至有专门一本经典的书《\u003Ca href=\"https:\u002F\u002Flink.zhihu.com\u002F?target=https%3A\u002F\u002Fbook.douban.com\u002Fsubject\u002F2248759\u002F\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\"\u003E修改代码的艺术\u003C\u002Fa\u003E》来讨论。这里我们就简单介绍一些基本步骤和方法。\u003C\u002Fp\u003E\u003Cp data-pid=\"UfhM9DNN\"\u003E首先一个选择是，我们是否可以针对遗留代码来补充测试。这里测试的目标更多是希望保证原有系统在改造过程中不发生行为的变化，所以有个做法是先调用一下系统的功能，获取到输出后，就把这个输出作为检查点放到测试里。这种测试也被称为 characterization test。往往第一个测试是最难写的，因为要涉及到很多 setup，但有了第一个测试，在此基础上添加更多的用例就会相对容易不少。\u003C\u002Fp\u003E\u003Cp data-pid=\"10NTxgjS\"\u003E但很多时候，由于一开始代码的设计并没有从可测试性角度出发思考，所以添加测试会非常的困难，而且写出来的测试在后续也有大概率会被修改掉。为了能让代码更容易进行测试，我们需要使用一些“安全重构”的手段来优化代码设计。很多 IDE 里都有这类功能的支持，如重命名，代码移动（拆分类），抽取方法等。注意在这个过程中只做搬运和重命名这类安全操作，不要同时修改逻辑，在没有测试覆盖情况下会很危险。\u003C\u002Fp\u003E\u003Cp data-pid=\"hH0A2oep\"\u003E在遗留系统中添加新功能时，我们可以考虑创建一个新的类，同时对这个类加上单元测试。然后在旧有类中去调用这个新的类中的方法。以此来至少保证新功能是有测试覆盖的。\u003C\u002Fp\u003E\u003Cp data-pid=\"4-OnU103\"\u003E如果还需要对旧有代码做持续的 bugfix 等改动，那么也必然需要对遗留代码做重构和测试的补充。我们可以使用一些第三方工具来分析项目整体的依赖关系图，寻找明显问题，切入进行改造。这里的方法也是常见的重构手段，抽取类或者接口，把外部依赖做注入，实现多个实例化方法，在旧的类和方法里去调用逐渐抽取出来的新的类和方法。重构本身是没有完美状态的，我们只需要保证每次提交都比之前进步一些就可以。具体的衡量指标可以参考代码的测试覆盖率，SonarQube 等静态代码检查的结果等。\u003C\u002Fp\u003E\u003Cp data-pid=\"2oJBzig1\"\u003E最后，如何培养整体团队的意识，让所有人都开始重视，学习，并掌握测试技术也是非常关键的。对于所有的新功能，bugfix，重构，都应该要求带上相应的测试代码覆盖。同时也需要在研发流程中提升测试的结合程度，完善测试相关的基础设施，让测试更好写，更容易执行并查看结果，逐渐让大家意识到测试带来的巨大价值。在赋能和培训方面，把这篇文章转发给团队，可能也是一个不错的开始 :)\u003C\u002Fp\u003E","adminClosedComment":false,"topics":[{"url":"https:\u002F\u002Fwww.zhihu.com\u002Fapi\u002Fv4\u002Ftopics\u002F19557552","type":"topic","id":"19557552","name":"软件工程"},{"url":"https:\u002F\u002Fwww.zhihu.com\u002Fapi\u002Fv4\u002Ftopics\u002F19562409","type":"topic","id":"19562409","name":"软件测试"}],"voteupCount":12,"voting":0,"heavyUpStatus":"allow_heavy_up","column":{"description":"","canManage":false,"intro":"","isFollowing":false,"urlToken":"zijie0","id":"zijie0","articlesCount":49,"acceptSubmission":true,"title":"RandomGenerator","url":"https:\u002F\u002Fzhuanlan.zhihu.com\u002Fzijie0","commentPermission":"all","created":1480664647,"updated":1590922686,"imageUrl":"https:\u002F\u002Fpicx.zhimg.com\u002Fv2-b7a5731b9b518c13c4a82a90453ebaf6_720w.jpg?source=172ae18b","author":{"isFollowed":false,"avatarUrlTemplate":"https:\u002F\u002Fpic1.zhimg.com\u002Fv2-95ba0bb27d5abbdac132d83c17310b22.jpg?source=172ae18b","uid":"27758868561920","userType":"people","isFollowing":false,"urlToken":"zijie0","id":"dd44fd707897acda43e0a65ba07b3199","description":"如果您对我的作品感兴趣，欢迎关注个人公众号：RandomGenerator","name":"字节","isAdvertiser":false,"headline":"天地大观，志存高远","gender":1,"url":"\u002Fpeople\u002Fdd44fd707897acda43e0a65ba07b3199","avatarUrl":"https:\u002F\u002Fpicx.zhimg.com\u002Fv2-95ba0bb27d5abbdac132d83c17310b22_l.jpg?source=172ae18b","isOrg":false,"type":"people","badgeV2":{"title":"","mergedBadges":[],"detailBadges":[],"icon":"","nightIcon":""}},"followers":515,"type":"column"},"commentCount":0,"contributions":[{"id":43626124,"state":"accepted","type":"first_publish","column":{"description":"","canManage":false,"intro":"","isFollowing":false,"urlToken":"zijie0","id":"zijie0","articlesCount":49,"acceptSubmission":true,"title":"RandomGenerator","url":"https:\u002F\u002Fzhuanlan.zhihu.com\u002Fzijie0","commentPermission":"all","created":1480664647,"updated":1590922686,"imageUrl":"https:\u002F\u002Fpicx.zhimg.com\u002Fv2-b7a5731b9b518c13c4a82a90453ebaf6_720w.jpg?source=172ae18b","author":{"isFollowed":false,"avatarUrlTemplate":"https:\u002F\u002Fpic1.zhimg.com\u002Fv2-95ba0bb27d5abbdac132d83c17310b22.jpg?source=172ae18b","uid":"27758868561920","userType":"people","isFollowing":false,"urlToken":"zijie0","id":"dd44fd707897acda43e0a65ba07b3199","description":"如果您对我的作品感兴趣，欢迎关注个人公众号：RandomGenerator","name":"字节","isAdvertiser":false,"headline":"天地大观，志存高远","gender":1,"url":"\u002Fpeople\u002Fdd44fd707897acda43e0a65ba07b3199","avatarUrl":"https:\u002F\u002Fpicx.zhimg.com\u002Fv2-95ba0bb27d5abbdac132d83c17310b22_l.jpg?source=172ae18b","isOrg":false,"type":"people","badgeV2":{"title":"","mergedBadges":[],"detailBadges":[],"icon":"","nightIcon":""}},"followers":515,"type":"column"}}],"isTitleImageFullScreen":false,"upvotedFollowees":[],"commercialInfo":{"isCommercial":false,"plugin":{}},"suggestEdit":{"status":false,"reason":"","tip":"","url":"","title":""},"reason":"","annotationAction":[],"canTip":true,"tipjarorsCount":0,"isLabeled":false,"hasPublishingDraft":false,"isFavorited":false,"favlistsCount":32,"isNormal":true,"status":0,"activityToppingInfo":{"state":"untopped"},"shareText":"重新思考软件测试 - 来自知乎专栏「RandomGenerator」，作者: 字节 https:\u002F\u002Fzhuanlan.zhihu.com\u002Fp\u002F591751476 （想看更多？下载 @知乎 App：http:\u002F\u002Fweibo.com\u002Fp\u002F100404711598 ）","canComment":{"status":true,"reason":""},"mcnFpShow":-1,"isVisible":true,"isLiked":false,"likedCount":5,"hasColumn":true,"republishers":[],"isNewLinkCard":true,"emojiReaction":{"cryFaceCount":0,"cryFaceHasSet":false,"hugCount":0,"hugHasSet":false,"likeCount":5,"likeHasSet":false,"onlookerCount":0,"onlookerHasSet":false},"abParam":{"qaHiddenVoteup":"1","rsInterest1":"1"},"attachedInfo":"kgIkCgkyMTk2MzQwNTISCTU5MTc1MTQ3NhgHIgpJTUFHRV9URVhU","shareGuide":{"hasPositiveBubble":false,"hasTimeBubble":false,"hitShareGuideCluster":false},"settings":{"tableOfContents":{"enabled":true}},"canReference":false,"reactionInstruction":{}}},"columns":{"zijie0":{"description":"","canManage":false,"intro":"","isFollowing":false,"urlToken":"zijie0","id":"zijie0","articlesCount":49,"acceptSubmission":true,"title":"RandomGenerator","url":"https:\u002F\u002Fzhuanlan.zhihu.com\u002Fzijie0","commentPermission":"all","created":1480664647,"updated":1590922686,"imageUrl":"https:\u002F\u002Fpicx.zhimg.com\u002Fv2-b7a5731b9b518c13c4a82a90453ebaf6_720w.jpg?source=172ae18b","author":{"isFollowed":false,"avatarUrlTemplate":"https:\u002F\u002Fpic1.zhimg.com\u002Fv2-95ba0bb27d5abbdac132d83c17310b22.jpg?source=172ae18b","uid":"27758868561920","userType":"people","isFollowing":false,"urlToken":"zijie0","id":"dd44fd707897acda43e0a65ba07b3199","description":"如果您对我的作品感兴趣，欢迎关注个人公众号：RandomGenerator","name":"字节","isAdvertiser":false,"headline":"天地大观，志存高远","gender":1,"url":"\u002Fpeople\u002Fdd44fd707897acda43e0a65ba07b3199","avatarUrl":"https:\u002F\u002Fpicx.zhimg.com\u002Fv2-95ba0bb27d5abbdac132d83c17310b22_l.jpg?source=172ae18b","isOrg":false,"type":"people","badgeV2":{"title":"","mergedBadges":[],"detailBadges":[],"icon":"","nightIcon":""}},"followers":515,"type":"column"}},"topics":{},"roundtables":{},"favlists":{},"comments":{},"notifications":{},"ebooks":{},"activities":{},"feeds":{},"pins":{},"promotions":{},"drafts":{},"chats":{},"posts":{},"zvideos":{},"zvideoContributions":{},"briefs":{},"eduCourses":{}},"currentUser":"","account":{"lockLevel":{},"unlockTicketStatus":false,"unlockTicket":null,"challenge":[],"errorStatus":false,"message":"","isFetching":false,"accountInfo":{},"urlToken":{"loading":false},"cardUserInfo":{"vipInfo":{}},"handleWidget":{},"widgetList":[],"userWidgetId":""},"settings":{"socialBind":null,"inboxMsg":null,"notification":{},"email":{},"privacyFlag":null,"blockedUsers":{"isFetching":false,"paging":{"pageNo":1,"pageSize":6},"data":[]},"blockedFollowees":{"isFetching":false,"paging":{"pageNo":1,"pageSize":6},"data":[]},"ignoredTopics":{"isFetching":false,"paging":{"pageNo":1,"pageSize":6},"data":[]},"restrictedTopics":null,"laboratory":{}},"notification":{},"people":{"profileStatus":{},"activitiesByUser":{},"answersByUser":{},"answersSortByVotesByUser":{},"answersIncludedByUser":{},"votedAnswersByUser":{},"thankedAnswersByUser":{},"voteAnswersByUser":{},"thankAnswersByUser":{},"topicAnswersByUser":{},"zvideosByUser":{},"articlesByUser":{},"articlesSortByVotesByUser":{},"articlesIncludedByUser":{},"pinsByUser":{},"questionsByUser":{},"commercialQuestionsByUser":{},"favlistsByUser":{},"followingByUser":{},"followersByUser":{},"mutualsByUser":{},"followingColumnsByUser":{},"followingQuestionsByUser":{},"followingFavlistsByUser":{},"followingTopicsByUser":{},"publicationsByUser":{},"columnsByUser":{},"allFavlistsByUser":{},"brands":null,"creationsByUser":{},"creationsSortByVotesByUser":{},"creationsFeed":{},"infinity":{},"batchUsers":{},"profileInfinity":null},"env":{"ab":{"config":{"params":[{"id":"ques_follow_con","type":"Int","value":"0","chainId":"_gene_","layerId":"ques_follow_con","key":3320}],"experiments":[],"chains":[],"encodedParams":"Cgo7ArcDiwUnB\u002FgMEgUAAAAAAA=="},"triggers":{}},"abV2":{"config":{"paramMap":{"pm_new_task":{"value":"0"},"in_editor_title":{"value":"0"},"ws_platform_new":{"value":"0"}},"abMap":{}},"triggers":{}},"userAgent":{"Edge":false,"IE":false,"Wechat":false,"Weibo":false,"QQ":false,"MQQBrowser":false,"Qzone":false,"Mobile":true,"Android":false,"iOS":true,"isAppleDevice":true,"Zhihu":false,"ZhihuHybrid":false,"isBot":false,"Tablet":false,"UC":false,"Quark":false,"Sogou":false,"Qihoo":false,"Baidu":false,"BaiduApp":false,"Safari":false,"GoogleBot":false,"AndroidDaily":false,"iOSDaily":false,"WxMiniProgram":false,"BaiduMiniProgram":false,"QQMiniProgram":false,"JDMiniProgram":false,"isWebView":false,"isMiniProgram":false,"origin":"Mozilla\u002F5.0 (iPhone; CPU iPhone OS 16_4 like Mac OS X) AppleWebKit\u002F605.1.15 (KHTML, like Gecko) Mobile\u002F15E148"},"appViewConfig":{},"ctx":{"path":"\u002Fp\u002F591751476","query":{},"href":"http:\u002F\u002Fzhuanlan.zhihu.com\u002Fp\u002F591751476","host":"zhuanlan.zhihu.com"},"trafficSource":"production","edition":{"beijing":false,"baidu":false,"sogou":false,"baiduBeijing":false,"sogouBeijing":false,"sogouInput":false,"oppoSearch":false,"baiduSearch":false,"googleSearch":false,"shenma":false,"miniProgram":false,"xiaomi":false,"huaweiSearch":false},"theme":"light","appHeaderTheme":{"current":"normal","disable":true,"normal":{"bgColor":"GBK99A"},"custom":{"bgColor":"GBK99A"}},"enableShortcut":true,"referer":"","xUDId":"AFBXnGGr8BaPTq1NbGXn_ppp0RPq8BY0Jxo=","mode":"ssr","conf":{},"xTrafficFreeOrigin":"","ipInfo":{"cityName":"武汉","countryName":"中国","regionName":"湖北","countryCode":"CN"},"logged":false,"vars":{"passThroughHeaders":{}}},"me":{"columnContributions":[]},"label":{"recognizerLists":{}},"ecommerce":{},"comments":{"pagination":{},"collapsed":{},"reverse":{},"reviewing":{},"conversation":{},"parent":{}},"commentsV2":{"stickers":[],"commentWithPicPermission":{},"notificationsComments":{},"pagination":{},"collapsed":{},"reverse":{},"reviewing":{},"conversation":{},"conversationMore":{},"parent":{}},"pushNotifications":{"default":{"isFetching":false,"isDrained":false,"ids":[]},"follow":{"isFetching":false,"isDrained":false,"ids":[]},"vote_thank":{"isFetching":false,"isDrained":false,"ids":[]},"currentTab":"default","notificationsCount":{"default":0,"follow":0,"vote_thank":0}},"messages":{"data":{},"currentTab":"common","messageCount":0},"register":{"registerValidateSucceeded":null,"registerValidateErrors":{},"registerConfirmError":null,"sendDigitsError":null,"registerConfirmSucceeded":null},"login":{"loginUnregisteredError":false,"loginBindWechatError":false,"loginConfirmError":null,"sendDigitsError":null,"needSMSIdentify":false,"validateDigitsError":false,"loginConfirmSucceeded":null,"qrcodeLoginToken":"","qrcodeLoginScanStatus":0,"qrcodeLoginError":null,"qrcodeLoginReturnNewToken":false},"switches":{},"captcha":{"captchaNeeded":false,"captchaValidated":false},"sms":{"supportedCountries":[]},"chat":{"chats":{},"inbox":{"recents":{"isFetching":false,"isDrained":false,"isPrevDrained":false,"result":[],"next":null,"key":null},"strangers":{"isFetching":false,"isDrained":false,"isPrevDrained":false,"result":[],"next":null,"key":null},"friends":{"isFetching":false,"isDrained":false,"isPrevDrained":false,"result":[],"next":null,"key":null},"search":{"isFetching":false,"isDrained":false,"isPrevDrained":false,"result":[],"next":null,"key":null},"config":{"newCount":0,"strangerMessageSwitch":false,"strangerMessageUnread":false,"friendCount":0}},"global":{"isChatMqttExisted":false}},"emoticons":{"emoticonGroupList":[],"emoticonGroupDetail":{}},"creator":{"tools":{"question":{"invitationCount":{"questionFolloweeCount":0,"questionTotalCount":0}},"recommend":{"recommendTimes":{}}},"explore":{},"levelUpperLimit":10,"mcn":{},"mcnManage":{},"tasks":{},"announcement":{},"creatorsRecommendInfo":{}},"creators":{"common":{"applyStatus":{},"rightsStatus":{}},"bayesDomains":{"status":{},"options":{"topDomains":null,"allDomains":null,"editable":0},"contents":null},"school":{"tabs":[],"contents":[],"banner":null,"entities":{}},"faq":{"tabs":[],"article":{}},"knowledgeIncome":{},"safeguardRights":{},"analytics":{"all":{},"answer":{},"zvideo":{},"article":{},"pin":{},"singleContent":{}},"account":{"growthLevel":{}},"KMResource":{},"training":{},"ToolsQuestion":{"goodatTopics":[]},"ToolsHotspot":{"domains":[]},"ToolsRecommend":{},"ToolsCustomPromotion":{"itemLists":{},"baseInfo":{}},"ToolsSearchQuestion":{},"editorSetting":{},"MCNManage":{},"knowledgeTasks":{},"incomeAnalysis":{"income":{"aggregation":{}}},"creationManage":{"editModal":{"status":false}},"activity":{},"announcement":{},"home":{"currentCreatorUrlToken":null,"rights":[],"newRights":[],"scoreInfo":{},"menusShowControlByServer":{"bVipRecomend":false,"creationRelationship":false},"newTasks":{"creatorTask":{"tasks":[],"des":[]}},"bannerList":[],"recentlyCreated":[]},"videoSupport":{"textBenefit":{}},"videoDistribution":{}},"answers":{"voters":{},"copyrightApplicants":{},"favlists":{},"newAnswer":{},"entityWords":{},"concernedUpvoters":{},"simpleConcernedUpvoters":{},"paidContent":{},"settings":{}},"recommendation":{"homeRecommendations":[]},"shareTexts":{},"articles":{"voters":{},"concernedUpvoters":{}},"previewPost":{},"favlists":{"relations":{}},"columns":{"voters":{}},"reward":{"answer":{},"article":{},"question":{}},"video":{"data":{},"shareVideoDetail":{},"last":{}},"topstory":{"recommend":{"isFetching":false,"isDrained":false,"afterId":0,"items":[],"next":null},"follow":{"isFetching":false,"isDrained":false,"afterId":0,"items":[],"next":null},"followWonderful":{"isFetching":false,"isDrained":false,"afterId":0,"items":[],"next":null},"sidebar":null,"announcement":{},"hotList":[],"guestFeeds":{"isFetching":false,"isDrained":false,"afterId":0,"items":[],"next":null},"followExtra":{"isNewUser":null,"isFetched":false,"followCount":0,"followers":[]},"hotDaily":{"data":[],"paging":{}},"hotHighlight":{"isFetching":false,"isDrained":false,"data":[],"paging":{}},"banner":{},"commercialBanner":{"show":false,"banner":{},"trackData":{}},"video":{"items":[],"next":null,"isLoading":false,"isDrained":false}},"readStatus":{},"column":{},"requestColumn":{"categories":[],"error":null},"articleContribution":{"contributeRequests":[],"deleteContributeIdList":[],"handledContributeIdList":[],"recommendedColumns":[],"pinnedColumns":[],"sentContributeRequestsIdList":[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,"zijie0"]},"columnContribution":{"contributeRequests":[],"autoInviteEnabled":false,"recommendedContributors":[],"contributionInvitation":null},"draftHistory":{"history":{},"drafts":{}},"upload":{},"articleDraft":{"titleImage":"","titleImageSize":{},"isTitleImageFullScreen":false,"canTitleImageFullScreen":false,"title":"","titleImageUploading":false,"error":"","content":"","draftLoading":false,"updating":false,"globalLoading":false,"pendingVideo":{"resource":null,"error":null},"deleteFail":{"fail":false},"recommendTopics":[],"selectedColumn":0,"articleDisclaimers":[]},"articleDrafts":{"isDrained":false,"isLoading":false,"items":[]},"columnAutocomplete":{"users":[],"friends":[]},"columnCollection":{},"userProfit":{"permission":{"permissionStatus":{"zhiZixuan":0,"recommend":-1,"task":0,"plugin":0,"infinity":0},"visible":false},"linkCardLimit":0},"mcn":{"bindInfo":{},"memberCategoryList":[],"producerList":[],"categoryList":[],"lists":{},"banners":{},"protocolStatus":{"isAgreedNew":true,"isAgreedOld":true},"probationCountdownDays":0},"zvideos":{"campaignVideoList":{},"campaigns":{},"tagoreCategory":[],"recommendations":{},"insertable":{},"recruit":{"form":{"platform":"","nickname":"","followerCount":"","domain":"","contact":""},"submited":false,"ranking":[]},"qyActivityData":{},"talkActivityData":{},"party2022ActivityData":{},"batchVideos":{},"contribution":{"selectedContribution":null,"campaign":null,"configs":{},"contributionLists":{},"recommendQuestions":{"isLoading":true,"paging":{"isEnd":false,"isStart":true,"totals":0},"data":[]},"questionSearchResults":{"isLoading":true,"paging":{"isEnd":false,"isStart":true,"totals":0},"data":[]}},"creationReferences":{},"zvideoCollection":{},"zvideoGrant":{},"collectData":{"isFetching":false,"list":[]},"videoSource":{"isLoaded":false}},"republish":{},"commentPermission":{},"creatorRightStatus":{"list":[]},"adPromotion":{"answer":{},"article":{}}},"fetchHost":"www.zhihu.com","subAppName":"column","spanName":"Post","canaryConfig":{"test_canary":"0","use_new_player":"1","player_vendor":"1","use_hevc":"1","upload_use_signature":"1","use_backdrop_blur":"1","article_title_imagex":"0","play_station":"1"}}</script><script crossorigin="" src="https://static.zhihu.com/heifetz/vendor.5f3e51e68d56265eb628.js"></script><script crossorigin="" src="https://static.zhihu.com/event/react@17.0.2/umd/react.production.min.js"></script><script crossorigin="" src="https://static.zhihu.com/event/react-dom@17.0.2/umd/react-dom.production.min.js"></script><script crossorigin="" src="https://static.zhihu.com/event/react-dom@17.0.2/umd/react-dom-server.browser.production.min.js"></script><script crossorigin="" src="https://static.zhihu.com/heifetz/runtime.app.560046624f28621b8b9f.js"></script><script crossorigin="" src="https://static.zhihu.com/heifetz/lib-29107295.app.a7b6d98ed785438234bf.js"></script><script crossorigin="" src="https://static.zhihu.com/heifetz/lib-79b5cf47.app.f16b5bf4c3cff85007a0.js"></script><script crossorigin="" src="https://static.zhihu.com/heifetz/lib-330004dc.app.1a4905d34b3df3f09dff.js"></script><script crossorigin="" src="https://static.zhihu.com/heifetz/lib-0e5ce61e.app.121a4e979ab55ff600b2.js"></script><script crossorigin="" src="https://static.zhihu.com/heifetz/lib-83b0f42f.app.6f9779781d0af52a0ddf.js"></script><script crossorigin="" src="https://static.zhihu.com/heifetz/lib-2ec050f6.app.c4cf2528b321f02e9fa0.js"></script><script crossorigin="" src="https://static.zhihu.com/heifetz/680.app.f3c9d9e614b550bbff65.js"></script><script crossorigin="" src="https://static.zhihu.com/heifetz/column.app.b9bcd5e5f805cd0c6068.js"></script><script defer="" src="https://static.zhihu.com/event/wza/4613/aria.js?appid=c5ddb58ead4528987249d96fb27246ab" id="ariascripts" wapforceoldfixed="false" loaddata="false" callbackexit="RQ_HALW_QDPH" callback="RQ_VWDUW_QDPH"></script><script src="https://hm.baidu.com/hm.js?98beee57fd2ef70ccdd5ca52b9740c49" async=""></script><script crossorigin="" src="https://unpkg.zhimg.com/za-js-sdk@4.13.0/dist/zap.js"></script><div><div style="display: none;"><i>想来知乎工作？请发送邮件到 jobs@zhihu.com</i></div></div><script src="https://zz.bdstatic.com/linksubmit/push.js"></script><script crossorigin="" src="https://unpkg.zhimg.com/@cfe/emoticon@1.2.4/lib/emoticon.js"></script></body></html>